

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="懂一点点">
  <meta name="author" content="Gotcha">
  <meta name="keywords" content="">
  
  <title>SpringCloud入门 - Gotcha的笔记总结</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.11","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":"cd190160b5401a029cee361d013e32a1","google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"U8yaiFQ2fUef4ujWTig83mSL-gzGzoHsz","app_key":"akCMytdeJqrMuKP84F4oblqz","server_url":"https://u8yaifq2.lc-cn-n1-shared.com"}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Gotcha的笔记总结</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/background/01.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="SpringCloud入门">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-01-25 00:00" pubdate>
        2021年1月25日 凌晨
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      11.6k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      379
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">SpringCloud入门</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：2021年1月28日 凌晨
                
              </p>
            
            <div class="markdown-body">
              <h1 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h1><h2 id="1-1-系统架构演变"><a href="#1-1-系统架构演变" class="headerlink" title="1.1 系统架构演变"></a>1.1 系统架构演变</h2><pre><code class=" mermaid">graph LR;
1[集中式架构] --&gt; 2[垂直拆分]
2 --&gt; 3[分布式服务]
3 --&gt; 4[SOA面向服务架构]
4 --&gt; 5[微服务架构]
</code></pre>




<h3 id="1-1-1-集中式架构"><a href="#1-1-1-集中式架构" class="headerlink" title="1.1.1 集中式架构"></a>1.1.1 集中式架构</h3><p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/1.1.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>优点： <ul>
<li>系统开发速度快</li>
<li>维护成本低</li>
<li>适用于并发要求较低的系统</li>
</ul>
</li>
<li>缺点： <ul>
<li>代码耦合度高，后期维护困难</li>
<li>无法针对不同模块进行针对性优化</li>
<li>无法水平扩展</li>
<li>单点容错率低，并发能力差</li>
</ul>
</li>
</ul>
<h3 id="1-1-2-垂直拆分架构"><a href="#1-1-2-垂直拆分架构" class="headerlink" title="1.1.2 垂直拆分架构"></a>1.1.2 垂直拆分架构</h3><p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/1.2.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>优点：<ul>
<li>系统拆分实现了流量分担，解决了并发问题</li>
<li>可以针对不同模块进行优化</li>
<li>方便水平扩展，负载均衡，容错率提高</li>
</ul>
</li>
<li>缺点：<ul>
<li>系统间相互独立，会有很多重复开发工作，影响开发效率</li>
</ul>
</li>
</ul>
<h3 id="1-1-3-分布式服务架构"><a href="#1-1-3-分布式服务架构" class="headerlink" title="1.1.3 分布式服务架构"></a>1.1.3 分布式服务架构</h3><p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/1.3.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>优点：<ul>
<li>将基础服务进行了抽取，系统间相互调用，提高了代码复用和开发效率</li>
</ul>
</li>
<li>缺点：<ul>
<li>系统间耦合度变高，调用关系错综复杂，难以维护</li>
</ul>
</li>
</ul>
<h3 id="1-1-4-面向服务架构（SOA）"><a href="#1-1-4-面向服务架构（SOA）" class="headerlink" title="1.1.4 面向服务架构（SOA）"></a>1.1.4 面向服务架构（SOA）</h3><p>SOA（Service Oriented Architecture）面向服务的架构：它是一种设计方法，其中包含多个服务， 服务之间通过相互依赖最终提供一系列的功能。一个服务通常以独立的形式存在与操作系统进程中。<strong>各个服务之间通过网络调用</strong>。</p>
<p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/1.4.png" srcset="/img/loading.gif" lazyload></p>
<blockquote>
<p>ESB（企业服务总线），简单来说ESB就是一根管道，用来连接各个服务节点。为了集成不同系统，不同协议的服务，<strong>ESB做了消息的转化解释和路由工作</strong>，让不同的服务互联互通。</p>
</blockquote>
<ul>
<li>缺点：<ul>
<li>每个供应商提供的ESB产品有偏差，自身实现较为复杂</li>
<li>应用服务粒度较大，ESB集成整合所有服务和协议、数据转换使得运维、测试部署困难</li>
<li>所有服务都通过一个通路通信，直接降低了通信速度</li>
</ul>
</li>
</ul>
<h3 id="1-1-5-微服务架构"><a href="#1-1-5-微服务架构" class="headerlink" title="1.1.5 微服务架构"></a>1.1.5 微服务架构</h3><p>微服务架构是使用一套小服务来开发单个应用的方式或途径，<strong>每个服务基于单一业务能力构建</strong>，运行在自己的进程中，并使用轻量级机制通信，通常是HTTP API，并能够通过自动化部署机制来独立部署。这些服务可以使用不同的编程语言实现，以及不同数据存储技术，并保持最低限度的集中式管理。</p>
<p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/1.5.png" srcset="/img/loading.gif" lazyload></p>
<blockquote>
<p>API Gateway网关是一个服务器，是系统的唯一入口。为每个客户端提供一个定制的API。API网关核心是，<strong>所有的客户端和消费端都通过统一的网关接入微服务，在网关层处理所有的非业务功能</strong>。如它还可以具有其它职责，如身份验证、监控、负载均衡、缓存、请求分片与管理、静态响应处理。通常，网关提供RESTful/HTTP的方式访问服务。而<strong>服务端通过服务注册中心进行服务注册和管理</strong>。</p>
</blockquote>
<ul>
<li>特点：<ul>
<li><strong>单一职责</strong>：微服务中每一个服务都对应唯一的业务能力，做到单一职责</li>
<li><strong>微</strong>：微服务的服务拆分粒度很小，例如一个用户管理就可以作为一个服务。每个服务虽小，但“五脏俱全”。</li>
<li><strong>面向服务</strong>：面向服务是说每个服务都要对外暴露Rest风格服务接口API，并不关心服务的技术实现，做到与平台和语言无关，也不限定用什么技术实现，只要提供Rest的接口即可。 </li>
<li><strong>自治</strong>：自治是说服务间互相独立，互不干扰<ul>
<li>团队独立：每个服务都是一个独立的开发团队，人数不能过多。</li>
<li>技术独立：因为是面向服务，提供Rest接口，使用什么技术没有别人干涉</li>
<li>前后端分离：采用前后端分离开发，提供统一Rest接口，后端不用再为PC、移动端开发不同接口</li>
<li>数据库分离：每个服务都使用自己的数据源。</li>
<li>部署独立：服务间虽然有调用，但要做到服务重启不影响其它服务。有利于持续集成和持续交付。每个服务都是独立的组件，可复用，可替换，降低耦合，易维护</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="1-2-服务调用方式"><a href="#1-2-服务调用方式" class="headerlink" title="1.2 服务调用方式"></a>1.2 服务调用方式</h2><p>常见的远程调用方式有以下2种：</p>
<ul>
<li><strong>RPC</strong>（Remote Produce Call）：远程过程调用，RPC<strong>基于Socket</strong>，<strong>工作在会话层</strong>。自定义数据格式，速度快，效率高。早期的webservice，现在热门的dubbo，都是RPC的典型代表</li>
<li><strong>Http</strong>：http其实是一种网络传输协议，基于TCP，<strong>工作在应用层</strong>，规定了数据传输的格式。现在客户端浏览器与服务端通信基本都是采用Http协议，也可以用来进行远程服务调用。缺点是消息封装臃肿，优势是对服务的提供和调用方没有任何技术限定，自由灵活，更符合微服务理念。典型代表：RESTful，Spring Cloud</li>
</ul>
<h2 id="1-3-SpringCloud简介"><a href="#1-3-SpringCloud简介" class="headerlink" title="1.3 SpringCloud简介"></a>1.3 SpringCloud简介</h2><p>Spring Cloud是Spring旗下的项目之一，官网地址：<a target="_blank" rel="noopener" href="http://projects.spring.io/spring-cloud/">http://projects.spring.io/spring-cloud/</a> </p>
<p>Spring Cloud将现在非常流行的一些技术整合到一起，实现了诸如：配置管理，服务发现，智能路由， 负载均衡，熔断器，控制总线，集群状态等功能；协调分布式环境中各个系统，为各类服务提供模板性配置。其主要涉及的组件包括：</p>
<ul>
<li>Eureka：注册中心</li>
<li>Zuul、Gateway：服务网关</li>
<li>Ribbon：负载均衡</li>
<li>Feign：服务调用</li>
<li>Hystrix或Resilience4j：熔断器</li>
</ul>
<p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/1.6.png" srcset="/img/loading.gif" lazyload></p>
<blockquote>
<p>Spring Cloud不是一个组件，而是许多组件的集合</p>
<p>它的版本命名比较特殊，是以A到Z的为首字母的一些单词（伦敦地铁站的名字）组成</p>
</blockquote>
<hr>
<h1 id="二、微服务场景模拟"><a href="#二、微服务场景模拟" class="headerlink" title="二、微服务场景模拟"></a>二、微服务场景模拟</h1><h2 id="2-1-创建父工程"><a href="#2-1-创建父工程" class="headerlink" title="2.1 创建父工程"></a>2.1 创建父工程</h2><p>创建Maven空工程springcloud-demo01，导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>top.igotcha<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>springcloud-demo01<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-comment">&lt;!--这是之后加的--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">modules</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>user-service<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>consumer-demo<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>eureka-server<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">modules</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.5.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">spring-cloud.version</span>&gt;</span>Greenwich.SR1<span class="hljs-tag">&lt;/<span class="hljs-name">spring-cloud.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">mapper.starter.version</span>&gt;</span>2.1.5<span class="hljs-tag">&lt;/<span class="hljs-name">mapper.starter.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">mysql.version</span>&gt;</span>5.1.46<span class="hljs-tag">&lt;/<span class="hljs-name">mysql.version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><span class="hljs-comment">&lt;!--对子项目通用依赖进行管理--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- springCloud --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 通用Mapper启动器 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>tk.mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mapper-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;mapper.starter.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- mysql驱动 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;mysql.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br></code></pre></td></tr></table></figure>

<hr>
<h2 id="2-2-创建用户服务工程模块"><a href="#2-2-创建用户服务工程模块" class="headerlink" title="2.2 创建用户服务工程模块"></a>2.2 创建用户服务工程模块</h2><h3 id="2-2-1-创建新module"><a href="#2-2-1-创建新module" class="headerlink" title="2.2.1 创建新module"></a>2.2.1 创建新module</h3><p>创建Maven模块，user-service</p>
<h3 id="2-2-2-导入Maven依赖"><a href="#2-2-2-导入Maven依赖" class="headerlink" title="2.2.2 导入Maven依赖"></a>2.2.2 导入Maven依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>springcloud-demo01<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>top.igotcha<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>user-service<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>tk.mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mapper-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- Eureka客户端 --&gt;</span><br>    <span class="hljs-comment">&lt;!--&lt;dependency&gt;</span><br><span class="hljs-comment">        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="hljs-comment">        &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;</span><br><span class="hljs-comment">    &lt;/dependency&gt; --&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="2-2-3-编写配置文件"><a href="#2-2-3-编写配置文件" class="headerlink" title="2.2.3 编写配置文件"></a>2.2.3 编写配置文件</h3><p>创建 user-service\src\main\resources\application.yml 文件，设置相关信息</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">9091</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/springcloud-demo01</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root01</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">root</span><br><span class="hljs-attr">mybatis:</span><br>  <span class="hljs-attr">type-aliases-package:</span> <span class="hljs-string">top.igotcha.user.pojo</span><br></code></pre></td></tr></table></figure>

<p>并新建springcloud-demo01数据库，导入SQL数据</p>
<h3 id="2-2-4-编写Bean"><a href="#2-2-4-编写Bean" class="headerlink" title="2.2.4 编写Bean"></a>2.2.4 编写Bean</h3><p>编写实体类<code>user-service\src\main\java\top\igotcha\user\pojo\User.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Table(name = &quot;tb_user&quot;)</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;<br>    <span class="hljs-meta">@Id</span><br>    <span class="hljs-meta">@KeySql(useGeneratedKeys = true)</span><br>    <span class="hljs-keyword">private</span> Long id;<br>    <span class="hljs-keyword">private</span> String userName; <span class="hljs-comment">// 用户名</span><br>    <span class="hljs-keyword">private</span> String password; <span class="hljs-comment">// 密码</span><br>    <span class="hljs-keyword">private</span> String name;<span class="hljs-comment">// 姓名</span><br>    <span class="hljs-keyword">private</span> Integer age;<span class="hljs-comment">// 年龄</span><br>    <span class="hljs-keyword">private</span> Integer sex;<span class="hljs-comment">// 性别，1男性，2女性</span><br>    <span class="hljs-keyword">private</span> Date birthday;<span class="hljs-comment">// 出生日期</span><br>    <span class="hljs-keyword">private</span> Date created;<span class="hljs-comment">// 创建时间</span><br>    <span class="hljs-keyword">private</span> Date updated;<span class="hljs-comment">// 更新时间</span><br>    <span class="hljs-keyword">private</span> String note;<span class="hljs-comment">// 备注</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-2-5-编写Mapper"><a href="#2-2-5-编写Mapper" class="headerlink" title="2.2.5 编写Mapper"></a>2.2.5 编写Mapper</h3><p>编写<code>user-service\src\main\java\top\igotcha\user\mapper\UserMapper.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Mapper</span>&lt;<span class="hljs-title">User</span>&gt; </span>&#123;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-2-6-编写Service"><a href="#2-2-6-编写Service" class="headerlink" title="2.2.6 编写Service"></a>2.2.6 编写Service</h3><p>编写<code>user-service\src\main\java\top\igotcha\user\service\UserService.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserService</span> </span>&#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserMapper userMapper;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">queryById</span><span class="hljs-params">(Long id)</span></span>&#123;<br>        <span class="hljs-keyword">return</span> userMapper.selectByPrimaryKey(id);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-2-7-编写Controller"><a href="#2-2-7-编写Controller" class="headerlink" title="2.2.7 编写Controller"></a>2.2.7 编写Controller</h3><p>编写<code>user-service\src\main\java\top\igotcha\user\controller\UserController.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/user&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserController</span> </span>&#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserService userService;<br>    <span class="hljs-meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">queryById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span></span>&#123;<br>        <span class="hljs-keyword">return</span> userService.queryById(id);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-2-8-编写启动器Application"><a href="#2-2-8-编写启动器Application" class="headerlink" title="2.2.8 编写启动器Application"></a>2.2.8 编写启动器Application</h3><p>编写<code>user-service/src/main/java/top/igotcha/user/UserApplication.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@MapperScan(&quot;top.igotcha.user.mapper&quot;)</span><br><span class="hljs-comment">//@EnableDiscoveryClient // 开启Eureka客户端发现功能</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserApplication</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(UserApplication.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-2-9-运行项目"><a href="#2-2-9-运行项目" class="headerlink" title="2.2.9 运行项目"></a>2.2.9 运行项目</h3><p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/2.1.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<h2 id="2-3-创建服务调用模块"><a href="#2-3-创建服务调用模块" class="headerlink" title="2.3 创建服务调用模块"></a>2.3 创建服务调用模块</h2><h3 id="2-3-1-创建新module"><a href="#2-3-1-创建新module" class="headerlink" title="2.3.1 创建新module"></a>2.3.1 创建新module</h3><p>创建Maven模块，consumer-demo</p>
<h3 id="2-3-2-导入Maven依赖"><a href="#2-3-2-导入Maven依赖" class="headerlink" title="2.3.2 导入Maven依赖"></a>2.3.2 导入Maven依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>springcloud-demo01<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>top.igotcha<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>consumer-demo<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="2-3-3-编写Bean"><a href="#2-3-3-编写Bean" class="headerlink" title="2.3.3 编写Bean"></a>2.3.3 编写Bean</h3><p>编写实体类<code>springcloud-demo01/consumer-demo/src/main/java/top/igtocha/consumer/pojo/User.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> Long id;<br>    <span class="hljs-keyword">private</span> String userName; <span class="hljs-comment">// 用户名</span><br>    <span class="hljs-keyword">private</span> String password; <span class="hljs-comment">// 密码</span><br>    <span class="hljs-keyword">private</span> String name;<span class="hljs-comment">// 姓名</span><br>    <span class="hljs-keyword">private</span> Integer age;<span class="hljs-comment">// 年龄</span><br>    <span class="hljs-keyword">private</span> Integer sex;<span class="hljs-comment">// 性别，1男性，2女性</span><br>    <span class="hljs-keyword">private</span> Date birthday;<span class="hljs-comment">// 出生日期</span><br>    <span class="hljs-keyword">private</span> Date created;<span class="hljs-comment">// 创建时间</span><br>    <span class="hljs-keyword">private</span> Date updated;<span class="hljs-comment">// 更新时间</span><br>    <span class="hljs-keyword">private</span> String note;<span class="hljs-comment">// 备注</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-3-4-编写Controller"><a href="#2-3-4-编写Controller" class="headerlink" title="2.3.4 编写Controller"></a>2.3.4 编写Controller</h3><p>编写<code>springcloud-demo01/consumer-demo/src/main/java/top/igtocha/consumer/controller/ConsumerController.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/consumer&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConsumerController</span> </span>&#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RestTemplate restTemplate;<br>    <span class="hljs-meta">@GetMapping(&quot;&#123;id&#125;&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">queryById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span></span>&#123;<br>        String url = <span class="hljs-string">&quot;http://localhost:9091/user/&quot;</span> + id;<br>        <span class="hljs-keyword">return</span> restTemplate.getForObject(url, User.class);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-3-5-编写启动器Application"><a href="#2-3-5-编写启动器Application" class="headerlink" title="2.3.5 编写启动器Application"></a>2.3.5 编写启动器Application</h3><p>编写<code>springcloud-demo01/consumer-demo/src/main/java/top/igtocha/consumer/ConsumerApplication.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConsumerApplication</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(ConsumerApplication.class, args);<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title">restTemplate</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> RestTemplate();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-3-6-运行项目"><a href="#2-3-6-运行项目" class="headerlink" title="2.3.6 运行项目"></a>2.3.6 运行项目</h3><p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/2.2.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<h2 id="2-4-总结"><a href="#2-4-总结" class="headerlink" title="2.4 总结"></a>2.4 总结</h2><p>以上代码实现了</p>
<ul>
<li>user-service：对外提供了查询用户的接口</li>
<li>consumer-demo：通过RestTemplate访问 <a target="_blank" rel="noopener" href="http://locahost:9091/user/%7Bid%7D">http://locahost:9091/user/{id}</a> 接口，查询用户数据</li>
</ul>
<p>存在如下问题</p>
<ul>
<li>服务管理<ul>
<li>如何自动注册和发现</li>
<li>如何实现状态监管</li>
<li>如何实现动态路由</li>
</ul>
</li>
<li>服务如何实现负载均衡</li>
<li>服务如何解决容灾问题</li>
<li>服务如何实现统一配置</li>
</ul>
<hr>
<h2 id="2-5-创建Eureka注册中心模块"><a href="#2-5-创建Eureka注册中心模块" class="headerlink" title="2.5 创建Eureka注册中心模块"></a>2.5 创建Eureka注册中心模块</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>Eureka的主要功能是进行服务管理，定期检查服务状态，返回服务地址列表。</p>
<p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/2.3.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li><p><strong>Eureka</strong>：就是服务注册中心（可以是一个集群），对外暴露自己的地址</p>
</li>
<li><p><strong>提供者</strong>：启动后向Eureka注册自己信息（地址，提供什么服务）</p>
</li>
<li><p><strong>消费者</strong>：向Eureka订阅服务，Eureka会将对应服务的所有提供者地址列表发送给消费者，并且定期更新</p>
</li>
<li><p>**心跳(续约)**：提供者定期通过http方式向Eureka刷新自己的状态</p>
</li>
</ul>
<blockquote>
<p>Eureka是服务注册中心，只做服务注册；自身并不提供服务也不消费服务。可以搭建web工程使用Eureka，可以使用Spring Boot方式搭建。</p>
</blockquote>
<h3 id="2-5-1-创建新module"><a href="#2-5-1-创建新module" class="headerlink" title="2.5.1 创建新module"></a>2.5.1 创建新module</h3><p>创建Maven模块，eureka-server</p>
<h3 id="2-5-2-导入Maven依赖"><a href="#2-5-2-导入Maven依赖" class="headerlink" title="2.5.2 导入Maven依赖"></a>2.5.2 导入Maven依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>springcloud-demo01<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>top.igotcha<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>eureka-server<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="2-5-3-编写配置文件"><a href="#2-5-3-编写配置文件" class="headerlink" title="2.5.3 编写配置文件"></a>2.5.3 编写配置文件</h3><p>创建 springcloud-demo01/eureka-server/src/main/resources/application.yml文件，设置相关信息</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">10086</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">eureka-server</span> <span class="hljs-comment"># 应用名称，会在Eureka中作为服务的id标识（serviceId）</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>   <span class="hljs-attr">service-url:</span> <span class="hljs-comment"># EurekaServer的地址，现在是自己的地址，如果是集群，需要写其它Server的地址。</span><br>     <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://127.0.0.1:10086/eureka</span><br>   <span class="hljs-attr">register-with-eureka:</span> <span class="hljs-literal">false</span> <span class="hljs-comment"># 不注册自己</span><br>   <span class="hljs-attr">fetch-registry:</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#不拉取</span><br></code></pre></td></tr></table></figure>

<h3 id="2-5-4-编写启动器Application"><a href="#2-5-4-编写启动器Application" class="headerlink" title="2.5.4 编写启动器Application"></a>2.5.4 编写启动器Application</h3><p>编写<code>springcloud-demo01/eureka-server/src/main/java/top/igotcha/EurekaServerApplication.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableEurekaServer</span><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EurekaServerApplication</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(EurekaServerApplication.class);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-5-5-运行项目"><a href="#2-5-5-运行项目" class="headerlink" title="2.5.5 运行项目"></a>2.5.5 运行项目</h3><p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/2.4.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<h2 id="2-6-服务注册与发现"><a href="#2-6-服务注册与发现" class="headerlink" title="2.6 服务注册与发现"></a>2.6 服务注册与发现</h2><h3 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h3><ul>
<li><strong>服务注册</strong>：在服务提供工程user-service上添加Eureka客户端依赖；自动将服务注册到EurekaServer服务地址列表。<ul>
<li>添加依赖；</li>
<li>改造启动引导类；添加开启Eureka客户端发现的注解；</li>
<li>修改配置文件；设置Eureka 服务地址</li>
</ul>
</li>
<li><strong>服务发现</strong>：在服务消费工程consumer-demo上添加Eureka客户端依赖；可以使用工具类根据服务名称获取对应的服务地址列表。<ul>
<li>添加依赖；</li>
<li>改造启动引导类；添加开启Eureka客户端发现的注解；</li>
<li>修改配置文件；设置Eureka 服务地址；</li>
<li>改造处理器类ConsumerController，可以使用工具类DiscoveryClient根据服务名称获取对应服务地址列表。</li>
</ul>
</li>
</ul>
<h3 id="2-6-1-服务注册"><a href="#2-6-1-服务注册" class="headerlink" title="2.6.1 服务注册"></a>2.6.1 服务注册</h3><h4 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h4><p>在user-service的pom.xml中添加Eureka客户端依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- Eureka客户端 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h4 id="修改启动类"><a href="#修改启动类" class="headerlink" title="修改启动类"></a>修改启动类</h4><p>通过添加 <code>@EnableDiscoveryClient</code> 来开启Eureka客户端功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@MapperScan(&quot;top.igotcha.user.mapper&quot;)</span><br><span class="hljs-meta">@EnableDiscoveryClient</span> <span class="hljs-comment">// 开启Eureka客户端发现功能</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserApplication</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(UserApplication.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">9091</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/springcloud-demo01</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root01</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-comment">#应用名</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">user-service</span><br><span class="hljs-attr">mybatis:</span><br>  <span class="hljs-attr">type-aliases-package:</span> <span class="hljs-string">top.igotcha.user.pojo</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">service-url:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://localhost:10086/eureka</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>这里添加了spring.application.name属性来指定应用名称，将来会作为服务的id使用。</p>
</blockquote>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>重启项目后，发现 user-service已经注册到Eureka中</p>
<p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/2.5.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p>服务提供者在启动时，会检测配置属性中的： eureka.client.register-with-erueka=true 参数是否正确，事实上，默认就是true。</p>
<p>如果值确实为true，则会向EurekaServer发起一个Rest请求，并携带自己的元数据信息，Eureka Server会把这些信息保存到一个<strong>双层Map</strong>结构中。 </p>
<ul>
<li><p>第一层Map的Key就是服务id，一般是配置中的 spring.application.name 属性</p>
</li>
<li><p>第二层Map的key是服务的实例id。一般host+ serviceId + port，例如： localhost:user-service:8081 值则是服务的实例对象，也就是说一个服务，可以同时启动多个不同实例，形成集群</p>
</li>
</ul>
<h3 id="2-6-2-服务发现"><a href="#2-6-2-服务发现" class="headerlink" title="2.6.2 服务发现"></a>2.6.2 服务发现</h3><h4 id="添加依赖-1"><a href="#添加依赖-1" class="headerlink" title="添加依赖"></a>添加依赖</h4><p>在consumer-demo的pom.xml中添加Eureka客户端依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- Eureka客户端 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h4 id="修改启动类-1"><a href="#修改启动类-1" class="headerlink" title="修改启动类"></a>修改启动类</h4><p>通过添加 <code>@EnableDiscoveryClient</code> 来开启Eureka客户端功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableDiscoveryClient</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConsumerApplication</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(ConsumerApplication.class, args);<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title">restTemplate</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> RestTemplate();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="新增配置文件"><a href="#新增配置文件" class="headerlink" title="新增配置文件"></a>新增配置文件</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">consumer-demo</span> <span class="hljs-comment"># 应用名称</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>   <span class="hljs-attr">service-url:</span> <span class="hljs-comment"># EurekaServer地址</span><br>     <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://127.0.0.1:10086/eureka</span><br></code></pre></td></tr></table></figure>

<hr>
<h2 id="2-7-Eureka高可用配置"><a href="#2-7-Eureka高可用配置" class="headerlink" title="2.7 Eureka高可用配置"></a>2.7 Eureka高可用配置</h2><h3 id="概述-2"><a href="#概述-2" class="headerlink" title="概述"></a>概述</h3><p>Eureka架构中的三个核心角色：</p>
<ul>
<li><p><strong>服务注册中心</strong></p>
<p>Eureka的服务端应用，提供服务注册和发现功能。（就是eureka-server）</p>
</li>
<li><p><strong>服务提供者</strong> </p>
<p>提供服务的应用，可以是SpringBoot应用，也可以是其它任意技术实现，只要对外提供的是Rest风格服务即可。（就是user-service）</p>
</li>
<li><p><strong>服务消费者</strong></p>
<p>消费应用从注册中心获取服务列表，从而得知每个服务方的信息，知道去哪里调用服务方。（就是consumer-demo）</p>
</li>
</ul>
<blockquote>
<p>事实上EurekaServer也可以是一 个集群，形成高可用的Eureka中心。</p>
<p>多个Eureka Server之间也会<strong>互相注册</strong>为服务，当服务提供者注册到Eureka Server集群中的某个节点时，该节点会把服务的信息同步给集群中的每个节点，从而实现数据同步。因此，无论客户端访问到Eureka Server集群中的任意一 个节点，都可以获取到完整的服务列表信息。</p>
<p><strong>作为客户端，需要把信息注册到每个Eureka中</strong></p>
</blockquote>
<p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/2.6.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="2-7-1-修改Eureka配置"><a href="#2-7-1-修改Eureka配置" class="headerlink" title="2.7.1 修改Eureka配置"></a>2.7.1 修改Eureka配置</h3><p>新建一个分支，方便之后切换回单机模式</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-string">$&#123;port:10086&#125;</span> <span class="hljs-comment">#读取启动项目时设置的port值，默认为10086</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">eureka-server</span> <span class="hljs-comment"># 应用名称，会在Eureka中作为服务的id标识（serviceId）</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>   <span class="hljs-attr">service-url:</span> <span class="hljs-comment"># EurekaServer的地址，如果是集群，需要写其它Server的地址。</span><br>     <span class="hljs-comment">#defaultZone: http://127.0.0.1:10086/eureka</span><br>     <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">$&#123;defaultZone:http://127.0.0.1:10086/eureka&#125;</span><br>   <span class="hljs-attr">register-with-eureka:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 注册自己</span><br>   <span class="hljs-attr">fetch-registry:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#拉取</span><br></code></pre></td></tr></table></figure>

<p>所谓的高可用注册中心，就是<strong>把EurekaServer自己也作为一个服务，注册到其它EurekaServer上，这样多个 EurekaServer之间就能互相发现对方，从而形成集群</strong>。</p>
<blockquote>
<p>在上述配置文件中的${}表示在jvm启动时候若能找到对应port或者defaultZone参数则使用，若无则使用后面的默认值</p>
</blockquote>
<h3 id="2-7-2-修改Run-Configurations"><a href="#2-7-2-修改Run-Configurations" class="headerlink" title="2.7.2 修改Run Configurations"></a>2.7.2 修改Run Configurations</h3><p>修改原来的启动配置组件；在VM options 中 设置<code>-Dport=10087 -DdefaultZone=http:127.0.0.1:10086/eureka</code>，并复制一份设置<code>-Dport=10087 -DdefaultZone=http:127.0.0.1:10086/eureka</code></p>
<p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/2.7.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="2-7-3-修改user-service配置"><a href="#2-7-3-修改user-service配置" class="headerlink" title="2.7.3 修改user-service配置"></a>2.7.3 修改user-service配置</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">9091</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/springcloud-demo01</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root01</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-comment">#应用名</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">user-service</span><br><span class="hljs-attr">mybatis:</span><br>  <span class="hljs-attr">type-aliases-package:</span> <span class="hljs-string">top.igotcha.user.pojo</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">service-url:</span> <span class="hljs-comment"># EurekaServer地址,多个地址以逗号隔开</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://127.0.0.1:10086/eureka,http://127.0.0.1:10087/eureka</span><br></code></pre></td></tr></table></figure>

<h3 id="2-7-4-修改consumer-demo配置"><a href="#2-7-4-修改consumer-demo配置" class="headerlink" title="2.7.4 修改consumer-demo配置"></a>2.7.4 修改consumer-demo配置</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">consumer-demo</span> <span class="hljs-comment"># 应用名称</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>   <span class="hljs-attr">service-url:</span> <span class="hljs-comment"># EurekaServer地址,多个地址以逗号隔开</span><br>     <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://127.0.0.1:10086/eureka,http://127.0.0.1:10087/eureka</span><br></code></pre></td></tr></table></figure>

<h3 id="2-7-5-运行项目"><a href="#2-7-5-运行项目" class="headerlink" title="2.7.5 运行项目"></a>2.7.5 运行项目</h3><p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/2.8.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<h2 id="2-8-Eureka客户端与服务端配置"><a href="#2-8-Eureka客户端与服务端配置" class="headerlink" title="2.8 Eureka客户端与服务端配置"></a>2.8 Eureka客户端与服务端配置</h2><h3 id="概述-3"><a href="#概述-3" class="headerlink" title="概述"></a>概述</h3><p>主要对如下部分进行配置</p>
<ul>
<li>Eureka客户端工程<ul>
<li>user-service 服务提供<ul>
<li>服务地址使用ip方式</li>
<li>续约</li>
</ul>
</li>
<li>consumer-demo 服务消费<ul>
<li>获取服务地址的频率</li>
</ul>
</li>
</ul>
</li>
<li>Eureka服务端工程 eureka-server<ul>
<li>失效剔除</li>
<li>自我保护</li>
</ul>
</li>
</ul>
<h3 id="客户端服务者配置"><a href="#客户端服务者配置" class="headerlink" title="客户端服务者配置"></a>客户端服务者配置</h3><p>默认注册时使用的是主机名或者localhost，如果想用ip进行注册，可以在 user-service 中添加配置如下：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">instance:</span><br>    <span class="hljs-attr">ip-address:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> <span class="hljs-comment"># ip地址</span><br>    <span class="hljs-attr">prefer-ip-address:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 更倾向于使用ip，而不是host名</span><br>    <span class="hljs-attr">lease-expiration-duration-in-seconds:</span> <span class="hljs-number">90</span> <span class="hljs-comment">#服务失效时间，默认值90秒</span><br>    <span class="hljs-attr">lease-renewal-interval-in-seconds:</span> <span class="hljs-number">30</span> <span class="hljs-comment">#服务续约(renew)的间隔，默认为30秒</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>默认情况下每隔30秒服务会向注册中心发送一次心跳，证明自己还活着。如果超过90秒没有发送心跳， EurekaServer就会认为该服务宕机，会定时（eureka.server.eviction-interval-timer-in-ms设定的时间）从服务列表中移除，这两个值在生产环境不要修改，默认即可。</p>
</blockquote>
<h3 id="客户端消费者配置"><a href="#客户端消费者配置" class="headerlink" title="客户端消费者配置"></a>客户端消费者配置</h3><p>当消费者启动时，会检测 <code>eureka.client.fetch-registry=true </code>参数的值，如果为true，则会从Eureka Server服务的列表拉取只读备份，然后缓存在本地。并且每隔30秒会重新拉取并更新数据。可以在 consumer-demo 项目中通过下面的参数来修改：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>   <span class="hljs-attr">registry-fetch-interval-seconds:</span> <span class="hljs-number">30</span> <span class="hljs-comment">#消费者启动时，会从EurekaServer服务的列表拉取只读备份，然后缓存在本地。并且每隔30秒会重新拉取并更新数据。</span><br></code></pre></td></tr></table></figure>

<h3 id="服务端配置"><a href="#服务端配置" class="headerlink" title="服务端配置"></a>服务端配置</h3><h4 id="服务下线"><a href="#服务下线" class="headerlink" title="服务下线"></a>服务下线</h4><p>当服务进行正常关闭操作时，它会触发一个服务下线的REST请求给Eureka Server，告诉服务注册中心：“我要下线 了”。服务中心接受到请求之后，将该服务置为下线状态。</p>
<h4 id="失效剔除"><a href="#失效剔除" class="headerlink" title="失效剔除"></a>失效剔除</h4><p>有时服务由于内存溢出或网络故障等原因使得服务不能正常的工作，而服务注册中心并未收到“服务下线”的请求。相对于服务提供者的“服务续约”操作，服务注册中心在启动时会创建一个定时任务，默认每隔一段时间 （默认为60秒）将当前清单中超时（默认为90秒）没有续约的服务剔除，这个操作被称为失<strong>效剔除</strong>。 可以通过 <code>eureka.server.eviction-interval-timer-in-ms</code> 参数对其进行修改，单位是毫秒。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">server:</span><br>    <span class="hljs-string">eviction-interval-timer-in-ms`:</span> <span class="hljs-number">60000</span> <span class="hljs-comment">#服务失效剔除时间间隔，默认60秒</span><br></code></pre></td></tr></table></figure>



<h4 id="自我保护"><a href="#自我保护" class="headerlink" title="自我保护"></a>自我保护</h4><p>关停一个服务时，很可能会在Eureka面板看到一条警告：</p>
<p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/2.9.png" srcset="/img/loading.gif" lazyload></p>
<p>这是因为触发了Eureka的自我保护机制。当服务未按时进行心跳续约时，Eureka会统计服务实例最近15分钟心跳续约的比例是否低于了85%。</p>
<p>在生产环境下，因为网络延迟等原因，心跳失败实例的比例很有可能超标，但是此时就把服务剔除列表并不妥当，因为服务可能没有宕机。打开自我保护后，Eureka在这段时间内不会剔除任何服务实例，直到网络恢复正常。生产环境下这很有效，保证了大多数服务依然可用，不过也有可能获取到失败的服务实例，因此服务调用者必须做好服务的失败容错。 可以通过下面的配置来关停自我保护：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">server:</span><br>    <span class="hljs-attr">enable-self-preservation:</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#关闭自我保护模式（缺省为打开）</span><br></code></pre></td></tr></table></figure>

<hr>
<h2 id="2-9-Ribbon负载均衡配置"><a href="#2-9-Ribbon负载均衡配置" class="headerlink" title="2.9 Ribbon负载均衡配置"></a>2.9 Ribbon负载均衡配置</h2><h3 id="概述-4"><a href="#概述-4" class="headerlink" title="概述"></a>概述</h3><p>Ribbon是Netflix发布的<strong>负载均衡器</strong>，它有助于控制HTTP和TCP客户端的行为。为Ribbon 配置服务提供者地址列表后，Ribbon就可基于某种负载均衡算法，自动地帮助服务消费者去请求。Ribbon默认为提供了很多的负载均衡算法，例如轮询、随机等。当然，也可为Ribbon实现自定义的负载均衡算法。</p>
<h3 id="2-9-1-启动两个user-service实例"><a href="#2-9-1-启动两个user-service实例" class="headerlink" title="2.9.1 启动两个user-service实例"></a>2.9.1 启动两个user-service实例</h3><p>将user-service中配置文件中端口号修改</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-string">$&#123;port:9091&#125;</span><br></code></pre></td></tr></table></figure>

<p>在VM options 中 设置<code>-Dport=9091</code>，并复制一份设置<code>-Dport=9092</code></p>
<p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/2.10.png" srcset="/img/loading.gif" lazyload></p>
<p>将两个实例启动后，可以在Eureka中看到</p>
<p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/2.11.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="2-9-2-开启负载均衡"><a href="#2-9-2-开启负载均衡" class="headerlink" title="2.9.2 开启负载均衡"></a>2.9.2 开启负载均衡</h3><p>因为Eureka中已经集成了Ribbon，所以我们无需引入新的依赖。 直接修改<code>springcloud-demo01/consumer-demo/src/main/java/top/igtocha/consumer/ConsumerApplication.java</code>，在<code>RestTemplate</code>的配置方法上添加 <code>@LoadBalanced</code> 注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableDiscoveryClient</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConsumerApplication</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(ConsumerApplication.class, args);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@LoadBalanced</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title">restTemplate</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> RestTemplate();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-9-3-修改Controller"><a href="#2-9-3-修改Controller" class="headerlink" title="2.9.3 修改Controller"></a>2.9.3 修改Controller</h3><p>修改<code>springcloud-demo01/consumer-demo/src/main/java/top/igtocha/consumer/controller/ConsumerController.java</code>调用方式，不再手动获取ip和端口，而是直接通过服务名称调用；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/consumer&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConsumerController</span> </span>&#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RestTemplate restTemplate;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> DiscoveryClient discoveryClient;<br><br><span class="hljs-comment">/*    @GetMapping(&quot;&#123;id&#125;&quot;)</span><br><span class="hljs-comment">    public User queryById(@PathVariable Long id)&#123;</span><br><span class="hljs-comment">        String url = &quot;http://localhost:9091/user/&quot; + id;</span><br><span class="hljs-comment">        return restTemplate.getForObject(url, User.class);</span><br><span class="hljs-comment">    &#125;*/</span><br><br>    <span class="hljs-meta">@GetMapping(&quot;&#123;id&#125;&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">queryById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span></span>&#123;<br>        <span class="hljs-comment">//获取eureka中注册的user-service实例列表</span><br>        <span class="hljs-comment">//List&lt;ServiceInstance&gt; serviceInstanceList = discoveryClient.getInstances(&quot;user-service&quot;);</span><br>        <span class="hljs-comment">//ServiceInstance serviceInstance = serviceInstanceList.get(0);</span><br>        <span class="hljs-comment">//String url = &quot;http://&quot; + serviceInstance.getHost() + &quot;:&quot; + serviceInstance.getPort() + &quot;/user/&quot; + id;</span><br>        <span class="hljs-comment">//return restTemplate.getForObject(url, User.class);</span><br>        <span class="hljs-comment">//调用方式，不再手动获取ip和端口，而是直接通过服务名称调用；</span><br>        String url = <span class="hljs-string">&quot;http://user-service/user/&quot;</span> + id;<br>        User user = restTemplate.getForObject(url, User.class);<br>        <span class="hljs-keyword">return</span> user;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-9-4-运行项目"><a href="#2-9-4-运行项目" class="headerlink" title="2.9.4 运行项目"></a>2.9.4 运行项目</h3><p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/2.12.png" srcset="/img/loading.gif" lazyload></p>
<blockquote>
<p>Ribbon默认的负载均衡策略是轮询。SpringBoot提供了修改负载均衡规则的配置入口，在consumerdemo的配置文件中添加如下，就变成随机的了：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">user-service:</span><br>  <span class="hljs-attr">ribbon:</span><br>    <span class="hljs-attr">NFLoadBalancerRuleClassName:</span> <span class="hljs-string">com.netflix.loadbalancer.RandomRule</span><br></code></pre></td></tr></table></figure>

<p>格式是： <code>&#123;服务名称&#125;.ribbon.NFLoadBalancerRuleClassName</code></p>
</blockquote>
<hr>
<h2 id="2-10-Hystrix熔断器配置"><a href="#2-10-Hystrix熔断器配置" class="headerlink" title="2.10 Hystrix熔断器配置"></a>2.10 Hystrix熔断器配置</h2><h3 id="概述-5"><a href="#概述-5" class="headerlink" title="概述"></a>概述</h3><p>Hystrix是Netflix开源的一个延迟和容错库，<strong>用于隔离访问远程服务、第三方库，防止出现级联失败。</strong></p>
<h4 id="雪崩问题"><a href="#雪崩问题" class="headerlink" title="雪崩问题"></a>雪崩问题</h4><p>微服务中，服务间调用关系错综复杂，一个请求，可能需要调用多个微服务接口才能实现，会形成非常复杂的调用链路。当某个服务发生异常时，会造成请求阻塞，用户的请求得到不到响应，则tomcat的这个线程不会释放，于是越来越多的用户请求到来，越来越多的线程会阻塞。</p>
<p>服务器支持的线程和并发数有限，请求一直阻塞，会<strong>导致服务器资源耗尽，从而导致所有其它服务都不可用</strong>，形成雪崩效应。</p>
<p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/2.13.png" srcset="/img/loading.gif" lazyload></p>
<p>Hystrix解决雪崩问题的手段主要是<strong>服务降级</strong>，包括： </p>
<ul>
<li><strong>线程隔离</strong></li>
<li><strong>服务熔断</strong></li>
</ul>
<h4 id="线程隔离"><a href="#线程隔离" class="headerlink" title="线程隔离"></a>线程隔离</h4><ul>
<li><p>Hystrix为每个依赖服务调用分配一个小的线程池，<strong>如果线程池已满调用将被立即拒绝，默认不采用排队，加速失败判定时间</strong>。</p>
</li>
<li><p>用户的请求将不再直接访问服务，而是通过线程池中的空闲线程来访问服务，<strong>如果线程池已满，或者请求超时，则会进行降级处理</strong>；</p>
<blockquote>
<p>服务降级：优先保证核心服务，而非核心服务不可用或弱可用。</p>
</blockquote>
</li>
<li><p>服务降级<strong>虽然会导致请求失败，但是不会导致阻塞</strong>，而且最多会影响这个依赖服务对应的线程池中的资源，对其它服务没有影响。</p>
</li>
</ul>
<p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/2.14.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="2-10-1-引入依赖"><a href="#2-10-1-引入依赖" class="headerlink" title="2.10.1 引入依赖"></a>2.10.1 引入依赖</h3><p>在<code>consumer-demo</code>消费端系统的pom.xml文件添加如下依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--Hystrix熔断器--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="2-10-2-开启熔断"><a href="#2-10-2-开启熔断" class="headerlink" title="2.10.2 开启熔断"></a>2.10.2 开启熔断</h3><p>在启动类ConsumerApplication上添加注解：<code>@EnableCircuitBreaker</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//如下三个可以合并为@SpringCloudApplication</span><br><span class="hljs-comment">//@SpringBootApplication</span><br><span class="hljs-comment">//@EnableDiscoveryClient</span><br><span class="hljs-comment">//@EnableCircuitBreaker</span><br><span class="hljs-meta">@SpringCloudApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConsumerApplication</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(ConsumerApplication.class, args);<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@LoadBalanced</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title">restTemplate</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> RestTemplate();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>在微服务中，经常会引入上面的三个注解，于是Spring就提供了一个组合注 解：@SpringCloudApplication</p>
</blockquote>
<p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/2.15.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="2-10-3-编写降级逻辑"><a href="#2-10-3-编写降级逻辑" class="headerlink" title="2.10.3 编写降级逻辑"></a>2.10.3 编写降级逻辑</h3><p>改造<code>springcloud-demo01/consumer-demo/src/main/java/top/igtocha/consumer/controller/ConsumerController.java</code>处理器类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/consumer&quot;)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-comment">//发生熔断时默认的回调函数</span><br><span class="hljs-meta">@DefaultProperties(defaultFallback = &quot;defaultFallback&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConsumerController</span> </span>&#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RestTemplate restTemplate;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> DiscoveryClient discoveryClient;<br><br>    <span class="hljs-meta">@GetMapping(&quot;&#123;id&#125;&quot;)</span><br>    <span class="hljs-comment">//发生熔断时的回调函数，当括号内容为空时，使用类中默认的</span><br>    <span class="hljs-meta">@HystrixCommand(fallbackMethod = &quot;queryByIdFallback&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">queryById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span></span>&#123;<br>        String url = <span class="hljs-string">&quot;http://user-service/user/&quot;</span> + id;<br>        <span class="hljs-keyword">return</span> restTemplate.getForObject(url, User.class).toString();<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">queryByIdFallback</span><span class="hljs-params">(Long id)</span></span>&#123;<br>        log.error(<span class="hljs-string">&quot;查询用户信息失败。id：&#123;&#125;&quot;</span>, id);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;对不起，网络太拥挤了！&quot;</span>;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">defaultFallback</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;默认提示：对不起，网络太拥挤了！&quot;</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>因为熔断的降级逻辑方法必须跟正常逻辑方法保证：<strong>相同的参数列表和返回值声明</strong>。</li>
<li>@HystrixCommand(fallbackMethod = “queryByIdFallBack”)：用来声明一个降级逻辑的方法</li>
</ul>
</blockquote>
<h3 id="2-10-4-超时设置与熔断设置"><a href="#2-10-4-超时设置与熔断设置" class="headerlink" title="2.10.4 超时设置与熔断设置"></a>2.10.4 超时设置与熔断设置</h3><p>Hystrix的默认超时时长为1秒，可以通过配置修改这个值</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">hystrix:</span><br>  <span class="hljs-attr">command:</span><br>    <span class="hljs-attr">default:</span><br>      <span class="hljs-attr">execution:</span><br>        <span class="hljs-attr">isolation:</span><br>          <span class="hljs-attr">thread:</span><br>            <span class="hljs-attr">timeoutInMilliseconds:</span> <span class="hljs-number">2000</span> <span class="hljs-comment">#超时熔断，默认1秒</span><br>      <span class="hljs-attr">circuitBreaker:</span><br>        <span class="hljs-attr">errorThresholdPercentage:</span> <span class="hljs-number">50</span> <span class="hljs-comment"># 触发熔断错误比例阈值，默认值50%</span><br>        <span class="hljs-attr">sleepWindowInMilliseconds:</span> <span class="hljs-number">10000</span> <span class="hljs-comment"># 熔断后休眠时长，默认值5秒</span><br>        <span class="hljs-attr">requestVolumeThreshold:</span> <span class="hljs-number">10</span> <span class="hljs-comment"># 熔断触发最小请求次数，默认值是20</span><br></code></pre></td></tr></table></figure>

<h3 id="2-10-5-运行项目"><a href="#2-10-5-运行项目" class="headerlink" title="2.10.5 运行项目"></a>2.10.5 运行项目</h3><p>触发熔断后的返回与控制台结果</p>
<p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/2.16.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="2-10-5-原理"><a href="#2-10-5-原理" class="headerlink" title="2.10.5 原理"></a>2.10.5 原理</h3><p>Hystrix的服务熔断机制，可以实现<strong>弹性容错</strong>；当服务请求情况好转之后，可以自动重连。通过断路的方式，将后续请求直接拒绝，一段时间（默认5秒）之后允许部分请求通过，如果调用成功则回到断路器关闭状态，否则继续打开，拒绝请求的服务。</p>
<p>Hystrix的熔断状态机模型：</p>
<p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/2.17.png" srcset="/img/loading.gif" lazyload></p>
<p>状态机有3个状态：</p>
<ul>
<li>Closed：关闭状态（断路器关闭），所有请求都正常访问。</li>
<li>Open：打开状态（断路器打开），所有请求都会被降级。Hystrix会对请求情况计数，当一定时间内失败请求百分比达到阈值，则触发熔断，断路器会完全打开。默认失败比例的阈值是50%，请求次数最少不低于20次。</li>
<li>Half Open：半开状态，不是永久的，断路器打开后会进入休眠时间（默认是5S）。随后断路器会自动进入半开状态。此时会释放部分请求通过，若这些请求都是健康的，则会关闭断路器，否则继续保持打开，再次进行休眠计时</li>
</ul>
<hr>
<h2 id="2-11-Feign远程调用配置"><a href="#2-11-Feign远程调用配置" class="headerlink" title="2.11 Feign远程调用配置"></a>2.11 Feign远程调用配置</h2><h3 id="概述-6"><a href="#概述-6" class="headerlink" title="概述"></a>概述</h3><p>Feign远程调用，核心就是通过一系列的封装和处理，将以JAVA注解的方式定义的远程调用API接口，最终转换成HTTP的请求形式，然后将HTTP的请求的响应结果，解码成JAVA Bean，放回给调用者。Feign远程调用的基本流程，大致如下图所示。</p>
<p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/2.18.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="2-11-1-引入依赖"><a href="#2-11-1-引入依赖" class="headerlink" title="2.11.1 引入依赖"></a>2.11.1 引入依赖</h3><p>在<code>consumer-demo</code>消费端系统的pom.xml文件添加如下依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--feign--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="2-11-2-编写Feign客户端"><a href="#2-11-2-编写Feign客户端" class="headerlink" title="2.11.2 编写Feign客户端"></a>2.11.2 编写Feign客户端</h3><p>在<code>consumer-demo</code>中编写如下Feign客户端接口类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(&quot;user-service&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserClient</span> </span>&#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/user/&#123;id&#125;&quot;)</span><br>    <span class="hljs-function">User <span class="hljs-title">queryById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><p>这是一个接口，<strong>Feign会通过动态代理，生成实现类</strong>。（这点跟mybatis的mapper很像） </p>
</li>
<li><p><code>@FeignClient </code>，声明这是一个Feign客户端，同时通过 value 属性指定服务名称</p>
</li>
<li><p>接口中的定义方法，完全采用SpringMVC的注解，Feign会根据注解生成URL，并访问获取结果</p>
</li>
</ul>
<h3 id="2-11-3-编写控制器"><a href="#2-11-3-编写控制器" class="headerlink" title="2.11.3 编写控制器"></a>2.11.3 编写控制器</h3><p>编写新的控制器类<code>ConsumerFeignController</code>，使用UserClient访问：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/cf&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConsumerFeignController</span> </span>&#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserClient userClient;<br>    <span class="hljs-meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">queryById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span></span>&#123;<br>        <span class="hljs-keyword">return</span> userClient.queryById(id);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-11-4-修改启动器"><a href="#2-11-4-修改启动器" class="headerlink" title="2.11.4 修改启动器"></a>2.11.4 修改启动器</h3><p>在<code>ConsumerApplication</code>启动类上，添加注解，开启Feign功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringCloudApplication</span><br><span class="hljs-comment">//开启Feign功能</span><br><span class="hljs-meta">@EnableFeignClients</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConsumerApplication</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(ConsumerApplication.class, args);<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@LoadBalanced</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title">restTemplate</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> RestTemplate();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>Feign中已经自动集成了Ribbon负载均衡，因此不需要自己定义RestTemplate进行负载均衡的配置</p>
</blockquote>
<p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/2.21.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="2-11-5-内置负载均衡配置"><a href="#2-11-5-内置负载均衡配置" class="headerlink" title="2.11.5 内置负载均衡配置"></a>2.11.5 内置负载均衡配置</h3><p>Feign中本身已经集成了Ribbon依赖和自动配置，因此不需要自己定义RestTemplate进行负载均衡的配置</p>
<p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/2.20.png" srcset="/img/loading.gif" lazyload></p>
<p>Fegin内置的ribbon默认设置了请求超时时长，默认是1000，可以通过手动配置来修改这个超时时长，因为ribbon内部有重试机制，一旦超时，会自动重新发起请求。如果不希望重试，可以添加配置：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">ribbon:</span><br>  <span class="hljs-attr">ConnectTimeout:</span> <span class="hljs-number">1000</span> <span class="hljs-comment"># 连接超时时长</span><br>  <span class="hljs-attr">ReadTimeout:</span> <span class="hljs-number">2000</span> <span class="hljs-comment"># 数据通信超时时长</span><br>  <span class="hljs-attr">MaxAutoRetries:</span> <span class="hljs-number">0</span> <span class="hljs-comment"># 当前服务器的重试次数</span><br>  <span class="hljs-attr">MaxAutoRetriesNextServer:</span> <span class="hljs-number">0</span> <span class="hljs-comment"># 重试多少次服务</span><br>  <span class="hljs-attr">OkToRetryOnAllOperations:</span> <span class="hljs-literal">false</span> <span class="hljs-comment"># 是否对所有的请求方式都重试</span><br></code></pre></td></tr></table></figure>

<h3 id="2-11-6-内置Hystrix熔断器配置"><a href="#2-11-6-内置Hystrix熔断器配置" class="headerlink" title="2.11.6 内置Hystrix熔断器配置"></a>2.11.6 内置Hystrix熔断器配置</h3><p>Feign默认也有对Hystrix的集成：</p>
<p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/2.21.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="开启熔断器"><a href="#开启熔断器" class="headerlink" title="开启熔断器"></a>开启熔断器</h4><p>默认情况下熔断器是关闭的。需要在<code>consumer-demo\src\main\resources\application.yml</code>添加如下配置：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">hystrix:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 开启Feign内置的熔断功能</span><br></code></pre></td></tr></table></figure>

<h4 id="定义fallback处理类"><a href="#定义fallback处理类" class="headerlink" title="定义fallback处理类"></a>定义fallback处理类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserClientFallback</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserClient</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">queryById</span><span class="hljs-params">(Long id)</span> </span>&#123;<br>        User user = <span class="hljs-keyword">new</span> User();<br>        user.setId(id);<br>        user.setName(<span class="hljs-string">&quot;用户异常&quot;</span>);<br>        <span class="hljs-keyword">return</span> user;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="在UserFeignClient中，指定刚才编写的实现类"><a href="#在UserFeignClient中，指定刚才编写的实现类" class="headerlink" title="在UserFeignClient中，指定刚才编写的实现类"></a>在UserFeignClient中，指定刚才编写的实现类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(value = &quot;user-service&quot;,fallback = UserClientFallback.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserClient</span> </span>&#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/user/&#123;id&#125;&quot;)</span><br>    <span class="hljs-function">User <span class="hljs-title">queryById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="运行项目"><a href="#运行项目" class="headerlink" title="运行项目"></a>运行项目</h4><p>重启<code>consumer-demo </code>并关闭 <code>user-service</code> 服务，模拟故障发生</p>
<p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/2.22.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="2-11-7-请求压缩配置"><a href="#2-11-7-请求压缩配置" class="headerlink" title="2.11.7 请求压缩配置"></a>2.11.7 请求压缩配置</h3><p>Spring Cloud Feign 支持对请求和响应进行GZIP压缩，以减少通信过程中的性能损耗。同时，也可以对请求的数据类型，以及触发压缩的大小下限进行设置：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">hystrix:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 开启Feign内置的熔断功能</span><br>  <span class="hljs-attr">compression:</span><br>    <span class="hljs-attr">request:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 开启请求压缩</span><br>      <span class="hljs-attr">mime-types:</span> <span class="hljs-string">text/html,application/xml,application/json</span> <span class="hljs-comment"># 设置压缩的数据类型</span><br>      <span class="hljs-attr">min-request-size:</span> <span class="hljs-number">2048</span> <span class="hljs-comment"># 设置触发压缩的大小下限</span><br>    <span class="hljs-attr">response:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>  <br></code></pre></td></tr></table></figure>



<h3 id="2-11-8-日志配置"><a href="#2-11-8-日志配置" class="headerlink" title="2.11.8 日志配置"></a>2.11.8 日志配置</h3><p>通过<code>logging.level.xx=debug</code>来设置的日志级别。对Fegin客户端不会产生效果。因为<code>@FeignClient</code>注解修改的客户端在被代理时，都会创建一个新的Fegin.Logger实例。需要额外指定这个日志的级别才可以。</p>
<h4 id="设置统一日志级别"><a href="#设置统一日志级别" class="headerlink" title="设置统一日志级别"></a>设置统一日志级别</h4><p>修改<code>consumer-demo\src\main\resources\application.yml</code>，添加如下配置：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">logging:</span><br>  <span class="hljs-attr">level:</span><br>    <span class="hljs-attr">top.igotcha:</span> <span class="hljs-string">debug</span><br></code></pre></td></tr></table></figure>

<h4 id="编写FeignConfig配置类"><a href="#编写FeignConfig配置类" class="headerlink" title="编写FeignConfig配置类"></a>编写FeignConfig配置类</h4><p>在<code>consumer-demo</code>编写<code>FeignConfig</code>配置类，定义日志级别</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FeignConfig</span> </span>&#123;<br>    <span class="hljs-meta">@Bean</span><br>    Logger.<span class="hljs-function">Level <span class="hljs-title">feignLoggerLevel</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-comment">//记录所有请求和响应的明细，包括头信息、请求体、元数据</span><br>        <span class="hljs-keyword">return</span> Logger.Level.FULL;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>这里指定的Level级别是FULL，Feign支持4种级别：</p>
<ul>
<li>NONE：不记录任何日志信息，这是默认值。</li>
<li>BASIC：仅记录请求的方法，URL以及响应状态码和执行时间</li>
<li>HEADERS：在BASIC的基础上，额外记录了请求和响应的头信息</li>
<li>FULL：记录所有请求和响应的明细，包括头信息、请求体、元数据。</li>
</ul>
</blockquote>
<h4 id="在接口类上指定配置类"><a href="#在接口类上指定配置类" class="headerlink" title="在接口类上指定配置类"></a>在接口类上指定配置类</h4><p>在<code>consumer-demo</code>的<code>UserClient</code>接口类上的@FeignClient注解中指定配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(value = &quot;user-service&quot;,fallback = UserClientFallback.class,configuration = FeignConfig.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserClient</span> </span>&#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/user/&#123;id&#125;&quot;)</span><br>    <span class="hljs-function">User <span class="hljs-title">queryById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="运行项目-1"><a href="#运行项目-1" class="headerlink" title="运行项目"></a>运行项目</h4><p>以debug模式重启<code>consumer-demo</code>，查看控制台</p>
<p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/2.23.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<h1 id="三、-Spring-Cloud-Gateway网关"><a href="#三、-Spring-Cloud-Gateway网关" class="headerlink" title="三、 Spring Cloud Gateway网关"></a>三、 Spring Cloud Gateway网关</h1><h2 id="3-1-概述"><a href="#3-1-概述" class="headerlink" title="3.1 概述"></a>3.1 概述</h2><ul>
<li><p>Spring Cloud Gateway基于<strong>Filter</strong>链提供网关基本功能：安全、监控／埋点、限流等。 </p>
</li>
<li><p>Spring Cloud Gateway组件的核心是一系列的过滤器，通过这些过滤器可以将客户端发送的请求转发（路由）到对应的微服务。 Spring Cloud Gateway是加在整个微服务最前沿的防火墙和代理器，<strong>隐藏微服务结点IP端口信息</strong>，从而加强安全保护。<strong>Spring Cloud Gateway本身也是一个微服务，需要注册到Eureka服务注册中心</strong>。</p>
</li>
</ul>
<p>网关的核心功能是：<strong>过滤</strong>和<strong>路由</strong></p>
<p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/3.1.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>不管是来自于客户端（PC或移动端）的请求，还是服务内部调用。一切对服务的请求都可经过网关，然后再由网关来实现 鉴权、动态路由等等操作。Gateway就是服务的统一入口。</li>
</ul>
<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><ul>
<li><strong>路由（route）</strong> 路由信息的组成：由一个ID、一个目的URL、一组断言工厂、一组Filter组成。如果路由断言为真，说明请求URL和配置路由匹配。 </li>
<li><strong>断言（Predicate）</strong> Spring Cloud Gateway中的断言函数输入类型是Spring 5.0框架中的 ServerWebExchange。Spring Cloud Gateway的断言函数允许开发者去定义匹配来自于Http Request中的任何信息比如请求头和参数。</li>
<li><strong>过滤器（Filter）</strong> 一个标准的Spring WebFilter。 Spring Cloud Gateway中的Filter分为两种类型的Filter，分别 是Gateway Filter和Global Filter。过滤器Filter将会对请求和响应进行修改处理</li>
</ul>
<h2 id="3-2-配置网关模块"><a href="#3-2-配置网关模块" class="headerlink" title="3.2 配置网关模块"></a>3.2 配置网关模块</h2><h3 id="创建新module"><a href="#创建新module" class="headerlink" title="创建新module"></a>创建新module</h3><p>创建Maven模块，gateway</p>
<h3 id="导入Maven依赖"><a href="#导入Maven依赖" class="headerlink" title="导入Maven依赖"></a>导入Maven依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>springcloud-demo01<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>top.igotcha<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>gateway<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="编写配置文件"><a href="#编写配置文件" class="headerlink" title="编写配置文件"></a>编写配置文件</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">10010</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">api-gateway</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">routes:</span><br>        <span class="hljs-comment"># 路由id，可以随意写</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">user-service-route</span><br>        <span class="hljs-comment"># 代理的服务地址，lb表示从eureka中获取具体服务（动态路由）</span><br>          <span class="hljs-comment"># uri: http://127.0.0.1:9091</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://user-service</span><br>        <span class="hljs-comment"># 路由断言，可以配置映射路径</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/user/**</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">service-url:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://127.0.0.1:10086/eureka</span><br>  <span class="hljs-attr">instance:</span><br>    <span class="hljs-attr">prefer-ip-address:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>使用动态路由注意事项：</p>
<p>lb 之后编写的服务名必须要在eureka中注册才能使用</p>
</blockquote>
<h3 id="编写启动器Application"><a href="#编写启动器Application" class="headerlink" title="编写启动器Application"></a>编写启动器Application</h3><p>编写<code>springcloud-demo01/gateway/src/main/java/top/igotcha/gateway/GatewayApplication.java</code>启动器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableDiscoveryClient</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GatewayApplication</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(GatewayApplication.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="运行项目-2"><a href="#运行项目-2" class="headerlink" title="运行项目"></a>运行项目</h3><p>可以从10010网关端口进行访问了</p>
<p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/3.2.png" srcset="/img/loading.gif" lazyload></p>
<blockquote>
<p>路由配置中uri所用的协议为lb时（以uri: lb://user-service为例），gateway将使用 LoadBalancerClient把 user-service通过eureka解析为实际的主机和端口，并进行ribbon负载均衡。</p>
</blockquote>
<hr>
<h2 id="3-3-路由前缀"><a href="#3-3-路由前缀" class="headerlink" title="3.3 路由前缀"></a>3.3 路由前缀</h2><h3 id="添加前缀"><a href="#添加前缀" class="headerlink" title="添加前缀"></a>添加前缀</h3><p>在gateway中可以通过配置路由的过滤器PrefixPath，实现映射路径中地址的添加</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">10010</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">api-gateway</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">routes:</span><br>        <span class="hljs-comment"># 路由id，可以随意写</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">user-service-route</span><br>        <span class="hljs-comment"># 代理的服务地址，lb表示从eureka中获取具体服务</span><br>          <span class="hljs-comment"># uri: http://127.0.0.1:9091</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://user-service</span><br>        <span class="hljs-comment"># 路由断言，可以配置映射路径</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/**</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-comment"># 添加请求路径的前缀</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">PrefixPath=/user</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">service-url:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://127.0.0.1:10086/eureka</span><br>  <span class="hljs-attr">instance:</span><br>    <span class="hljs-attr">prefer-ip-address:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<ul>
<li>通过 PrefixPath=/xxx 来指定了路由要添加的前缀。<strong>对请求地址添加前缀路径之后再作为代理的服务地址</strong></li>
</ul>
<p><code>PrefixPath = /user</code>，实现了 <a target="_blank" rel="noopener" href="http://localhost:10010/1">http://localhost:10010/1</a> –》<a target="_blank" rel="noopener" href="http://localhost:9091/user/1%EF%BC%8C%EF%BC%88%E6%B7%BB%E5%8A%A0%E5%89%8D%E7%BC%80%E8%B7%AF%E5%BE%84/user%EF%BC%89">http://localhost:9091/user/1，（添加前缀路径/user）</a></p>
<p>测试运行如下</p>
<p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/3.3.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="去除前缀"><a href="#去除前缀" class="headerlink" title="去除前缀"></a>去除前缀</h3><p>在gateway中可以通过配置路由的过滤器StripPrefix，实现映射路径中地址的去除</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">10010</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">api-gateway</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">routes:</span><br>        <span class="hljs-comment"># 路由id，可以随意写</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">user-service-route</span><br>        <span class="hljs-comment"># 代理的服务地址，lb表示从eureka中获取具体服务</span><br>          <span class="hljs-comment"># uri: http://127.0.0.1:9091</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://user-service</span><br>        <span class="hljs-comment"># 路由断言，可以配置映射路径</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/api/user/**</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-comment"># 表示过滤1个路径，2表示两个路径，以此类推</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">service-url:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://127.0.0.1:10086/eureka</span><br>  <span class="hljs-attr">instance:</span><br>    <span class="hljs-attr">prefer-ip-address:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<ul>
<li>通过 StripPrefix=/xxx 来指定了路由要去除前缀的个数。<strong>对请求地址去除前缀路径之后再作为代理的服务地址</strong></li>
</ul>
<p><code>StripPrefix=1</code>，实现了 <a target="_blank" rel="noopener" href="http://localhost:10010/api/user/1">http://localhost:10010/api/user/1</a> –》<a target="_blank" rel="noopener" href="http://localhost:9091/user/1">http://localhost:9091/user/1</a> ，（去除前缀路径/api）</p>
<p><code>StripPrefix=2</code>，实现了 <a target="_blank" rel="noopener" href="http://localhost:10010/api/user/1">http://localhost:10010/api/user/1</a> –》<a target="_blank" rel="noopener" href="http://localhost:9091/1%EF%BC%8C%EF%BC%88%E5%8E%BB%E9%99%A4%E5%89%8D%E7%BC%80%E8%B7%AF%E5%BE%84/api/user%EF%BC%89">http://localhost:9091/1，（去除前缀路径/api/user）</a></p>
<hr>
<h2 id="3-4-过滤器"><a href="#3-4-过滤器" class="headerlink" title="3.4 过滤器"></a>3.4 过滤器</h2><h3 id="概述-7"><a href="#概述-7" class="headerlink" title="概述"></a>概述</h3><p>Gateway作为网关的重要功能，就是实现请求的鉴权。这个动作往往是通过网关提供的过滤器来实现的。 路由前缀的添加和去除功能也是使用过滤器实现的。</p>
<p>Gateway自带过滤器有几十个，常见自带过滤器有：</p>
<table>
<thead>
<tr>
<th>过滤器名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>AddRequestHeader</td>
<td>对匹配上的请求加上Header</td>
</tr>
<tr>
<td>AddRequestParameters</td>
<td>对匹配上的请求路由添加参数</td>
</tr>
<tr>
<td>AddResponseHeader</td>
<td>对从网关返回的响应添加Header</td>
</tr>
<tr>
<td>StripPrefix</td>
<td>对匹配上的请求路径去除前缀</td>
</tr>
</tbody></table>
<h3 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h3><p>Gateway实现方式上，有两种过滤器； </p>
<ul>
<li><strong>局部过滤器</strong>：<ul>
<li>通过<code>spring.cloud.gateway.routes.filters</code>配置在具体路由下，只作用在当前路由上</li>
</ul>
</li>
<li><strong>全局过滤器</strong>：<ul>
<li>不需要在配置文件中配置，作用在所有的路由上；实现<code>GlobalFilter</code>接口即可。</li>
<li>如果配置<code>spring.cloud.gateway.default-filters</code>上会对所有路由生效也算是全局的过滤器；但是这些过滤器的实现上，都是要实现GatewayFilterFactory接口（实现上还是和局部过滤器一样）。</li>
</ul>
</li>
</ul>
<h3 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h3><p>Spring Cloud Gateway 的 Filter 的生命周期也类似Spring MVC的拦截器有两个：“pre” 和 “post”。“pre”和 “post” 分别会在请求被执行前调用和被执行后调用。</p>
<p>这里的<code>pre</code>和<code>post</code>可以通过过滤器的<code>GatewayFilterChain</code>执行<code>filter</code>方法前后来实现。</p>
<p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/3.4.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="自定义局部过滤器"><a href="#自定义局部过滤器" class="headerlink" title="自定义局部过滤器"></a>自定义局部过滤器</h3><h4 id="编写过滤器"><a href="#编写过滤器" class="headerlink" title="编写过滤器"></a>编写过滤器</h4><p>在gateway工程编写过滤器工厂类<code>MyParamGatewayFilterFactor</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyParamGatewayFilterFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractGatewayFilterFactory</span>&lt;<span class="hljs-title">MyParamGatewayFilterFactory</span>.<span class="hljs-title">Config</span>&gt; </span>&#123;<br>    <span class="hljs-comment">//值要与Config配置类中一致</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String PARAM_NAME = <span class="hljs-string">&quot;param&quot;</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyParamGatewayFilterFactory</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>(Config.class);<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title">shortcutFieldOrder</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> Arrays.asList(PARAM_NAME);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> GatewayFilter <span class="hljs-title">apply</span><span class="hljs-params">(Config config)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> ((exchange, chain) -&gt; &#123;<br>            <span class="hljs-comment">//获取请求参数中param对应的参数名称</span><br>            ServerHttpRequest request = exchange.getRequest();<br>            <span class="hljs-keyword">if</span> (request.getQueryParams().containsKey(config.param))&#123;<br>                request.getQueryParams().get(config.param)<br>                        .forEach(value-&gt;System.out.printf(<span class="hljs-string">&quot;-----局部过滤器-----%s=%s&quot;</span>,config.param,value));<br>            &#125;<br>            <span class="hljs-keyword">return</span> chain.filter(exchange);<br>        &#125;);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Config</span> </span>&#123;<br>        <span class="hljs-comment">//对应在配置在自定义过滤器中指定的参数</span><br>        <span class="hljs-keyword">private</span> String param;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getParam</span><span class="hljs-params">()</span> </span>&#123;<br>            <span class="hljs-keyword">return</span> param;<br>        &#125;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setParam</span><span class="hljs-params">(String param)</span> </span>&#123;<br>            <span class="hljs-keyword">this</span>.param = param;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="修改配置文件-1"><a href="#修改配置文件-1" class="headerlink" title="修改配置文件"></a>修改配置文件</h4><p>修改<code>springcloud-demo01/gateway/src/main/resources/application.yml</code>配置文件，添加自定义过滤器</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">10010</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">api-gateway</span><br>  <span class="hljs-attr">cloud:</span><br>      <span class="hljs-attr">routes:</span><br>        <span class="hljs-comment"># 路由id，可以随意写</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">user-service-route</span><br>        <span class="hljs-comment"># 代理的服务地址，lb表示从eureka中获取具体服务</span><br>          <span class="hljs-comment"># uri: http://127.0.0.1:9091</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://user-service</span><br>        <span class="hljs-comment"># 路由断言，可以配置映射路径</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/api/user/**</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-comment"># 表示过滤1个路径，2表示两个路径，以此类推</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br>            <span class="hljs-comment"># 自定义过滤器中值</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">MyParam=name</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">service-url:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://127.0.0.1:10086/eureka</span><br>  <span class="hljs-attr">instance:</span><br>    <span class="hljs-attr">prefer-ip-address:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<h4 id="运行项目-3"><a href="#运行项目-3" class="headerlink" title="运行项目"></a>运行项目</h4><p>重启项目后，当请求参数含有name属性时，会打印name的值</p>
<p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/3.5.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="全局默认过滤器"><a href="#全局默认过滤器" class="headerlink" title="全局默认过滤器"></a>全局默认过滤器</h3><p>对于自带的过滤器，可以设置为对所有路由生效，也就是配置成为默认过滤器：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">10010</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">api-gateway</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-comment"># 默认过滤器，对所有路由生效</span><br>      <span class="hljs-attr">default-filters:</span><br>        <span class="hljs-comment"># 响应头过滤器，对输出的响应设置其头部属性名称为X-Response-Default-MyName，值为Gotcha；如果有多个参数多则重写一行设置不同的参数</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">AddResponseHeader=X-Response-Default-MyName,</span> <span class="hljs-string">Gotcha</span><br>      <span class="hljs-attr">routes:</span><br>        <span class="hljs-comment"># 路由id，可以随意写</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">user-service-route</span><br>        <span class="hljs-comment"># 代理的服务地址，lb表示从eureka中获取具体服务</span><br>          <span class="hljs-comment"># uri: http://127.0.0.1:9091</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://user-service</span><br>        <span class="hljs-comment"># 路由断言，可以配置映射路径</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/api/user/**</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-comment"># 表示过滤1个路径，2表示两个路径，以此类推</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br>            <span class="hljs-comment"># 自定义过滤器中值</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">MyParam=name</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">service-url:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://127.0.0.1:10086/eureka</span><br>  <span class="hljs-attr">instance:</span><br>    <span class="hljs-attr">prefer-ip-address:</span> <span class="hljs-literal">true</span><br><br></code></pre></td></tr></table></figure>

<p>设置后，在响应头中可以查看到响应信息</p>
<p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/3.6.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="全局自定义过滤器"><a href="#全局自定义过滤器" class="headerlink" title="全局自定义过滤器"></a>全局自定义过滤器</h3><h4 id="编写全局过滤器"><a href="#编写全局过滤器" class="headerlink" title="编写全局过滤器"></a>编写全局过滤器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyGlobalFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">GlobalFilter</span>, <span class="hljs-title">Ordered</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title">filter</span><span class="hljs-params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;-----全局过滤器MyGlobalFilter-----&quot;</span>);<br>        String token = exchange.getRequest().getQueryParams().getFirst(<span class="hljs-string">&quot;token&quot;</span>);<br>        <span class="hljs-keyword">if</span> (StringUtils.isBlank(token)) &#123;<br>            exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);<br>            <span class="hljs-keyword">return</span> exchange.getResponse().setComplete();<br>        &#125;<br>        <span class="hljs-keyword">return</span> chain.filter(exchange);<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getOrder</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-comment">//值越小越先执行</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>实现<code>GlobalFilter</code>接口的全局过滤器，不需要在配置文件中配置，作用在所有的路由上。</p>
</blockquote>
<ul>
<li>未携带token，返回401未授权</li>
</ul>
<p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/3.7.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>携带token，正常访问</li>
</ul>
<p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/3.8.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="3-5-负载均衡和熔断配置"><a href="#3-5-负载均衡和熔断配置" class="headerlink" title="3.5 负载均衡和熔断配置"></a>3.5 负载均衡和熔断配置</h2><p>Gateway中默认就已经集成了Ribbon负载均衡和Hystrix熔断机制。所有的超时策略都是默认值。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">hystrix:</span><br>  <span class="hljs-attr">command:</span><br>    <span class="hljs-attr">default:</span><br>      <span class="hljs-attr">execution:</span><br>        <span class="hljs-attr">isolation:</span><br>          <span class="hljs-attr">thread:</span><br>            <span class="hljs-attr">timeoutInMilliseconds:</span> <span class="hljs-number">6000</span><br><span class="hljs-attr">ribbon:</span><br>  <span class="hljs-attr">ConnectTimeout:</span> <span class="hljs-number">1000</span><br>  <span class="hljs-attr">ReadTimeout:</span> <span class="hljs-number">2000</span><br>  <span class="hljs-attr">MaxAutoRetries:</span> <span class="hljs-number">0</span><br>  <span class="hljs-attr">MaxAutoRetriesNextServer:</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>

<h2 id="3-5-跨域配置"><a href="#3-5-跨域配置" class="headerlink" title="3.5 跨域配置"></a>3.5 跨域配置</h2><p>在访问Spring Cloud Gateway网关服务器的时候，出现跨域问题的话，可以在网关服务器中通过配置解决，允许哪些服务是可以跨域请求的。具体配置如下：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">api-gateway</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-comment"># 默认过滤器，对所有路由生效</span><br>      <span class="hljs-attr">default-filters:</span><br>        <span class="hljs-comment"># 响应头过滤器，对输出的响应设置其头部属性名称为X-Response-Default-MyName，值为Gotcha；如果有多个参数多则重写一行设置不同的参数</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">AddResponseHeader=X-Response-Default-MyName,</span> <span class="hljs-string">Gotcha</span><br>      <span class="hljs-attr">routes:</span><br>        <span class="hljs-comment"># 路由id，可以随意写</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">user-service-route</span><br>        <span class="hljs-comment"># 代理的服务地址，lb表示从eureka中获取具体服务</span><br>          <span class="hljs-comment"># uri: http://127.0.0.1:9091</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://user-service</span><br>        <span class="hljs-comment"># 路由断言，可以配置映射路径</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/api/user/**</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-comment"># 表示过滤1个路径，2表示两个路径，以此类推</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br>            <span class="hljs-comment"># 自定义过滤器中值</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">MyParam=name</span><br>      <span class="hljs-attr">globalcors:</span><br>        <span class="hljs-attr">corsConfigurations:</span><br>          <span class="hljs-string">&#x27;[/**]&#x27;</span><span class="hljs-string">:</span><br>            <span class="hljs-comment">#allowedOrigins: * # 这种写法或者下面的都可以，*表示全部</span><br>            <span class="hljs-attr">allowedOrigins:</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;http://docs.spring.io&quot;</span><br>            <span class="hljs-attr">allowedMethods:</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">GET</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>上述配置表示：可以允许来自 <a target="_blank" rel="noopener" href="http://docs.spring.io/">http://docs.spring.io</a> 的get请求方式获取服务数据。 allowedOrigins 指定允许访问的服务器地址，如：<a target="_blank" rel="noopener" href="http://localhost:10000/">http://localhost:10000</a> 也是可以的。 ‘[/**]’ 表示对所有访问到网关服务器的请求地址</p>
</blockquote>
<blockquote>
<p>Gateway网关一般直接给终端请求使用；Feign一般用在微服务之间调用。</p>
</blockquote>
<hr>
<h1 id="四、-Spring-Cloud-Config分布式配置中心"><a href="#四、-Spring-Cloud-Config分布式配置中心" class="headerlink" title="四、 Spring Cloud Config分布式配置中心"></a>四、 Spring Cloud Config分布式配置中心</h1><h2 id="4-1-概述"><a href="#4-1-概述" class="headerlink" title="4.1 概述"></a>4.1 概述</h2><p>在分布式系统中，由于服务数量非常多，配置文件分散在不同的微服务项目中，管理不方便。为了方便配置文件集中管理，需要分布式配置中心组件。</p>
<p>在Spring Cloud中，提供了Spring Cloud Config，它支持配置文件放在配置服务的本地，也支持放在远程Git仓库（GitHub、码云）。 使用Spring Cloud Config配置中心后的架构如下图：</p>
<p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/4.1.png" srcset="/img/loading.gif" lazyload></p>
<blockquote>
<p>spring cloud config实现了，通过修改在git仓库中的配置文件实现其它所有微服务的配置文件的修改。</p>
</blockquote>
<hr>
<h1 id="五、Spring-Cloud-Bus服务总线"><a href="#五、Spring-Cloud-Bus服务总线" class="headerlink" title="五、Spring Cloud Bus服务总线"></a>五、Spring Cloud Bus服务总线</h1><h2 id="5-1-概述"><a href="#5-1-概述" class="headerlink" title="5.1 概述"></a>5.1 概述</h2><p>Spring Cloud Bus是用轻量的消息代理将分布式的节点连接起来，可以用于广播配置文件的更改或者服务的监控管理。也就是消息总线可以为微服务做监控，也可以实现应用程序之间相互通信。 Spring Cloud Bus可选的消息代理有RabbitMQ和Kafka。使用Spring Cloud Bus服务总线后的架构如下图：</p>
<p><img src="/2021/01/25/Java/%E6%A1%86%E6%9E%B6/SpringCloud/SpringCloud%E5%85%A5%E9%97%A8/SpringCloud%E5%85%A5%E9%97%A8/5.1.png" srcset="/img/loading.gif" lazyload></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/Java/">Java</a>
                    
                      <a class="hover-with-bg" href="/categories/Java/%E6%A1%86%E6%9E%B6/">框架</a>
                    
                      <a class="hover-with-bg" href="/categories/Java/%E6%A1%86%E6%9E%B6/Spring/">Spring</a>
                    
                      <a class="hover-with-bg" href="/categories/Java/%E6%A1%86%E6%9E%B6/Spring/SpringCloud/">SpringCloud</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/SpringCloud/">SpringCloud</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/04/25/%E5%AE%B9%E5%99%A8%E5%8C%96/Docker/Docker%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Docker</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/01/04/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%9F%BA%E7%A1%80/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%9F%BA%E7%A1%80/">
                        <span class="hidden-mobile">大数据基础</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
    
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>



  <script  src="/js/local-search.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>


  <script defer src="/js/leancloud.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>









  <script  src="https://cdn.jsdelivr.net/npm/mermaid@8.8.3/dist/mermaid.min.js" ></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({"theme":"default"});
    }
  </script>




  
    <!-- Baidu Analytics -->
    <script defer>
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?cd190160b5401a029cee361d013e32a1";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  

  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
