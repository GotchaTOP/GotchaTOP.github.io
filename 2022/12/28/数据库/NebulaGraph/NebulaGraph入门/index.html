

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="懂一点点">
  <meta name="author" content="Gotcha">
  <meta name="keywords" content="">
  
  <title>NebulaGraph入门 - Gotcha的笔记总结</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.11","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":"cd190160b5401a029cee361d013e32a1","google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"U8yaiFQ2fUef4ujWTig83mSL-gzGzoHsz","app_key":"akCMytdeJqrMuKP84F4oblqz","server_url":"https://u8yaifq2.lc-cn-n1-shared.com"}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Gotcha的笔记总结</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/background/01.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="NebulaGraph入门">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-12-28 00:00" pubdate>
        2022年12月28日 凌晨
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      22k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      700
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">NebulaGraph入门</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：2023年1月12日 凌晨
                
              </p>
            
            <div class="markdown-body">
              <h1 id="一、NebulaGraph介绍"><a href="#一、NebulaGraph介绍" class="headerlink" title="一、NebulaGraph介绍"></a>一、NebulaGraph介绍</h1><h2 id="1-1-概述"><a href="#1-1-概述" class="headerlink" title="1.1 概述"></a>1.1 概述</h2><p>NebulaGraph 是一款开源的、<strong>分布式</strong>的、易扩展的原生<strong>图数据库</strong>，能够承载数千亿个点和数万亿条边的超大规模数据集，并且提供<strong>毫秒级查询</strong>。</p>
<p><img src="/2022/12/28/%E6%95%B0%E6%8D%AE%E5%BA%93/NebulaGraph/NebulaGraph%E5%85%A5%E9%97%A8/image-20221229223422059.png" srcset="/img/loading.gif" lazyload alt="image-20221229223422059"></p>
<h2 id="1-2-数据模型"><a href="#1-2-数据模型" class="headerlink" title="1.2 数据模型"></a>1.2 数据模型</h2><p>NebulaGraph 数据模型使用 6 种基本的数据模型：</p>
<ul>
<li><p>图空间（Space）</p>
<ul>
<li>图空间用于隔离不同团队或者项目的数据。不同图空间的数据是相互隔离的，可以指定不同的存储副本数、权限、分片等。</li>
</ul>
</li>
<li><p>点（Vertex）</p>
<ul>
<li>点用来保存实体对象，特点如下：<ul>
<li>点是用点标识符（<code>VID</code>）标识的。<code>VID</code>在同一图空间中唯一。</li>
<li>点可以有 0 到多个 Tag。</li>
</ul>
</li>
</ul>
<blockquote>
<p>NebulaGraph 2.x 及以下版本中的点必须包含至少一个 Tag。</p>
</blockquote>
<ul>
<li>VID相关：<ul>
<li>VID 数据类型只可以为定长字符串<code>FIXED_STRING</code>或<code>INT64</code>；<strong>一个图空间只能选用其中一种 VID 类型</strong>。</li>
<li><strong>VID 在一个图空间中必须唯一</strong>，其作用类似于关系型数据库中的主键（索引+唯一约束）。但不同图空间中的 VID 是完全独立无关的。</li>
<li>点 VID 的生成方式必须由用户自行指定，系统不提供自增 ID 或者 UUID。</li>
<li>VID 相同的点，会被认为是同一个点。例如：</li>
<li>VID 相当于一个实体的唯一标号，例如一个人的身份证号。</li>
<li>同时操作相同 VID 并且相同 Tag 的两条<code>INSERT</code>语句（均无<code>IF NOT EXISTS</code>参数），晚写入的<code>INSERT</code>会覆盖先写入的。</li>
<li>同时操作包含相同 VID 但是两个不同<code>TAG A</code>和<code>TAG B</code>的两条<code>INSERT</code>语句，对<code>TAG A</code>的操作不会影响<code>TAG B</code>。</li>
<li>VID 通常会被（LSM-tree 方式，日志结构合并树）索引并缓存在内存中，因此直接访问 VID 的性能最高。通过属性先查找 VID，再进行图操作的性能会变差，例如<code>LOOKUP | GO FROM $-.ids</code>等语句，相比前者多了一次内存或硬盘的随机读（<code>LOOKUP</code>）以及一次序列化（<code>|</code>）。</li>
<li>VID 的数据类型必须在创建图空间时定义，且一旦定义无法修改。</li>
<li>VID 必须在插入点时设置，且一旦设置无法修改。</li>
<li>VID 的生成工作完全交给应用端，有如下建议：<ul>
<li>（最优）通过有唯一性的主键或者属性来直接作为 VID；属性访问依赖于 VID;</li>
<li>通过有唯一性的属性组合来生成 VID，属性访问依赖于属性索引。</li>
<li>通过 snowflake 等算法生成 VID，属性访问依赖于属性索引。</li>
<li>如果个别记录的主键特别长，但绝大多数记录的主键都很短的情况，不要将<code>FIXED_STRING(&lt;N&gt;)</code>的<code>N</code>设置成超大，这会浪费大量内存和硬盘，也会降低性能。此时可通过 BASE64，MD5，hash 编码加拼接的方式来生成。</li>
<li>如果用 hash 方式生成 int64 VID：在有 10 亿个点的情况下，发生 hash 冲突的概率大约是 1/10。边的数量与碰撞的概率无关。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>边（Edge）</p>
<ul>
<li>边是用来连接点的，表示两个点之间的关系或行为，特点如下：<ul>
<li>两点之间可以有多条边。</li>
<li>边是有方向的，不存在无向边。</li>
<li>四元组 <code>&lt;起点 VID、Edge type、边排序值 (rank)、终点 VID&gt;</code> 用于唯一标识一条边。边没有 EID。</li>
<li>一条边有且仅有一个 Edge type。</li>
<li>一条边有且仅有一个 Rank，类型为 int64，默认值为 0。</li>
</ul>
</li>
</ul>
<blockquote>
<p>Rank 可以用来区分 Edge type、起始点、目的点都相同的边。该值完全由用户自己指定。<br>读取时必须自行取得全部的 Rank 值后排序过滤和拼接。<br>不支持诸如<code>next(), pre(), head(), tail(), max(), min(), lessThan(), moreThan()</code>等函数功能，也不能通过创建索引加速访问或者条件过滤。</p>
</blockquote>
</li>
<li><p>标签（Tag）</p>
<ul>
<li>Tag 由一组事先预定义的属性构成。</li>
<li>Tag 相当于实体所拥有的类型，例如”滴滴司机”和”职员”。不同的 Tag 又相应定义了两组不同的属性，例如”驾照号、驾龄、接单量、接单小号”和”工号、薪水、债务额度、商务电话”。</li>
</ul>
</li>
<li><p>边类型（Edge type）</p>
<ul>
<li>Edge type 由一组事先预定义的属性构成。</li>
</ul>
</li>
<li><p>属性（Property）</p>
<ul>
<li>属性是指以键值对（Key-value pair）形式表示的信息。</li>
</ul>
</li>
</ul>
<blockquote>
<p>Tag 和 Edge type 的作用，类似于关系型数据库中“点表”和“边表”的表结构。</p>
</blockquote>
<p>图数据库将图中的数据高效存储为点（Vertex）和边（Edge），还可以将属性（Property）附加到点和边上。</p>
<p><img src="/2022/12/28/%E6%95%B0%E6%8D%AE%E5%BA%93/NebulaGraph/NebulaGraph%E5%85%A5%E9%97%A8/image-20230103095345192.png" srcset="/img/loading.gif" lazyload alt="image-20230103095345192"></p>
<h2 id="1-3-图模型"><a href="#1-3-图模型" class="headerlink" title="1.3 图模型"></a>1.3 图模型</h2><p>NebulaGraph 使用<strong>有向属性图模型</strong>，指点和边构成的图，这些边是有方向的，点和边都可以有属性。</p>
<p>下表为篮球运动员数据集的结构示例，包括两种类型的点（<strong>player</strong>、<strong>team</strong>）和两种类型的边（<strong>serve</strong>、<strong>follow</strong>）。</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>名称</th>
<th>属性名（数据类型）</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Tag</td>
<td><strong>player</strong></td>
<td>name (string) age（int）</td>
<td>表示球员。</td>
</tr>
<tr>
<td>Tag</td>
<td><strong>team</strong></td>
<td>name (string)</td>
<td>表示球队。</td>
</tr>
<tr>
<td>Edge type</td>
<td><strong>serve</strong></td>
<td>start_year (int) end_year (int)</td>
<td>表示球员的行为。 该行为将球员和球队联系起来，方向是从球员到球队。</td>
</tr>
<tr>
<td>Edge type</td>
<td><strong>follow</strong></td>
<td>degree (int)</td>
<td>表示球员的行为。 该行为将两个球员联系起来，方向是从一个球员到另一个球员。</td>
</tr>
</tbody></table>
<p>为了在图空间中插入数据，需要为图数据库定义一个 <strong>Schema</strong>。NebulaGraph 的 Schema 是由如下几部分组成。</p>
<table>
<thead>
<tr>
<th>组成部分</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>点（Vertex）</td>
<td>表示现实世界中的实体。一个点可以有 0 到多个标签。</td>
</tr>
<tr>
<td>标签（Tag）</td>
<td>点的类型，定义了一组描述点类型的属性。</td>
</tr>
<tr>
<td>边（Edge）</td>
<td>表示两个点之间<strong>有方向</strong>的关系。</td>
</tr>
<tr>
<td>边类型（Edge type）</td>
<td>边的类型，定义了一组描述边的类型的属性。</td>
</tr>
</tbody></table>
<h2 id="1-4-路径"><a href="#1-4-路径" class="headerlink" title="1.4 路径"></a>1.4 路径</h2><p>图论中一个非常重要的概念是路径，路径是指一个有限或无限的边序列，这些边连接着一系列点。</p>
<p>路径的类型分为三种：<code>walk</code>、<code>trail</code>、<code>path</code>。</p>
<p><img src="/2022/12/28/%E6%95%B0%E6%8D%AE%E5%BA%93/NebulaGraph/NebulaGraph%E5%85%A5%E9%97%A8/image-20230103100014507.png" srcset="/img/loading.gif" lazyload alt="image-20230103100014507"></p>
<h3 id="1-4-1-walk"><a href="#1-4-1-walk" class="headerlink" title="1.4.1 walk"></a>1.4.1 walk</h3><p><code>walk</code>类型的路径由有限或无限的边序列构成。<strong>遍历时点和边可以重复</strong>。</p>
<p>查看示例图，由于 C、D、E 构成了一个环，因此该图包含无限个路径，例如<code>A-&gt;B-&gt;C-&gt;D-&gt;E</code>、<code>A-&gt;B-&gt;C-&gt;D-&gt;E-&gt;C</code>、<code>A-&gt;B-&gt;C-&gt;D-&gt;E-&gt;C-&gt;D</code>。</p>
<h3 id="1-4-2-trail"><a href="#1-4-2-trail" class="headerlink" title="1.4.2 trail"></a>1.4.2 trail</h3><p><code>trail</code>类型的路径由有限的边序列构成。遍历时<strong>只有点可以重复，边不可以重复</strong>。柯尼斯堡七桥问题的路径类型就是<code>trail</code>。</p>
<p>查看示例图，由于边不可以重复，所以该图包含有限个路径，最长路径由 5 条边组成：<code>A-&gt;B-&gt;C-&gt;D-&gt;E-&gt;C</code>。</p>
<p>在 trail 类型中，还有<code>cycle</code>和<code>circuit</code>两种特殊的路径类型，以下图为例对这两种特殊的路径类型进行介绍。</p>
<p><img src="/2022/12/28/%E6%95%B0%E6%8D%AE%E5%BA%93/NebulaGraph/NebulaGraph%E5%85%A5%E9%97%A8/image-20230103100631813.png" srcset="/img/loading.gif" lazyload alt="image-20230103100631813"></p>
<h4 id="cycle"><a href="#cycle" class="headerlink" title="cycle"></a>cycle</h4><p><strong><code>cycle</code> 是封闭的 <code>trail</code> 类型的路径</strong>，遍历时<strong>边不可以重复，起点和终点重复，并且没有其他点重复</strong>。在此示例图中，最长路径由三条边组成：<code>A-&gt;B-&gt;C-&gt;A</code>或<code>C-&gt;D-&gt;E-&gt;C</code>.</p>
<h4 id="circuit"><a href="#circuit" class="headerlink" title="circuit"></a>circuit</h4><p><strong><code>circuit</code> 也是封闭的 <code>trail</code> 类型的路径</strong>，遍历时<strong>边不可以重复，除起点和终点重复外，可能存在其他点重复</strong>。在此示例图中，最长路径为：<code>A-&gt;B-&gt;C-&gt;D-&gt;E-&gt;C-&gt;A</code>。</p>
<h3 id="1-4-3-path"><a href="#1-4-3-path" class="headerlink" title="1.4.3 path"></a>1.4.3 path</h3><p><code>path</code>类型的路径由有限的边序列构成。<strong>遍历时点和边都不可以重复</strong>。</p>
<p>查看示例图，由于点和边都不可以重复，所以该图包含有限个路径，最长路径由 4 条边组成：<code>A-&gt;B-&gt;C-&gt;D-&gt;E</code>。</p>
<h2 id="1-5-服务架构"><a href="#1-5-服务架构" class="headerlink" title="1.5 服务架构"></a>1.5 服务架构</h2><h3 id="1-5-1-总览"><a href="#1-5-1-总览" class="headerlink" title="1.5.1 总览"></a>1.5.1 总览</h3><p>NebulaGraph 由三种服务构成：Graph 服务、Meta 服务和 Storage 服务，是一种<strong>存储与计算分离</strong>的架构。</p>
<p>每个服务都有可执行的二进制文件和对应进程，用户可以使用这些二进制文件在一个或多个计算机上部署 NebulaGraph 集群。</p>
<p><img src="/2022/12/28/%E6%95%B0%E6%8D%AE%E5%BA%93/NebulaGraph/NebulaGraph%E5%85%A5%E9%97%A8/image-20230103103712747.png" srcset="/img/loading.gif" lazyload alt="image-20230103103712747"></p>
<p>其中，Meta 服务是由 nebula-metad 进程提供的，<strong>负责数据管理</strong>，例如 Schema 操作、集群管理和用户权限管理等。</p>
<p>Graph 服务负责处理计算请求，Storage 服务负责存储数据。它们由不同的进程提供，Graph 服务是由 nebula-graphd 进程提供，Storage 服务是由 nebula-storaged 进程提供。</p>
<p>由于其采用了<strong>计算存储分离架构</strong>，其具备如下优势：</p>
<ul>
<li><p>易扩展</p>
<p>分布式架构保证了 Graph 服务和 Storage 服务的灵活性，方便扩容和缩容。</p>
</li>
<li><p>高可用</p>
<p>如果提供 Graph 服务的服务器有一部分出现故障，其余服务器可以继续为客户端提供服务，而且 Storage 服务存储的数据不会丢失。服务恢复速度较快，甚至能做到用户无感知。</p>
</li>
<li><p>节约成本</p>
<p>计算存储分离架构能够提高资源利用率，而且可根据业务需求灵活控制成本。</p>
</li>
</ul>
<h3 id="1-5-2-Meta-服务"><a href="#1-5-2-Meta-服务" class="headerlink" title="1.5.2 Meta 服务"></a>1.5.2 Meta 服务</h3><ul>
<li>Meta 服务是由 nebula-metad 进程提供的，用户可以根据场景配置 nebula-metad 进程数量：<ul>
<li>测试环境中，用户可以在 NebulaGraph 集群中部署 1 个或 3 个 nebula-metad 进程。如果要部署 3 个，用户可以将它们部署在 1 台机器上，或者分别部署在不同的机器上。</li>
<li>生产环境中，建议在 NebulaGraph 集群中部署 3 个 nebula-metad 进程。请将这些进程部署在不同的机器上以保证高可用。</li>
</ul>
</li>
</ul>
<p>所有 nebula-metad 进程构成了基于 Raft 协议的集群，其中<strong>一个进程是 leader，其他进程都是 follower</strong>。</p>
<p>leader 是由多数派选举出来，只有 leader 能够对客户端或其他组件提供服务，其他 follower 作为候补，如果 leader 出现故障，会在所有 follower 中选举出新的 leader。</p>
<blockquote>
<p>leader 和 follower 的数据通过 Raft 协议保持一致</p>
</blockquote>
<p><img src="/2022/12/28/%E6%95%B0%E6%8D%AE%E5%BA%93/NebulaGraph/NebulaGraph%E5%85%A5%E9%97%A8/image-20230103105103355.png" srcset="/img/loading.gif" lazyload alt="image-20230103105103355"></p>
<ul>
<li>Meta 服务功能<ul>
<li>管理用户账号（鉴权）：Meta 服务中存储了用户的账号和权限信息，当客户端通过账号发送请求给 Meta 服务，Meta 服务会检查账号信息，以及该账号是否有对应的请求权限。</li>
<li>管理分片：Meta 服务负责存储和管理分片的位置信息，并且保证分片的负载均衡。</li>
<li>管理图空间：NebulaGraph 支持多个图空间，不同图空间内的数据是安全隔离的。Meta 服务存储所有图空间的元数据，并跟踪数据的变更，例如增加或删除图空间。</li>
<li>管理 Schema 信息：NebulaGraph 是强类型图数据库，它的 Schema 包括 Tag、Edge type、Tag 属性和 Edge type 属性。Meta 服务中存储了 Schema 信息，同时还负责 Schema 的添加、修改和删除，并记录它们的版本。</li>
<li>管理 TTL 信息：Meta 服务存储 TTL（Time To Live）定义信息，可以用于设置数据生命周期。数据过期后，会由 Storage 服务进行处理。</li>
<li>管理作业：Meta 服务中的作业管理模块负责作业的创建、排队、查询和删除。</li>
</ul>
</li>
</ul>
<h3 id="1-5-3-Graph服务"><a href="#1-5-3-Graph服务" class="headerlink" title="1.5.3 Graph服务"></a>1.5.3 Graph服务</h3><ul>
<li>Graph 服务主要负责处理查询请求，包括<strong>解析查询语句、校验语句、生成执行计划以及按照执行计划执行</strong>四个大步骤</li>
</ul>
<p><img src="/2022/12/28/%E6%95%B0%E6%8D%AE%E5%BA%93/NebulaGraph/NebulaGraph%E5%85%A5%E9%97%A8/image-20230103105723240.png" srcset="/img/loading.gif" lazyload alt="image-20230103105723240"></p>
<ul>
<li><p>查询请求发送到 Graph 服务后，会由如下模块依次处理：</p>
<ul>
<li><p><strong>Parser</strong>：词法语法解析模块。</p>
<ul>
<li><p>Parser 模块收到请求后，通过 Flex（词法分析工具）和 Bison（语法分析工具）生成的词法语法解析器，将语句转换为抽象语法树（AST），在语法解析阶段会拦截不符合语法规则的语句。</p>
</li>
<li><p>例如<code>GO FROM &quot;Tim&quot; OVER like WHERE properties(edge).likeness &gt; 8.0 YIELD dst(edge)</code>语句转换的 AST 如下：</p>
<p><img src="/2022/12/28/%E6%95%B0%E6%8D%AE%E5%BA%93/NebulaGraph/NebulaGraph%E5%85%A5%E9%97%A8/image-20230103105920529.png" srcset="/img/loading.gif" lazyload alt="image-20230103105920529"></p>
</li>
</ul>
</li>
<li><p><strong>Validator</strong>：语义校验模块。</p>
<ul>
<li><p>Validator 模块对生成的 AST 进行语义校验，主要包括：</p>
<ul>
<li><p>校验元数据信息</p>
<p>校验语句中的元数据信息是否正确。</p>
<p>例如解析 <code>OVER</code>、<code>WHERE</code>和<code>YIELD</code> 语句时，会查找 Schema 校验 Edge type、Tag 的信息是否存在，或者插入数据时校验插入的数据类型和 Schema 中的是否一致。</p>
</li>
<li><p>校验上下文引用信息</p>
<p>校验引用的变量是否存在或者引用的属性是否属于变量。</p>
<p>例如语句<code>$var = GO FROM &quot;Tim&quot; OVER like YIELD dst(edge) AS ID; GO FROM $var.ID OVER serve YIELD dst(edge)</code>，Validator 模块首先会检查变量 <code>var</code> 是否定义，其次再检查属性 <code>ID</code> 是否属于变量 <code>var</code>。</p>
</li>
<li><p>校验类型推断</p>
<p>推断表达式的结果类型，并根据子句校验类型是否正确。</p>
<p>例如 <code>WHERE</code> 子句要求结果是 <code>bool</code>、<code>null</code> 或者 <code>empty</code>。</p>
</li>
<li><p>校验<code>*</code>代表的信息</p>
<p>查询语句中包含 <code>*</code> 时，校验子句时需要将 <code>*</code> 涉及的 Schema 都进行校验。</p>
<p>例如语句<code>GO FROM &quot;Tim&quot; OVER * YIELD dst(edge), properties(edge).likeness, dst(edge)</code>，校验<code>OVER</code>子句时需要校验所有的 Edge type，如果 Edge type 包含 <code>like</code>和<code>serve</code>，该语句会展开为<code>GO FROM &quot;Tim&quot; OVER like,serve YIELD dst(edge), properties(edge).likeness, dst(edge)</code>。</p>
</li>
<li><p>校验输入输出</p>
<p>校验管道符（|）前后的一致性。</p>
<p>例如语句<code>GO FROM &quot;Tim&quot; OVER like YIELD dst(edge) AS ID | GO FROM $-.ID OVER serve YIELD dst(edge)</code>，Validator 模块会校验 <code>$-.ID</code> 在管道符左侧是否已经定义。</p>
</li>
</ul>
</li>
<li><p>校验完成后，Validator 模块还会生成一个默认可执行，但是未进行优化的执行计划，存储在目录 <code>src/planner</code> 内。</p>
</li>
</ul>
</li>
<li><p><strong>Planner</strong>：执行计划与优化器模块。</p>
<ul>
<li><p>如果配置文件 <code>nebula-graphd.conf</code> 中 <code>enable_optimizer</code> 设置为 <code>false</code>，Planner 模块不会优化 Validator 模块生成的执行计划，而是直接交给 Executor 模块执行。</p>
</li>
<li><p>如果配置文件 <code>nebula-graphd.conf</code>中<code>enable_optimizer</code> 设置为 <code>true</code>，Planner 模块会对 Validator 模块生成的执行计划进行优化。如下图所示。</p>
<p><img src="/2022/12/28/%E6%95%B0%E6%8D%AE%E5%BA%93/NebulaGraph/NebulaGraph%E5%85%A5%E9%97%A8/image-20230103110458088.png" srcset="/img/loading.gif" lazyload alt="image-20230103110458088"></p>
</li>
</ul>
</li>
<li><p><strong>Executor</strong>：执行引擎模块。</p>
<ul>
<li><p>Executor 模块包含调度器（Scheduler）和执行器（Executor），通过调度器调度执行计划，让执行器根据执行计划，<strong>从叶子节点开始执行，直到根节点结束</strong>。如下图所示。</p>
<p><img src="/2022/12/28/%E6%95%B0%E6%8D%AE%E5%BA%93/NebulaGraph/NebulaGraph%E5%85%A5%E9%97%A8/image-20230103110821463.png" srcset="/img/loading.gif" lazyload alt="image-20230103110821463"></p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="1-5-4-Storage服务"><a href="#1-5-4-Storage服务" class="headerlink" title="1.5.4 Storage服务"></a>1.5.4 Storage服务</h3><p>NebulaGraph的存储包含两个部分，一个是 Meta 相关的存储，称为 Meta 服务。另一个是具体数据相关的存储，称为 Storage 服务。其运行在 nebula-storaged 进程中。</p>
<p><img src="/2022/12/28/%E6%95%B0%E6%8D%AE%E5%BA%93/NebulaGraph/NebulaGraph%E5%85%A5%E9%97%A8/image-20230103140643987.png" srcset="/img/loading.gif" lazyload alt="image-20230103140643987"></p>
<p>Storage 服务是由 nebula-storaged 进程提供的，用户可以根据场景配置 nebula-storaged 进程数量，例如测试环境 1 个，生产环境 3 个。</p>
<p>所有 nebula-storaged 进程构成了基于 Raft 协议的集群，整个服务架构可以分为三层，从上到下依次为：</p>
<ul>
<li><p>Storage interface 层</p>
<p>Storage 服务的最上层，定义了一系列和图相关的 API。API 请求会在这一层被翻译成一组针对分片的 KV 操作，例如：</p>
<ul>
<li><p><code>getNeighbors</code>：查询一批点的出边或者入边，返回边以及对应的属性，并且支持条件过滤。</p>
</li>
<li><p><code>insert vertex/edge</code>：插入一条点或者边及其属性。</p>
</li>
<li><p><code>getProps</code>：获取一个点或者一条边的属性。</p>
</li>
</ul>
<p>正是这一层的存在，使得 Storage 服务变成了真正的图存储，否则 Storage 服务只是一个 KV 存储服务。</p>
</li>
<li><p>Consensus 层</p>
<p>Storage 服务的中间层，实现了 Multi Group Raft，保证强一致性和高可用性。</p>
<p>由于 Storage 服务需要支持集群分布式架构，所以基于 Raft 协议实现了 Multi Group Raft，即每个分片的所有副本共同组成一个 Raft group，其中一个副本是 leader，其他副本是 follower。</p>
</li>
<li><p>Store Engine 层</p>
<p>Storage 服务的最底层，是一个单机版本地存储引擎，提供对本地数据的<code>get</code>、<code>put</code>、<code>scan</code>等操作。相关接口存储在<code>KVStore.h</code>和<code>KVEngine.h</code>文件，用户可以根据业务需求定制开发相关的本地存储插件。</p>
</li>
</ul>
<h4 id="Storage-写入流程"><a href="#Storage-写入流程" class="headerlink" title="Storage 写入流程"></a>Storage 写入流程</h4><p><img src="/2022/12/28/%E6%95%B0%E6%8D%AE%E5%BA%93/NebulaGraph/NebulaGraph%E5%85%A5%E9%97%A8/image-20230103141407994.png" srcset="/img/loading.gif" lazyload alt="image-20230103141407994"></p>
<h4 id="数据存储格式"><a href="#数据存储格式" class="headerlink" title="数据存储格式"></a>数据存储格式</h4><p>图存储的主要数据是点和边，NebulaGraph 将点和边的信息存储为 key，同时将点和边的属性信息存储在 value 中，以便更高效地使用属性过滤。</p>
<h5 id="点数据存储格式"><a href="#点数据存储格式" class="headerlink" title="点数据存储格式"></a>点数据存储格式</h5><p>相比 NebulaGraph 2.x 版本，3.x 版本在开启<strong>无 Tag</strong> 的点配置后，每个点多了一个不含 TagID 字段并且无 value 的 key。</p>
<p><img src="/2022/12/28/%E6%95%B0%E6%8D%AE%E5%BA%93/NebulaGraph/NebulaGraph%E5%85%A5%E9%97%A8/image-20230103142138303.png" srcset="/img/loading.gif" lazyload alt="image-20230103142138303"></p>
<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>Type</code></td>
<td>key 类型。长度为 1 字节。</td>
</tr>
<tr>
<td><code>PartID</code></td>
<td>数据分片编号。长度为 3 字节。此字段主要用于 Storage 负载均衡（balance）时方便根据前缀扫描整个分片的数据。</td>
</tr>
<tr>
<td><code>VertexID</code></td>
<td>点 ID。当点 ID 类型为 int 时，长度为 8 字节；当点 ID 类型为 string 时，长度为创建图空间时指定的<code>fixed_string</code>长度。</td>
</tr>
<tr>
<td><code>TagID</code></td>
<td>点关联的 Tag ID。长度为 4 字节。</td>
</tr>
<tr>
<td><code>SerializedValue</code></td>
<td>序列化的 value，用于保存点的属性信息。</td>
</tr>
</tbody></table>
<h5 id="边数据存储格式"><a href="#边数据存储格式" class="headerlink" title="边数据存储格式"></a>边数据存储格式</h5><p><img src="/2022/12/28/%E6%95%B0%E6%8D%AE%E5%BA%93/NebulaGraph/NebulaGraph%E5%85%A5%E9%97%A8/image-20230103142305332.png" srcset="/img/loading.gif" lazyload alt="image-20230103142305332"></p>
<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>Type</code></td>
<td>key 类型。长度为 1 字节。</td>
</tr>
<tr>
<td><code>PartID</code></td>
<td>数据分片编号。长度为 3 字节。此字段主要用于 Storage 负载均衡（balance）时方便根据前缀扫描整个分片的数据。</td>
</tr>
<tr>
<td><code>VertexID</code></td>
<td>点 ID。前一个<code>VertexID</code>在出边里表示起始点 ID，在入边里表示目的点 ID；后一个<code>VertexID</code>出边里表示目的点 ID，在入边里表示起始点 ID。</td>
</tr>
<tr>
<td><code>Edge type</code></td>
<td>边的类型。大于 0 表示出边，小于 0 表示入边。长度为 4 字节。</td>
</tr>
<tr>
<td><code>Rank</code></td>
<td>用来处理两点之间有多个同类型边的情况。用户可以根据自己的需求进行设置，例如存放交易时间、交易流水号等。长度为 8 字节，</td>
</tr>
<tr>
<td><code>PlaceHolder</code></td>
<td>预留字段。长度为 1 字节。</td>
</tr>
<tr>
<td><code>SerializedValue</code></td>
<td>序列化的 value，用于保存边的属性信息。</td>
</tr>
</tbody></table>
<blockquote>
<p>四元组 <code>&lt;起点 VID、Edge type、边排序值 (rank)、终点 VID&gt;</code> 用于唯一标识一条边。</p>
</blockquote>
<h4 id="数据分片"><a href="#数据分片" class="headerlink" title="数据分片"></a>数据分片</h4><p>由于超大规模关系网络的节点数量高达百亿到千亿，而边的数量更会高达万亿，即使仅存储点和边两者也远大于一般服务器的容量。因此需要有方法将图元素切割，并存储在不同逻辑分片（Partition）上。NebulaGraph 采用<strong>边分割</strong>的方式。</p>
<p><img src="/2022/12/28/%E6%95%B0%E6%8D%AE%E5%BA%93/NebulaGraph/NebulaGraph%E5%85%A5%E9%97%A8/image-20230103144124276.png" srcset="/img/loading.gif" lazyload alt="image-20230103144124276"></p>
<h5 id="切边与存储放大"><a href="#切边与存储放大" class="headerlink" title="切边与存储放大"></a>切边与存储放大</h5><p>NebulaGraph 中逻辑上的一条边对应着硬盘上的两个键值对，在边的数量和属性较多时，存储放大现象较明显。边的存储方式如下图所示。<img src="/2022/12/28/%E6%95%B0%E6%8D%AE%E5%BA%93/NebulaGraph/NebulaGraph%E5%85%A5%E9%97%A8/image-20230103144337604.png" srcset="/img/loading.gif" lazyload alt="image-20230103144337604"></p>
<p>上图以最简单的两个点和一条边为例，起点 SrcVertex 通过边 EdgeA 连接目的点 DstVertex，形成路径<code>(SrcVertex)-[EdgeA]-&gt;(DstVertex)</code>。这两个点和一条边会以 4 个键值对的形式保存在存储层的两个不同分片，即 Partition x 和 Partition y 中，详细说明如下：</p>
<ul>
<li><p>点 SrcVertex 的键值保存在 Partition x 中。</p>
</li>
<li><p>边 EdgeA 的第一份键值，这里用 EdgeA_Out 表示，与 SrcVertex 一同保存在 Partition x 中。key 的字段有 Type、PartID（x）、VID（Src，即点 SrcVertex 的 ID）、EdgeType（符号为正，代表边方向为出）、Rank（0）、VID（Dst，即点 DstVertex 的 ID）和 PlaceHolder。SerializedValue 即 Value，是序列化的边属性。</p>
</li>
<li><p>点 DstVertex 的键值保存在 Partition y 中。</p>
</li>
<li><p>边 EdgeA 的第二份键值，这里用 EdgeA_In 表示，与 DstVertex 一同保存在 Partition y 中。key 的字段有 Type、PartID（y）、VID（Dst，即点 DstVertex 的 ID）、EdgeType（符号为负，代表边方向为入）、Rank（0）、VID（Src，即点 SrcVertex 的 ID）和 PlaceHolder。SerializedValue 即 Value，是序列化的边属性，与 EdgeA_Out 中该部分的完全相同。</p>
</li>
</ul>
<p>EdgeA_Out 和 EdgeA_In 以方向相反的两条边的形式存在于存储层，二者组合成了逻辑上的一条边 EdgeA。EdgeA_Out 用于从起点开始的遍历请求，例如<code>(a)-[]-&gt;()</code>；EdgeA_In 用于指向目的点的遍历请求，或者说从目的点开始，沿着边的方向逆序进行的遍历请求，例如例如<code>()-[]-&gt;(a)</code>。</p>
<p>如 EdgeA_Out 和 EdgeA_In 一样，NebulaGraph 冗余了存储每条边的信息，导致存储边所需的实际空间翻倍。因为边对应的 key 占用的硬盘空间较小，但 value 占用的空间与属性值的长度和数量成正比，所以，当边的属性值较大或数量较多时候，硬盘空间占用量会比较大。</p>
<p>如果对边进行操作，为了保证两个键值对的最终一致性，可以开启 TOSS 功能（开启后会增加相关操作的时延约 1 倍），开启后，会先在正向边所在的分片进行操作，然后在反向边所在分片进行操作，最后返回结果。</p>
<h5 id="分片算法"><a href="#分片算法" class="headerlink" title="分片算法"></a>分片算法</h5><p>分片策略采用<strong>静态 Hash</strong> 的方式，即对点 VID 进行取模操作，同一个点的所有 Tag、出边和入边信息都会存储到同一个分片，这种方式极大地提升了查询效率。</p>
<blockquote>
<p>创建图空间时需指定分片数量，分片数量设置后无法修改，设置时提前满足业务将来的扩容需求。</p>
<p>多机集群部署时，分片分布在集群内的不同机器上。分片数量在 CREATE SPACE 语句中指定，此后不可更改。</p>
</blockquote>
<hr>
<h1 id="二、安装部署"><a href="#二、安装部署" class="headerlink" title="二、安装部署"></a>二、安装部署</h1><h2 id="2-1-本地部署"><a href="#2-1-本地部署" class="headerlink" title="2.1 本地部署"></a>2.1 本地部署</h2><p><strong>基本流程</strong></p>
<p><img src="/2022/12/28/%E6%95%B0%E6%8D%AE%E5%BA%93/NebulaGraph/NebulaGraph%E5%85%A5%E9%97%A8/image-20221229220054976.png" srcset="/img/loading.gif" lazyload alt="image-20221229220054976"></p>
<h3 id="2-1-1-安装-NebulaGraph"><a href="#2-1-1-安装-NebulaGraph" class="headerlink" title="2.1.1 安装 NebulaGraph"></a>2.1.1 安装 NebulaGraph</h3><ul>
<li>当前仅支持在 Linux 系统下安装 NebulaGraph，且仅支持 CentOS 7.x、CentOS 8.x、Ubuntu 16.04、Ubuntu 18.04、Ubuntu 20.04 操作系统。</li>
</ul>
<p>以CentOS7为例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir /software<br>cd /software<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> 下载</span><br>wget https://oss-cdn.nebula-graph.com.cn/package/3.3.0/nebula-graph-3.3.0.el7.x86_64.rpm<br><span class="hljs-meta">#</span><span class="bash"> 安装 RPM 包</span><br>sudo rpm -ivh nebula-graph-3.3.0.el7.x86_64.rpm<br></code></pre></td></tr></table></figure>

<p><img src="/2022/12/28/%E6%95%B0%E6%8D%AE%E5%BA%93/NebulaGraph/NebulaGraph%E5%85%A5%E9%97%A8/image-20221229220448267.png" srcset="/img/loading.gif" lazyload alt="image-20221229220448267"></p>
<h3 id="2-1-2-启动-NebulaGraph-服务"><a href="#2-1-2-启动-NebulaGraph-服务" class="headerlink" title="2.1.2 启动 NebulaGraph 服务"></a>2.1.2 启动 NebulaGraph 服务</h3><ul>
<li>NebulaGraph 支持通过脚本管理服务。</li>
</ul>
<p>使用脚本<code>nebula.service</code>管理服务，包括启动、停止、重启、中止和查看。（<code>nebula.service</code>的默认路径是<code>/usr/local/nebula/scripts</code>，如果修改过安装路径，请使用实际路径。）</p>
<ul>
<li><p>语法</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> sudo /usr/<span class="hljs-built_in">local</span>/nebula/scripts/nebula.service</span><br>[-v] [-c &lt;config_file_path&gt;]<br>&lt;start | stop | restart | kill | status&gt;<br>&lt;metad | graphd | storaged | all&gt;<br></code></pre></td></tr></table></figure></li>
<li><p>参数</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>-v</code></td>
<td>显示详细调试信息。</td>
</tr>
<tr>
<td><code>-c</code></td>
<td>指定配置文件路径，默认路径为<code>/usr/local/nebula/etc/</code>。</td>
</tr>
<tr>
<td><code>start</code></td>
<td>启动服务。</td>
</tr>
<tr>
<td><code>stop</code></td>
<td>停止服务。</td>
</tr>
<tr>
<td><code>restart</code></td>
<td>重启服务。</td>
</tr>
<tr>
<td><code>kill</code></td>
<td>中止服务。</td>
</tr>
<tr>
<td><code>status</code></td>
<td>查看服务状态。</td>
</tr>
<tr>
<td><code>metad</code></td>
<td>管理 Meta 服务。</td>
</tr>
<tr>
<td><code>graphd</code></td>
<td>管理 Graph 服务。</td>
</tr>
<tr>
<td><code>storaged</code></td>
<td>管理 Storage 服务。</td>
</tr>
<tr>
<td><code>all</code></td>
<td>管理所有服务。</td>
</tr>
</tbody></table>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 启动 NebulaGraph 服务</span><br>/usr/local/nebula/scripts/nebula.service start all<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> 停止 NebulaGraph 服务</span><br>/usr/local/nebula/scripts/nebula.service stop all<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> 查看 NebulaGraph 服务</span><br>/usr/local/nebula/scripts/nebula.service status all<br></code></pre></td></tr></table></figure>

<p><img src="/2022/12/28/%E6%95%B0%E6%8D%AE%E5%BA%93/NebulaGraph/NebulaGraph%E5%85%A5%E9%97%A8/image-20221229220724975.png" srcset="/img/loading.gif" lazyload alt="image-20221229220724975"></p>
<p><img src="/2022/12/28/%E6%95%B0%E6%8D%AE%E5%BA%93/NebulaGraph/NebulaGraph%E5%85%A5%E9%97%A8/image-20221229220841715.png" srcset="/img/loading.gif" lazyload alt="image-20221229220841715"></p>
<blockquote>
<p>正常启动 NebulaGraph 后，<code>nebula-storaged</code>进程的端口显示红色。这是因为<code>nebula-storaged</code>在启动流程中会等待<code>nebula-metad</code>添加当前 Storage 服务，当前 Storage 服务收到 Ready 信号后才会正式启动服务。从 3.0.0 版本开始，在配置文件中添加的 Storage 节点无法直接读写，配置文件的作用仅仅是将 Storage 节点注册至 Meta 服务中。必须使用<code>ADD HOSTS</code>命令后，才能正常读写 Storage 节点。</p>
</blockquote>
<h3 id="2-1-3-连接-NebulaGraph"><a href="#2-1-3-连接-NebulaGraph" class="headerlink" title="2.1.3 连接 NebulaGraph"></a>2.1.3 连接 NebulaGraph</h3><blockquote>
<p>NebulaGraph 支持多种类型的客户端，包括命令行客户端、可视化界面客户端和流行编程语言客户端，此处使用原生命令行客户端 Nebula Console 连接。</p>
<p>首次连接到 NebulaGraph 后，必须先[注册 Storage 服务，才能正常查询数据。</p>
</blockquote>
<ul>
<li>建立连接的前提：<ul>
<li>NebulaGraph 服务已启动。</li>
<li>运行 Nebula Console 的机器和运行 NebulaGraph 的服务器网络互通。</li>
<li>Nebula Console 的版本兼容 NebulaGraph 的版本。</li>
</ul>
</li>
</ul>
<ul>
<li>操作步骤</li>
</ul>
<ol>
<li><p>在 Nebula Console <a target="_blank" rel="noopener" href="https://github.com/vesoft-inc/nebula-console/releases">下载页面</a>，确认需要的版本，单击 <strong>Assets</strong>。</p>
</li>
<li><p>在 <strong>Assets</strong> 区域找到机器运行所需的二进制文件，下载文件到机器上。</p>
</li>
<li><p>（可选）为方便使用，重命名文件为<code>nebula-console</code>。（在 Windows 系统中，请重命名为<code>nebula-console.exe</code>。）</p>
</li>
<li><p>在运行 Nebula Console 的机器上执行如下命令，为用户授予 nebula-console 文件的执行权限。（Windows 系统请跳过此步骤。）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">chmod 111 nebula-console<br></code></pre></td></tr></table></figure></li>
<li><p>在命令行界面中，切换工作目录至 nebula-console 文件所在目录。</p>
</li>
<li><p>执行如下命令连接 NebulaGraph。</p>
<ul>
<li><p>Linux 或 macOS</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">./nebula-console -addr &lt;ip&gt; -port &lt;port&gt; -u &lt;username&gt; -p &lt;password&gt;<br>  [-t 120] [-e &quot;nGQL_statement&quot; | -f filename.nGQL]<br></code></pre></td></tr></table></figure></li>
<li><p>Windows</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">nebula-console.exe -addr &lt;ip&gt; -port &lt;port&gt; -u &lt;username&gt; -p &lt;password&gt;<br>  [-t 120] [-e &quot;nGQL_statement&quot; | -f filename.nGQL]<br></code></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">nebula-console.exe -addr 192.168.48.128  -port 9669 -u root -p root<br></code></pre></td></tr></table></figure></li>
</ul>
<p>参数说明如下：</p>
<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>-h/-help</code></td>
<td align="left">显示帮助菜单。</td>
</tr>
<tr>
<td align="left"><code>-addr/-address</code></td>
<td align="left">设置要连接的 Graph 服务的 IP 地址。默认地址为 127.0.0.1。</td>
</tr>
<tr>
<td align="left"><code>-P/-port</code></td>
<td align="left">设置要连接的 Graph 服务的端口。默认端口为 9669。</td>
</tr>
<tr>
<td align="left"><code>-u/-user</code></td>
<td align="left">设置 NebulaGraph 账号的用户名。未启用身份认证时，可以使用任意已存在的用户名（默认为<code>root</code>）。</td>
</tr>
<tr>
<td align="left"><code>-p/-password</code></td>
<td align="left">设置用户名对应的密码。未启用身份认证时，密码可以填写任意字符。</td>
</tr>
<tr>
<td align="left"><code>-t/-timeout</code></td>
<td align="left">设置整数类型的连接超时时间。单位为秒，默认值为 120。</td>
</tr>
<tr>
<td align="left"><code>-e/-eval</code></td>
<td align="left">设置字符串类型的 nGQL 语句。连接成功后会执行一次该语句并返回结果，然后自动断开连接。</td>
</tr>
<tr>
<td align="left"><code>-f/-file</code></td>
<td align="left">设置存储 nGQL 语句的文件的路径。连接成功后会执行该文件内的 nGQL 语句并返回结果，执行完毕后自动断开连接。</td>
</tr>
<tr>
<td align="left"><code>-enable_ssl</code></td>
<td align="left">连接 NebulaGraph 时使用 SSL 加密。</td>
</tr>
<tr>
<td align="left"><code>-ssl_root_ca_path</code></td>
<td align="left">指定 CA 证书的存储路径。</td>
</tr>
<tr>
<td align="left"><code>-ssl_cert_path</code></td>
<td align="left">指定 CRT 证书的存储路径。</td>
</tr>
<tr>
<td align="left"><code>-ssl_private_key_path</code></td>
<td align="left">指定私钥文件的存储路径。</td>
</tr>
</tbody></table>
</li>
</ol>
<p><img src="/2022/12/28/%E6%95%B0%E6%8D%AE%E5%BA%93/NebulaGraph/NebulaGraph%E5%85%A5%E9%97%A8/image-20221229222523195.png" srcset="/img/loading.gif" lazyload alt="image-20221229222523195"></p>
<h3 id="2-1-4-注册-Storage-服务"><a href="#2-1-4-注册-Storage-服务" class="headerlink" title="2.1.4 注册 Storage 服务"></a>2.1.4 注册 Storage 服务</h3><blockquote>
<p>首次连接到 NebulaGraph 后，需要先添加 Storage 主机，并确认主机都处于在线状态。</p>
</blockquote>
<ul>
<li>前提条件：<ul>
<li>已连接 NebulaGraph 服务。</li>
</ul>
</li>
</ul>
<ul>
<li>操作步骤：</li>
</ul>
<ol>
<li><p>添加 Storage 主机。</p>
<p>执行如下命令添加主机：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elixir">ADD HOSTS &lt;ip&gt;<span class="hljs-symbol">:&lt;port&gt;</span> [,&lt;ip&gt;<span class="hljs-symbol">:&lt;port&gt;</span> ...];<br></code></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">ADD</span> HOSTS <span class="hljs-number">192.168.48.128:9779</span><br></code></pre></td></tr></table></figure>

<p>请确保添加的主机 IP 和配置文件<code>nebula-storaged.conf</code>中<code>local_ip</code>配置的 IP 一致，否则会导致添加 Storage 主机失败。</p>
<p><img src="/2022/12/28/%E6%95%B0%E6%8D%AE%E5%BA%93/NebulaGraph/NebulaGraph%E5%85%A5%E9%97%A8/image-20230103151931510.png" srcset="/img/loading.gif" lazyload alt="image-20230103151931510"></p>
</li>
<li><p>检查主机状态，确认是否在线。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">show</span> hosts;<br></code></pre></td></tr></table></figure>

<p><img src="/2022/12/28/%E6%95%B0%E6%8D%AE%E5%BA%93/NebulaGraph/NebulaGraph%E5%85%A5%E9%97%A8/image-20230103152014520.png" srcset="/img/loading.gif" lazyload alt="image-20230103152014520"></p>
<p>在返回结果的 <strong>Status</strong> 列，可以看到 Storage 主机离线。</p>
</li>
<li><p>重启nebulaGraph</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">/usr/local/nebula/scripts/nebula.service restart all<br></code></pre></td></tr></table></figure>

<p><img src="/2022/12/28/%E6%95%B0%E6%8D%AE%E5%BA%93/NebulaGraph/NebulaGraph%E5%85%A5%E9%97%A8/image-20230103152438718.png" srcset="/img/loading.gif" lazyload alt="image-20230103152438718"></p>
</li>
<li><p>检查主机状态，确认全部在线。</p>
</li>
</ol>
<p><img src="/2022/12/28/%E6%95%B0%E6%8D%AE%E5%BA%93/NebulaGraph/NebulaGraph%E5%85%A5%E9%97%A8/image-20230103152725732.png" srcset="/img/loading.gif" lazyload alt="image-20230103152725732"></p>
<h1 id="三、nGQL"><a href="#三、nGQL" class="headerlink" title="三、nGQL"></a>三、nGQL</h1><h2 id="3-1-概述"><a href="#3-1-概述" class="headerlink" title="3.1 概述"></a>3.1 概述</h2><p>nGQL（NebulaGraph Query Language）是 NebulaGraph 使用的的声明式图查询语言，支持灵活高效的<strong>图模式</strong>，其主要功能包括：</p>
<ul>
<li>支持图遍历</li>
<li>支持模式匹配</li>
<li>支持聚合</li>
<li>支持修改图</li>
<li>支持访问控制</li>
<li>支持聚合查询</li>
<li>支持索引</li>
<li>支持大部分 openCypher 9 图查询语法（不支持修改和控制语法）</li>
</ul>
<h3 id="3-1-1-占位符标识符和占位符值"><a href="#3-1-1-占位符标识符和占位符值" class="headerlink" title="3.1.1 占位符标识符和占位符值"></a>3.1.1 占位符标识符和占位符值</h3><p>在模板代码中，任何非关键字、字面值或标点符号的标记都是占位符标识符或占位符值。</p>
<table>
<thead>
<tr>
<th align="left">符号</th>
<th align="left">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="left">&lt; &gt;</td>
<td align="left">语法元素的名称。</td>
</tr>
<tr>
<td align="left">:</td>
<td align="left">定义元素的公式。</td>
</tr>
<tr>
<td align="left">[ ]</td>
<td align="left">可选元素。</td>
</tr>
<tr>
<td align="left">{ }</td>
<td align="left">显式的指定元素。</td>
</tr>
<tr>
<td align="left">|</td>
<td align="left">所有可选的元素。</td>
</tr>
<tr>
<td align="left">…</td>
<td align="left">可以重复多次。</td>
</tr>
</tbody></table>
<h3 id="3-1-2-注释"><a href="#3-1-2-注释" class="headerlink" title="3.1.2 注释"></a>3.1.2 注释</h3><ul>
<li>NebulaGraph 2.x 支持三种注释方式：<code>#</code>、<code>//</code>、<code>/* */</code>。</li>
</ul>
<p>示例：</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs gauss">nebula&gt; <span class="hljs-meta"># 这行什么都不做。</span><br>nebula&gt; <span class="hljs-keyword">RETURN</span> <span class="hljs-number">1</span>+<span class="hljs-number">1</span>;     <span class="hljs-meta"># 这条注释延续到行尾。</span><br>nebula&gt; <span class="hljs-keyword">RETURN</span> <span class="hljs-number">1</span>+<span class="hljs-number">1</span>;     <span class="hljs-comment">// 这条注释延续到行尾。</span><br>nebula&gt; <span class="hljs-keyword">RETURN</span> <span class="hljs-number">1</span> <span class="hljs-comment">/* 这是一条行内注释 */</span> + <span class="hljs-number">1</span> == <span class="hljs-number">2</span>;<br>nebula&gt; <span class="hljs-keyword">RETURN</span> <span class="hljs-number">11</span> +            \<br><span class="hljs-comment">/* 多行注释       \</span><br><span class="hljs-comment">用反斜线来换行。   \</span><br><span class="hljs-comment">*/</span> <span class="hljs-number">12</span>;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>nGQL 语句中的反斜线（\）代表换行。</p>
</blockquote>
<h3 id="3-1-3-大小写区分"><a href="#3-1-3-大小写区分" class="headerlink" title="3.1.3 大小写区分"></a>3.1.3 大小写区分</h3><ul>
<li><p>标识符区分大小写</p>
</li>
<li><p>关键字不区分大小写</p>
</li>
<li><p>函数不区分大小写</p>
</li>
</ul>
<h3 id="3-1-4-关键字"><a href="#3-1-4-关键字" class="headerlink" title="3.1.4 关键字"></a>3.1.4 关键字</h3><p>关键字，分为保留关键字和非保留关键字。建议不要在 Schema 中使用关键字。</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey">如果必须使用关键字：<br><br>- 非保留关键字作为标识符时可以不使用引号。<br><br>- 保留关键字或特殊字符作为标识符时，需要用反引号（`）包围，例如 `AND`。<br></code></pre></td></tr></table></figure>

<ul>
<li>保留关键字</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><code class="hljs shell">ACROSS<br>ADD<br>ALTER<br>AND<br>AS<br>ASC<br>ASCENDING<br>BALANCE<br>BOOL<br>BY<br>CASE<br>CHANGE<br>COMPACT<br>CREATE<br>DATE<br>DATETIME<br>DELETE<br>DESC<br>DESCENDING<br>DESCRIBE<br>DISTINCT<br>DOUBLE<br>DOWNLOAD<br>DROP<br>EDGE<br>EDGES<br>EXISTS<br>EXPLAIN<br>FETCH<br>FIND<br>FIXED_STRING<br>FLOAT<br>FLUSH<br>FORMAT<br>FROM<br>GET<br>GO<br>GRANT<br>IF<br>IGNORE_EXISTED_INDEX<br>IN<br>INDEX<br>INDEXES<br>INGEST<br>INSERT<br>INT<br>INT16<br>INT32<br>INT64<br>INT8<br>INTERSECT<br>IS<br>LIMIT<br>LIST<br>LOOKUP<br>MAP<br>MATCH<br>MINUS<br>NO<br>NOT<br>NOT_IN<br>NULL<br>OF<br>OFFSET<br>ON<br>OR<br>ORDER<br>OVER<br>OVERWRITE<br>PROFILE<br>PROP<br>REBUILD<br>RECOVER<br>REMOVE<br>RESTART<br>RETURN<br>REVERSELY<br>REVOKE<br>SET<br>SHOW<br>STEP<br>STEPS<br>STOP<br>STRING<br>SUBMIT<br>TAG<br>TAGS<br>TIME<br>TIMESTAMP<br>TO<br>UNION<br>UPDATE<br>UPSERT<br>UPTO<br>USE<br>VERTEX<br>VERTICES<br>WHEN<br>WHERE<br>WITH<br>XOR<br>YIELD<br></code></pre></td></tr></table></figure>

<ul>
<li>非保留关键字</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><code class="hljs shell">ACCOUNT<br>ADMIN<br>ALL<br>ANY<br>ATOMIC_EDGE<br>AUTO<br>BIDIRECT<br>BOTH<br>CHARSET<br>CLIENTS<br>COLLATE<br>COLLATION<br>COMMENT<br>CONFIGS<br>CONTAINS<br>DATA<br>DBA<br>DEFAULT<br>ELASTICSEARCH<br>ELSE<br>END<br>ENDS<br>ENDS_WITH<br>FORCE<br>FULLTEXT<br>FUZZY<br>GOD<br>GRAPH<br>GROUP<br>GROUPS<br>GUEST<br>HDFS<br>HOST<br>HOSTS<br>INTO<br>IS_EMPTY<br>IS_NOT_EMPTY<br>IS_NOT_NULL<br>IS_NULL<br>JOB<br>JOBS<br>KILL<br>LEADER<br>LISTENER<br>META<br>NOLOOP<br>NONE<br>NOT_CONTAINS<br>NOT_ENDS_WITH<br>NOT_STARTS_WITH<br>OPTIONAL<br>OUT<br>PART<br>PARTITION_NUM<br>PARTS<br>PASSWORD<br>PATH<br>PLAN<br>PREFIX<br>QUERIES<br>QUERY<br>REDUCE<br>REGEXP<br>REPLICA_FACTOR<br>RESET<br>ROLE<br>ROLES<br>SAMPLE<br>SEARCH<br>SERVICE<br>SESSION<br>SESSIONS<br>SHORTEST<br>SIGN<br>SINGLE<br>SKIP<br>SNAPSHOT<br>SNAPSHOTS<br>SPACE<br>SPACES<br>STARTS<br>STARTS_WITH<br>STATS<br>STATUS<br>STORAGE<br>SUBGRAPH<br>TEXT<br>TEXT_SEARCH<br>THEN<br>TOP<br>TTL_COL<br>TTL_DURATION<br>UNWIND<br>USER<br>USERS<br>UUID<br>VALUE<br>VALUES<br>VID_TYPE<br>WILDCARD<br>ZONE<br>ZONES<br>FALSE<br>TRUE<br></code></pre></td></tr></table></figure>



<h3 id="3-1-5-数据类型"><a href="#3-1-5-数据类型" class="headerlink" title="3.1.5 数据类型"></a>3.1.5 数据类型</h3><p>NebulaGraph 支持显式地转换类型。</p>
<ul>
<li>nGQL 支持整数和浮点数。</li>
</ul>
<h4 id="整数"><a href="#整数" class="headerlink" title="整数"></a>整数</h4><p>nGQL 支持带符号的 64 位整数（INT64）、32 位整数（INT32）、16 位整数（INT16）和 8 位整数（INT8）。</p>
<table>
<thead>
<tr>
<th align="left">类型</th>
<th align="left">声明关键字</th>
<th align="left">范围</th>
</tr>
</thead>
<tbody><tr>
<td align="left">INT64</td>
<td align="left"><code>INT64</code>或<code>INT</code></td>
<td align="left">-9,223,372,036,854,775,808 ~ 9,223,372,036,854,775,807</td>
</tr>
<tr>
<td align="left">INT32</td>
<td align="left"><code>INT32</code></td>
<td align="left">-2,147,483,648 ~ 2,147,483,647</td>
</tr>
<tr>
<td align="left">INT16</td>
<td align="left"><code>INT16</code></td>
<td align="left">-32,768 ~ 32,767</td>
</tr>
<tr>
<td align="left">INT8</td>
<td align="left"><code>INT8</code></td>
<td align="left">-128 ~ 127</td>
</tr>
</tbody></table>
<h4 id="浮点数"><a href="#浮点数" class="headerlink" title="浮点数"></a>浮点数</h4><p>nGQL 支持单精度浮点（FLOAT）和双精度浮点（DOUBLE）。</p>
<table>
<thead>
<tr>
<th align="left">类型</th>
<th align="left">声明关键字</th>
<th align="left">范围</th>
<th align="left">精度</th>
</tr>
</thead>
<tbody><tr>
<td align="left">FLOAT</td>
<td align="left"><code>FLOAT</code></td>
<td align="left">3.4E +/- 38</td>
<td align="left">6~7 位</td>
</tr>
<tr>
<td align="left">DOUBLE</td>
<td align="left"><code>DOUBLE</code></td>
<td align="left">1.7E +/- 308</td>
<td align="left">15~16 位</td>
</tr>
</tbody></table>
<p>nGQL 支持科学计数法，例如<code>1e2</code>、<code>1.1e2</code>、<code>.3e4</code>、<code>1.e4</code>、<code>-1234E-10</code>。但不支持 MySQL 中的 DECIMAL 数据类型。</p>
<h4 id="数值的读写"><a href="#数值的读写" class="headerlink" title="数值的读写"></a>数值的读写</h4><p>在写入和读取不同类型的数据时，nGQL 的行为遵守以下规则：</p>
<table>
<thead>
<tr>
<th align="left">数值类型</th>
<th align="left">设置为 VID</th>
<th align="left">设置为属性类型</th>
<th align="left">读取该类型的属性值得到的类型</th>
</tr>
</thead>
<tbody><tr>
<td align="left">INT64</td>
<td align="left">支持</td>
<td align="left">支持</td>
<td align="left">INT64</td>
</tr>
<tr>
<td align="left">INT32</td>
<td align="left">不支持</td>
<td align="left">支持</td>
<td align="left">INT64</td>
</tr>
<tr>
<td align="left">INT16</td>
<td align="left">不支持</td>
<td align="left">支持</td>
<td align="left">INT64</td>
</tr>
<tr>
<td align="left">INT8</td>
<td align="left">不支持</td>
<td align="left">支持</td>
<td align="left">INT64</td>
</tr>
<tr>
<td align="left">FLOAT</td>
<td align="left">不支持</td>
<td align="left">支持</td>
<td align="left">DOUBLE</td>
</tr>
<tr>
<td align="left">DOUBLE</td>
<td align="left">不支持</td>
<td align="left">支持</td>
<td align="left">DOUBLE</td>
</tr>
</tbody></table>
<p>例如，nGQL 不支持设置 INT8 类型的 VID，但支持将 TAG 或 Edge type 的某个属性类型设置为 INT8。当使用 nGQL 语句读取 INT8 类型的属性时，获取到的值的类型为 INT64。</p>
<ul>
<li><p>NebulaGraph 支持写入多种进制的数值：</p>
<ul>
<li>十进制，例如<code>123456</code>。</li>
<li>十六进制，例如<code>0x1e240</code>。</li>
<li>八进制，例如<code>0361100</code>。</li>
</ul>
<p>但 NebulaGraph 会将写入的非十进制数值解析为十进制的值保存。读取到的值为十进制。</p>
<p>例如，属性<code>score</code>的类型为<code>INT</code>，通过 INSERT 语句为其赋值<code>0xb</code>，使用 FETCH 等语句查询该属性值获取到的结果是<code>11</code>，即将十六进制的<code>0xb</code>转换为十进制后的值。</p>
</li>
<li><p>将 FLOAT/DOUBLE 类型的数值插入 INT 类型的列，会将数值四舍五入取整。</p>
</li>
</ul>
<p>​    </p>
<h4 id="布尔"><a href="#布尔" class="headerlink" title="布尔"></a>布尔</h4><p>NebulaGraph 使用关键字<code>BOOL</code>声明布尔数据类型，可选值为<code>true</code>或<code>false</code>。</p>
<p>nGQL 支持以如下方式使用布尔值：</p>
<ul>
<li>将属性值的数据类型定义为布尔。</li>
<li>在<code>WHERE</code>子句中用布尔值作为判断条件</li>
</ul>
<h4 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h4><p>NebulaGraph 支持定长字符串和变长字符串。</p>
<h5 id="声明与表示方式"><a href="#声明与表示方式" class="headerlink" title="声明与表示方式"></a>声明与表示方式</h5><p>nGQL 中的字符串声明方式如下：</p>
<ul>
<li>使用关键字<code>STRING</code>声明变长字符串。</li>
<li>使用关键字<code>FIXED_STRING(&lt;length&gt;)</code>声明定长字符串，<code>&lt;length&gt;</code>为字符串长度，例如<code>FIXED_STRING(32)</code>。</li>
</ul>
<p>字符串的表示方式为用双引号或单引号包裹，例如<code>&quot;Hello, Cooper&quot;</code>或<code>&#39;Hello, Cooper&#39;</code>。</p>
<h5 id="字符串读写"><a href="#字符串读写" class="headerlink" title="字符串读写"></a>字符串读写</h5><p>nGQL 支持以如下方式使用字符串：</p>
<ul>
<li>将VID的数据类型定义为定长字符串。</li>
<li>将变长字符串设置为 Schema 名称，包括图空间、Tag、Edge type 和属性的名称。</li>
<li>将属性值的数据类型定义为定长或变长字符串。</li>
</ul>
<p>例如：</p>
<ul>
<li><p>将属性值的类型定义为定长字符串</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">nebula</span>&gt; CREATE TAG IF NOT EXISTS t<span class="hljs-number">1</span> (p<span class="hljs-number">1</span> FIXED_STRING(<span class="hljs-number">10</span>)); <br></code></pre></td></tr></table></figure></li>
<li><p>将属性值的类型定义为变长字符串</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">nebula&gt; CREATE <span class="hljs-keyword">TAG</span> <span class="hljs-title">IF</span> NOT EXISTS t2 (p2 <span class="hljs-keyword">STRING</span>); <br></code></pre></td></tr></table></figure></li>
</ul>
<p>如果尝试写入的定长字符串超出长度限制：</p>
<ul>
<li>当该定长字符串为属性值时，写入会成功，NebulaGraph 将截断字符串，仅存入符合长度限制的部分。</li>
<li>当该定长字符串为 VID 时，写入会失败，NebulaGraph 将报错。</li>
</ul>
<h5 id="转义字符"><a href="#转义字符" class="headerlink" title="转义字符"></a>转义字符</h5><p>字符串中不支持直接换行，可以使用转义字符实现，例如：</p>
<ul>
<li><p><code>&quot;\n\t\r\b\f&quot;</code></p>
</li>
<li><p><code>&quot;\110ello world&quot;</code></p>
</li>
</ul>
<h4 id="日期和时间类型"><a href="#日期和时间类型" class="headerlink" title="日期和时间类型"></a>日期和时间类型</h4><ul>
<li><p>日期和时间的类型，包括<code>DATE</code>、<code>TIME</code>、<code>DATETIME</code>、<code>TIMESTAMP</code>和<code>DURATION</code>。</p>
</li>
<li><p>在插入时间类型的属性值时，NebulaGraph 会根据配置文件中<code>timezone_name</code>参数指定的时区，将该<code>DATE</code>、<code>TIME</code>、<code>DATETIME</code>转换成相应的世界协调时间（UTC）时间。</p>
<blockquote>
<p>如需修改当前时区，请同时修改所有服务的配置文件中的<code>timezone_name</code>参数。</p>
</blockquote>
</li>
<li><p>函数<code>date()</code>、<code>time()</code>和<code>datetime()</code>可以指定时区进行转换，例如<code>datetime(&quot;2017-03-04 22:30:40.003000+08:00&quot;)</code>或<code>datetime(&quot;2017-03-04T22:30:40.003000[Asia/Shanghai]&quot;)</code>。</p>
</li>
<li><p>函数<code>date()</code>、<code>time()</code>、<code>datetime()</code>和<code>timestamp()</code>可以用空值获取当前的日期或时间。</p>
</li>
<li><p>函数<code>date()</code>、<code>time()</code>、<code>datetime()</code>和<code>duration()</code>可以用属性名称获取自身的某一个具体属性值，例如<code>date().month</code>获取当前月份、<code>time(&quot;02:59:40&quot;).minute</code>获取传入时间的分钟数。</p>
</li>
</ul>
<blockquote>
<p>设置时间的年份为负数时，需要使用 Map 类型数据。</p>
</blockquote>
<h5 id="DATE"><a href="#DATE" class="headerlink" title="DATE"></a>DATE</h5><p><code>DATE</code>包含日期，但是不包含时间。NebulaGraph 检索和显示<code>DATE</code>的格式为<code>YYYY-MM-DD</code>。支持的范围是<code>-32768-01-01</code>到<code>32767-12-31</code>。</p>
<p><code>date()</code>支持的属性名称包括<code>year</code>、<code>month</code>和<code>day</code>。<code>date()</code>支持输入<code>YYYY</code>、<code>YYYY-MM</code>或<code>YYYY-MM-DD</code>，未输入的月份或日期默认为<code>01</code>。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-section">nebula&gt; RETURN DATE(&#123;year:-123, month:12, day:3&#125;);</span><br><span class="hljs-section">+------------------------------------+</span><br><span class="hljs-section">| date(&#123;year:-(123),month:12,day:3&#125;) |</span><br><span class="hljs-section">+------------------------------------+</span><br><span class="hljs-section">| -123-12-03                         |</span><br><span class="hljs-section">+------------------------------------+</span><br><span class="hljs-section">nebula&gt; RETURN DATE(&quot;23333&quot;);</span><br><span class="hljs-section">+---------------+</span><br><span class="hljs-section">| date(&quot;23333&quot;) |</span><br><span class="hljs-section">+---------------+</span><br><span class="hljs-section">| 23333-01-01   |</span><br><span class="hljs-section">+---------------+</span><br></code></pre></td></tr></table></figure>

<h5 id="TIME"><a href="#TIME" class="headerlink" title="TIME"></a>TIME</h5><p><code>TIME</code>包含时间，但是不包含日期。NebulaGraph 检索和显示<code>TIME</code>的格式为<code>hh:mm:ss.msmsmsususus</code>。支持的范围是<code>00:00:00.000000</code>到<code>23:59:59.999999</code>。</p>
<p><code>time()</code>支持的属性名称包括<code>hour</code>、<code>minute</code>和<code>second</code>。</p>
<h5 id="DATETIME"><a href="#DATETIME" class="headerlink" title="DATETIME"></a>DATETIME</h5><p><code>DATETIME</code>包含日期和时间。NebulaGraph 检索和显示<code>DATETIME</code>的格式为<code>YYYY-MM-DDThh:mm:ss.msmsmsususus</code>。支持的范围是<code>-32768-01-01T00:00:00.000000</code>到<code>32767-12-31T23:59:59.999999</code>。</p>
<ul>
<li><p><code>datetime()</code>支持的属性名称包括<code>year</code>、<code>month</code>、<code>day</code>、<code>hour</code>、<code>minute</code>和<code>second</code>。</p>
</li>
<li><p><code>datetime()</code>可将<code>TIMESTAMP</code>类型的日期值转换成<code>DATETIME</code>类型的日期值。<code>TIMESTAMP</code>类型的日期值取值范围：<code>0~9223372036</code>。</p>
</li>
<li><p><code>datetime()</code>支持<code>int</code>类型的参数，该<code>int</code>参数表示时间戳。</p>
</li>
</ul>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"># 获取当前时间。<br><span class="hljs-section">nebula&gt; RETURN datetime();</span><br><span class="hljs-section">+----------------------------+</span><br><span class="hljs-section">| datetime()                 |</span><br><span class="hljs-section">+----------------------------+</span><br><span class="hljs-section">| 2022-08-29T06:37:08.933000 |</span><br><span class="hljs-section">+----------------------------+</span><br><br># 获取当前时间的小时。<br><span class="hljs-section">nebula&gt; RETURN datetime().hour;</span><br><span class="hljs-section">+-----------------+</span><br><span class="hljs-section">| datetime().hour |</span><br><span class="hljs-section">+-----------------+</span><br><span class="hljs-section">| 6               |</span><br><span class="hljs-section">+-----------------+</span><br><br># 将时间戳转换成 DATETIME 类型的格式。<br><span class="hljs-section">nebula&gt; RETURN datetime(timestamp(1625469277));</span><br><span class="hljs-section">+---------------------------------+</span><br><span class="hljs-section">| datetime(timestamp(1625469277)) |</span><br><span class="hljs-section">+---------------------------------+</span><br><span class="hljs-section">| 2021-07-05T07:14:37.000000      |</span><br><span class="hljs-section">+---------------------------------+</span><br><br><span class="hljs-section">nebula&gt; RETURN datetime(1625469277);</span><br><span class="hljs-section">+----------------------------+</span><br><span class="hljs-section">| datetime(1625469277)       |</span><br><span class="hljs-section">+----------------------------+</span><br><span class="hljs-section">| 2021-07-05T07:14:37.000000 |</span><br><span class="hljs-section">+----------------------------+</span><br></code></pre></td></tr></table></figure>

<h5 id="TIMESTAMP"><a href="#TIMESTAMP" class="headerlink" title="TIMESTAMP"></a>TIMESTAMP</h5><p><code>TIMESTAMP</code>包含日期和时间。支持的范围是 UTC 时间的<code>1970-01-01T00:00:01</code>到<code>2262-04-11T23:47:16</code>。</p>
<p><code>TIMESTAMP</code>还有以下特点：</p>
<ul>
<li><p>以时间戳形式存储和显示。例如<code>1615974839</code>，表示<code>2021-03-17T17:53:59</code>。</p>
</li>
<li><p>查询<code>TIMESTAMP</code>类型属性值的方式包括时间戳整数和<code>timestamp()</code>函数。</p>
</li>
<li><p>插入<code>TIMESTAMP</code>类型属性值的方式包括时间戳整数、<code>timestamp()</code>函数和<code>now()</code>函数。</p>
</li>
<li><p><code>timestamp()</code>函数支持传入空值获取当前时间戳；同时支持传入整数以标识该整数为时间戳，整数取值：<code>0~9223372036</code>。</p>
</li>
<li><p><code>timestamp()</code>函数可将<code>DATETIME</code>类型的日期值转换成<code>TIMESTAMP</code>类型的日期值，且传入的<code>DATETIME</code>类型的日期值为<code>string</code>类型。</p>
</li>
<li><p>底层存储的数据格式为 <strong>64 位 int</strong>。</p>
</li>
</ul>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"># 传入当前时间。<br><span class="hljs-section">nebula&gt; RETURN timestamp();</span><br><span class="hljs-section">+-------------+</span><br><span class="hljs-section">| timestamp() |</span><br><span class="hljs-section">+-------------+</span><br><span class="hljs-section">| 1625469277  |</span><br><span class="hljs-section">+-------------+</span><br><br># 传入指定时间。<br><span class="hljs-section">nebula&gt; RETURN timestamp(&quot;2022-01-05T06:18:43&quot;);</span><br><span class="hljs-section">+----------------------------------+</span><br><span class="hljs-section">| timestamp(&quot;2022-01-05T06:18:43&quot;) |</span><br><span class="hljs-section">+----------------------------------+</span><br><span class="hljs-section">| 1641363523                       |</span><br><span class="hljs-section">+----------------------------------+</span><br><br># 传入 datetime()。<br><span class="hljs-section">nebula&gt; RETURN timestamp(datetime(&quot;2022-08-29T07:53:10.939000&quot;));</span><br><span class="hljs-section">+---------------------------------------------------+</span><br><span class="hljs-section">| timestamp(datetime(&quot;2022-08-29T07:53:10.939000&quot;)) |</span><br><span class="hljs-section">+---------------------------------------------------+</span><br>| 1661759590                                        |<br><span class="hljs-code">+---------------------------------------------------+</span>    <br></code></pre></td></tr></table></figure>

<p>传入<code>timestamp()</code>函数的时间字符串不支持包含毫秒和微秒，但是通过<code>timestamp(datetime())</code>传入的时间字符串支持包含毫秒和微秒。</p>
<h5 id="DURATION"><a href="#DURATION" class="headerlink" title="DURATION"></a>DURATION</h5><p><code>DURATION</code>是一段连续的时间，由<code>years</code>、<code>months</code>、<code>days</code>、<code>hours</code>、<code>minutes</code>、<code>seconds</code>六个Key自由组合成的Map类型数据表示。例如<code>duration(&#123;years: 12, months: 5, days: 14, hours: 16, minutes: 12, seconds: 70&#125;)</code>。</p>
<p><code>DURATION</code>还有以下特点：</p>
<ul>
<li><p>不支持为<code>DURATION</code>类型数据创建索引。</p>
</li>
<li><p>可以用于对指定时间进行计算。</p>
</li>
</ul>
<h5 id="NULL"><a href="#NULL" class="headerlink" title="NULL"></a>NULL</h5><p>默认情况下，插入点或边时，属性值可以为<code>NULL</code>，用户也可以设置属性值不允许为<code>NULL</code>（<code>NOT NULL</code>），即插入点或边时必须设置该属性的值，除非创建属性时已经设置默认值。</p>
<h4 id="复合数据类型"><a href="#复合数据类型" class="headerlink" title="复合数据类型"></a>复合数据类型</h4><h5 id="列表"><a href="#列表" class="headerlink" title="列表"></a>列表</h5><p>列表（List）是复合数据类型，一个列表是一组元素的序列，可以通过元素在序列中的位置访问列表中的元素。</p>
<p>列表用左方括号（[）和右方括号（]）包裹多个元素，各个元素之间用英文逗号（,）隔开。元素前后的空格在列表中被忽略，因此可以使用换行符、制表符和空格调整格式。</p>
<h5 id="集合"><a href="#集合" class="headerlink" title="集合"></a>集合</h5><p>集合（Set）是复合数据类型，集合中是一组元素，与列表（List）不同的是，集合中的元素是无序的，且不允许重复。</p>
<p>集合用左花括号（{）和右花括号（}）包裹多个元素，各个元素之间用英文逗号（,）隔开。元素前后的空格在集合中被忽略，因此可以使用换行符、制表符和空格调整格式。</p>
<h5 id="映射"><a href="#映射" class="headerlink" title="映射"></a>映射</h5><p>映射（Map）是复合数据类型。一个映射是一组键值对（Key-Value）的无序集合。在映射中，Key 是字符串类型，Value 可以是任何数据类型。用户可以通过<code>map[&#39;&lt;key&gt;&#39;]</code>的方法获取映射中的元素。</p>
<p>映射用左花括号（{）和右花括号（}）包裹多个键值对，各个键值对之间用英文逗号（,）隔开。键值对前后的空格在映射中被忽略，因此可以使用换行符、制表符和空格调整格式。</p>
<h3 id="3-1-6-运算符"><a href="#3-1-6-运算符" class="headerlink" title="3.1.6 运算符"></a>3.1.6 运算符</h3><h4 id="比较符"><a href="#比较符" class="headerlink" title="比较符"></a>比较符</h4><p>NebulaGraph 支持的比较符如下，比较操作的结果是<code>true</code>或者<code>false</code>，比较不同类型的值通常没有定义，结果可能是<code>NULL</code>或其它。。</p>
<table>
<thead>
<tr>
<th>符号</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>=</code></td>
<td>赋值</td>
</tr>
<tr>
<td><code>+</code></td>
<td>加法</td>
</tr>
<tr>
<td><code>-</code></td>
<td>减法</td>
</tr>
<tr>
<td><code>*</code></td>
<td>乘法</td>
</tr>
<tr>
<td><code>/</code></td>
<td>除法</td>
</tr>
<tr>
<td><code>==</code></td>
<td>相等</td>
</tr>
<tr>
<td><code>!=</code>, <code>&lt;&gt;</code></td>
<td>不等于</td>
</tr>
<tr>
<td><code>&gt;</code></td>
<td>大于</td>
</tr>
<tr>
<td><code>&gt;=</code></td>
<td>大于等于</td>
</tr>
<tr>
<td><code>&lt;</code></td>
<td>小于</td>
</tr>
<tr>
<td><code>&lt;=</code></td>
<td>小于等于</td>
</tr>
<tr>
<td><code>%</code></td>
<td>取模</td>
</tr>
<tr>
<td><code>-</code></td>
<td>负数符号</td>
</tr>
<tr>
<td><code>IS NULL</code></td>
<td>为 NULL</td>
</tr>
<tr>
<td><code>IS NOT NULL</code></td>
<td>不为 NULL</td>
</tr>
<tr>
<td><code>IS EMPTY</code></td>
<td>不存在</td>
</tr>
<tr>
<td><code>IS NOT EMPTY</code></td>
<td>存在</td>
</tr>
</tbody></table>
<blockquote>
<p><code>EMPTY</code>当前仅用于判断，不支持函数或者运算操作，包括且不限于<code>GROUP BY</code>、<code>count()</code>、<code>sum()</code>、<code>max()</code>、<code>hash()</code>、<code>collect()</code>、<code>+</code>、<code>*</code>。</p>
</blockquote>
<h4 id="布尔符"><a href="#布尔符" class="headerlink" title="布尔符"></a>布尔符</h4><p>NebulaGraph 支持的布尔符如下，非 0 数字不能转换为布尔值。</p>
<table>
<thead>
<tr>
<th>符号</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>AND</td>
<td>逻辑与</td>
</tr>
<tr>
<td>OR</td>
<td>逻辑或</td>
</tr>
<tr>
<td>NOT</td>
<td>逻辑非</td>
</tr>
<tr>
<td>XOR</td>
<td>逻辑异或</td>
</tr>
</tbody></table>
<h4 id="管道符"><a href="#管道符" class="headerlink" title="管道符"></a>管道符</h4><p>nGQL 支持使用管道符（|）将多个查询组合起来，nGQL 和 SQL 之间的一个主要区别是子查询的组成方式。</p>
<ul>
<li><p>在 SQL 中，子查询是嵌套在查询语句中的。</p>
</li>
<li><p>在 nGQL 中，子查询是通过类似 shell 中的管道符（<code>|</code>）实现的。</p>
</li>
</ul>
<p><strong>性能问题</strong></p>
<p>NebulaGraph 中的管道对性能有影响，以<code>A | B</code>为例，体现在以下几个方面：</p>
<ol>
<li><p>管道是同步操作。也即需要管道之前的子句<code>A</code>执行完毕后，数据才能整体进入管道子句。</p>
</li>
<li><p>管道本身是需要序列化和反序列化的，这个是单线程执行的。</p>
</li>
<li><p>如果<code>A</code>发大量数据给 <code>|</code>，整个查询请求的总体时延可能会非常大。此时可以尝试拆分这个语句：</p>
<ol>
<li>应用程序发送<code>A</code>，</li>
<li>将收到的返回结果在应用程序拆分，</li>
<li>并发发送给多个 graphd，</li>
<li>每个 graphd 执行部分 B。</li>
</ol>
<p>这样通常比单个 graphd 执行完整地<code>A | B</code>要快很多。</p>
</li>
</ol>
<h4 id="引用符"><a href="#引用符" class="headerlink" title="引用符"></a>引用符</h4><p>nGQL 提供引用符来表示<code>WHERE</code>和<code>YIELD</code>子句中的属性，或者复合查询中管道符之前的语句输出结果。</p>
<p><strong>引用符列表</strong></p>
<table>
<thead>
<tr>
<th>引用符</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>$^</code></td>
<td>引用起始点。</td>
</tr>
<tr>
<td><code>$$</code></td>
<td>引用目的点。</td>
</tr>
<tr>
<td><code>$-</code></td>
<td>引用复合查询中管道符之前的语句输出结果。</td>
</tr>
</tbody></table>
<p><strong>示例</strong></p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"># 返回起始点和目的点的年龄。<br><span class="hljs-section">nebula&gt; GO FROM &quot;player100&quot; OVER follow YIELD properties($^).age AS SrcAge, properties($$).age AS DestAge;</span><br><span class="hljs-section">+--------+---------+</span><br><span class="hljs-section">| SrcAge | DestAge |</span><br><span class="hljs-section">+--------+---------+</span><br>| 42     | 36      |<br><span class="hljs-section">| 42     | 41      |</span><br><span class="hljs-section">+--------+---------+</span><br><br># 返回 player100 追随的 player 的名称和团队。<br>nebula&gt; GO FROM &quot;player100&quot; OVER follow \<br><span class="hljs-code">        YIELD dst(edge) AS id | \</span><br><span class="hljs-code">        GO FROM $-.id OVER serve \</span><br><span class="hljs-section">        YIELD properties($^).name AS Player, properties($$).name AS Team;</span><br><span class="hljs-section">+-----------------+-----------+</span><br><span class="hljs-section">| Player          | Team      |</span><br><span class="hljs-section">+-----------------+-----------+</span><br>| &quot;Tony Parker&quot;   | &quot;Spurs&quot;   |<br>| &quot;Tony Parker&quot;   | &quot;Hornets&quot; |<br><span class="hljs-section">| &quot;Manu Ginobili&quot; | &quot;Spurs&quot;   |</span><br><span class="hljs-section">+-----------------+-----------+</span><br></code></pre></td></tr></table></figure>



<h4 id="集合运算符"><a href="#集合运算符" class="headerlink" title="集合运算符"></a>集合运算符</h4><p>合并多个请求时，可以使用集合运算符，包括<code>UNION</code>、<code>UNION ALL</code>、<code>INTERSECT</code>和<code>MINUS</code>。</p>
<p>所有集合运算符的优先级相同，如果一个 nGQL 语句中有多个集合运算符，NebulaGraph 会从左到右进行计算，除非用括号指定顺序。</p>
<h5 id="UNION、UNION-DISTINCT、UNION-ALL"><a href="#UNION、UNION-DISTINCT、UNION-ALL" class="headerlink" title="UNION、UNION DISTINCT、UNION ALL"></a>UNION、UNION DISTINCT、UNION ALL</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-operator">&lt;</span><span class="hljs-keyword">left</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">UNION</span> [<span class="hljs-keyword">DISTINCT</span> <span class="hljs-operator">|</span> <span class="hljs-keyword">ALL</span>] <span class="hljs-operator">&lt;</span><span class="hljs-keyword">right</span><span class="hljs-operator">&gt;</span> [ <span class="hljs-keyword">UNION</span> [<span class="hljs-keyword">DISTINCT</span> <span class="hljs-operator">|</span> <span class="hljs-keyword">ALL</span>] <span class="hljs-operator">&lt;</span><span class="hljs-keyword">right</span><span class="hljs-operator">&gt;</span> ...]<br></code></pre></td></tr></table></figure>

<ul>
<li><p>运算符<code>UNION DISTINCT</code>（或使用缩写<code>UNION</code>）返回两个集合 A 和 B 的并集，不包含重复的元素。</p>
</li>
<li><p>运算符<code>UNION ALL</code>返回两个集合 A 和 B 的并集，包含重复的元素。</p>
</li>
<li><p><code>left</code>和<code>right</code>必须有相同数量的列和数据类型。如果数据类型不同，需要转换。</p>
</li>
</ul>
<p><strong>示例</strong></p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"># 返回两个查询结果的并集，不包含重复的元素。<br>nebula&gt; GO FROM &quot;player102&quot; OVER follow YIELD dst(edge) \<br><span class="hljs-code">        UNION \</span><br><span class="hljs-section">        GO FROM &quot;player100&quot; OVER follow YIELD dst(edge);</span><br><span class="hljs-section">+-------------+</span><br><span class="hljs-section">| dst(EDGE)   |</span><br><span class="hljs-section">+-------------+</span><br>| &quot;player100&quot; |<br>| &quot;player101&quot; |<br><span class="hljs-section">| &quot;player125&quot; |</span><br><span class="hljs-section">+-------------+</span><br><br># 返回两个查询结果的并集，包含重复的元素。<br>nebula&gt; GO FROM &quot;player102&quot; OVER follow YIELD dst(edge) \<br><span class="hljs-code">        UNION ALL \</span><br><span class="hljs-section">        GO FROM &quot;player100&quot; OVER follow YIELD dst(edge);</span><br><span class="hljs-section">+-------------+</span><br><span class="hljs-section">| dst(EDGE)   |</span><br><span class="hljs-section">+-------------+</span><br>| &quot;player100&quot; |<br>| &quot;player101&quot; |<br>| &quot;player101&quot; |<br><span class="hljs-section">| &quot;player125&quot; |</span><br><span class="hljs-section">+-------------+</span><br><br># UNION 也可以和 YIELD 语句一起使用，去重时会检查每一行的所有列，每列都相同时才会去重。<br>nebula&gt; GO FROM &quot;player102&quot; OVER follow \<br><span class="hljs-code">        YIELD dst(edge) AS id, properties(edge).degree AS Degree, properties($$).age AS Age \</span><br><span class="hljs-code">        UNION /* DISTINCT */ \</span><br><span class="hljs-code">        GO FROM &quot;player100&quot; OVER follow \</span><br><span class="hljs-section">        YIELD dst(edge) AS id, properties(edge).degree AS Degree, properties($$).age AS Age;</span><br><span class="hljs-section">+-------------+--------+-----+</span><br><span class="hljs-section">| id          | Degree | Age |</span><br><span class="hljs-section">+-------------+--------+-----+</span><br>| &quot;player100&quot; | 75     | 42  |<br>| &quot;player101&quot; | 75     | 36  |<br>| &quot;player101&quot; | 95     | 36  |<br><span class="hljs-section">| &quot;player125&quot; | 95     | 41  |</span><br><span class="hljs-section">+-------------+--------+-----+</span><br></code></pre></td></tr></table></figure>



<h5 id="INTERSECT"><a href="#INTERSECT" class="headerlink" title="INTERSECT"></a>INTERSECT</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-operator">&lt;</span><span class="hljs-keyword">left</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">INTERSECT</span> <span class="hljs-operator">&lt;</span><span class="hljs-keyword">right</span><span class="hljs-operator">&gt;</span><br></code></pre></td></tr></table></figure>

<ul>
<li><p>运算符<code>INTERSECT</code>返回两个集合 A 和 B 的交集。</p>
</li>
<li><p><code>left</code>和<code>right</code>必须有相同数量的列和数据类型。如果数据类型不同，需要转换。</p>
</li>
</ul>
<p><strong>示例</strong></p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">nebula&gt; GO FROM &quot;player102&quot; OVER follow \<br><span class="hljs-code">        YIELD dst(edge) AS id, properties(edge).degree AS Degree, properties($$).age AS Age \</span><br><span class="hljs-code">        INTERSECT \</span><br><span class="hljs-code">        GO FROM &quot;player100&quot; OVER follow \</span><br><span class="hljs-section">        YIELD dst(edge) AS id, properties(edge).degree AS Degree, properties($$).age AS Age;</span><br><span class="hljs-section">+----+--------+-----+</span><br><span class="hljs-section">| id | Degree | Age |</span><br><span class="hljs-section">+----+--------+-----+</span><br><span class="hljs-code">+----+</span>--------<span class="hljs-code">+-----+</span><br></code></pre></td></tr></table></figure>



<h5 id="MINUS"><a href="#MINUS" class="headerlink" title="MINUS"></a>MINUS</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">left</span>&gt;</span> MINUS <span class="hljs-tag">&lt;<span class="hljs-name">right</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>运算符<code>MINUS</code>返回两个集合 A 和 B 的差异，即<code>A-B</code>。请注意<code>left</code>和<code>right</code>的顺序，<code>A-B</code>表示在集合 A 中，但是不在集合 B 中的元素。</p>
<p><strong>示例</strong></p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">nebula&gt; GO FROM &quot;player100&quot; OVER follow YIELD dst(edge) \<br><span class="hljs-code">        MINUS \</span><br><span class="hljs-section">        GO FROM &quot;player102&quot; OVER follow YIELD dst(edge);</span><br><span class="hljs-section">+-------------+</span><br><span class="hljs-section">| dst(EDGE)   |</span><br><span class="hljs-section">+-------------+</span><br><span class="hljs-section">| &quot;player125&quot; |</span><br><span class="hljs-section">+-------------+</span><br><br>nebula&gt; GO FROM &quot;player102&quot; OVER follow YIELD dst(edge) \<br><span class="hljs-code">        MINUS \</span><br><span class="hljs-section">        GO FROM &quot;player100&quot; OVER follow YIELD dst(edge);</span><br><span class="hljs-section">+-------------+</span><br><span class="hljs-section">| dst(EDGE)   |</span><br><span class="hljs-section">+-------------+</span><br><span class="hljs-section">| &quot;player100&quot; |</span><br><span class="hljs-section">+-------------+</span><br></code></pre></td></tr></table></figure>



<blockquote>
<p>当查询包含集合运算符和管道符（|）时，管道符的优先级高。例如<code>GO FROM 1 UNION GO FROM 2 | GO FROM 3</code>相当于<code>GO FROM 1 UNION (GO FROM 2 | GO FROM 3)</code>。</p>
</blockquote>
<h4 id="字符串运算符"><a href="#字符串运算符" class="headerlink" title="字符串运算符"></a>字符串运算符</h4><p>NebulaGraph 支持使用字符串运算符进行连接、搜索、匹配运算。支持的运算符如下。</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>+</td>
<td>连接字符串。</td>
</tr>
<tr>
<td>CONTAINS</td>
<td>在字符串中执行搜索。</td>
</tr>
<tr>
<td>(NOT) IN</td>
<td>字符串是否匹配某个值。</td>
</tr>
<tr>
<td>(NOT) STARTS WITH</td>
<td>在字符串的开头执行匹配。</td>
</tr>
<tr>
<td>(NOT) ENDS WITH</td>
<td>在字符串的结尾执行匹配。</td>
</tr>
<tr>
<td>正则表达式</td>
<td>通过正则表达式匹配字符串。</td>
</tr>
</tbody></table>
<p><strong>所有搜索或匹配都区分大小写。</strong></p>
<p><strong>NebulaGraph 支持使用正则表达式进行过滤，正则表达式的语法是继承自<code>std::regex</code>，用户可以使用语法<code>=~ &#39;&lt;regexp&gt;&#39;</code>进行正则表达式匹配。</strong></p>
<h4 id="列表运算符"><a href="#列表运算符" class="headerlink" title="列表运算符"></a>列表运算符</h4><p>NebulaGraph 支持使用列表（List）运算符进行运算。支持的运算符如下。</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>+</td>
<td>连接列表。</td>
</tr>
<tr>
<td>IN</td>
<td>元素是否存在于列表中。</td>
</tr>
<tr>
<td>[]</td>
<td>使用下标操作符访问列表中的元素。</td>
</tr>
</tbody></table>
<h4 id="运算符优先级"><a href="#运算符优先级" class="headerlink" title="运算符优先级"></a>运算符优先级</h4><p>nGQL 运算符的优先级从高到低排列如下（同一行的运算符优先级相同）：</p>
<ul>
<li><code>-</code>（负数）</li>
<li><code>!</code>、<code>NOT</code></li>
<li><code>*</code>、<code>/</code>、<code>%</code></li>
<li><code>-</code>、<code>+</code></li>
<li><code>==</code>、<code>&gt;=</code>、<code>&gt;</code>、<code>&lt;=</code>、<code>&lt;</code>、<code>&lt;&gt;</code>、<code>!=</code></li>
<li><code>AND</code></li>
<li><code>OR</code>、<code>XOR</code></li>
<li><code>=</code>（赋值）</li>
</ul>
<p>如果表达式中有相同优先级的运算符，运算是从左到右进行，只有赋值操作是例外（从右到左运算）。</p>
<p>运算符的优先级决定运算的顺序，要显式修改运算顺序，可以使用圆括号。</p>
<h3 id="3-1-7-函数"><a href="#3-1-7-函数" class="headerlink" title="3.1.7 函数"></a>3.1.7 函数</h3><h4 id="数学函数"><a href="#数学函数" class="headerlink" title="数学函数"></a>数学函数</h4><h4 id="聚合函数"><a href="#聚合函数" class="headerlink" title="聚合函数"></a>聚合函数</h4><ul>
<li>avg() 返回参数的平均值。</li>
<li>count() 返回参数的数量。</li>
<li>max() 返回参数的最大值。</li>
<li>min() 返回参数的最小值。</li>
<li>collect() 返回一个符合表达式返回结果的列表。该函数可以将多条记录或值合并进一个列表，实现数据聚合。</li>
<li>std() 返回参数的总体标准差。</li>
<li>sum() 返回参数的和。</li>
</ul>
<h4 id="字符串函数"><a href="#字符串函数" class="headerlink" title="字符串函数"></a>字符串函数</h4><blockquote>
<p>nGQL 的字符索引（位置）从<code>1</code>开始</p>
</blockquote>
<ul>
<li>strcasecmp() 比较两个字符串（不区分大小写）</li>
<li>lower() 和 toLower() 都可以返回指定字符串的小写形式。</li>
<li>upper() 和 toUpper() 都可以返回指定字符串的大写形式。</li>
<li>length() 返回： - 指定字符串的长度，单位：字节。 - 路径的长度，单位：跳。</li>
<li>trim() 删除指定字符串头部和尾部的空格。</li>
<li>ltrim() 删除字符串头部的空格。</li>
<li>rtrim() 删除字符串尾部的空格。</li>
<li>left() 返回指定字符串头部若干个字符组成的子字符串。</li>
<li>right() 返回指定字符串尾部若干个字符组成的子字符串。</li>
<li>lpad() 在指定字符串的头部填充字符串至指定长度，并返回结果字符串。</li>
<li>rpad() 在指定字符串的尾部填充字符串至指定长度，并返回结果字符串。</li>
<li>substr() 和 substring() 从指定字符串的指定位置开始（不包括开始位置的字符），提取后面的若干个字符，组成新的字符串并返回。</li>
<li>reverse() 逆序返回指定的字符串。</li>
<li>replace() 将指定字符串中的子字符串 a 替换为字符串 b。</li>
<li>split() 将子字符串 b 识别为分隔符，分隔指定字符串，并返回分隔后的字符串列表。</li>
<li>concat() 返回所有参数连接成的字符串。</li>
<li>concat_ws() 返回用分隔符（separator）连接的所有字符串。</li>
<li>extract() 从指定字符串中提取符合正则表达式的子字符串。</li>
<li>json_extract() 将指定 JSON 字符串转换为 map 类型。</li>
</ul>
<h4 id="日期时间函数"><a href="#日期时间函数" class="headerlink" title="日期时间函数"></a>日期时间函数</h4><ul>
<li>int now()，根据当前系统返回当前时间戳。</li>
<li>timestamp timestamp()，根据当前系统返回当前时间戳。</li>
<li>date date()，根据当前系统返回当前日期（UTC 时间）。</li>
<li>time time()，根据当前系统返回当前时间（UTC 时间）。</li>
<li>datetime datetime()，根据当前系统返回当前日期和时间（UTC 时间）。</li>
<li>map duration()，持续时间。可以用于对指定时间进行计算。</li>
</ul>
<h4 id="Schema-相关的函数"><a href="#Schema-相关的函数" class="headerlink" title="Schema 相关的函数"></a>Schema 相关的函数</h4><ul>
<li>id(vertex) 返回点 ID。</li>
<li>properties(vertex) 返回点的所有属性。</li>
<li>properties(edge) 返回边的所有属性。</li>
<li>type(edge) 返回边的 Edge type。</li>
<li>src(edge) 返回边的起始点 ID。</li>
<li>dst(edge) 返回边的目的点 ID。</li>
<li>rank(edge) 返回边的 rank。</li>
<li>vertex 返回点的信息。包括点 ID、Tag、属性和值。需要用<code>AS &lt;alias&gt;</code>设置别名。</li>
<li>edge 返回边的信息。包括 Edge type、起始点 ID、目的点 ID、rank、属性和值。需要用<code>AS &lt;alias&gt;</code>设置别名。</li>
<li>vertices 返回子图中的点的信息。</li>
<li>edges 返回子图中的边的信息。</li>
<li>path 返回路径信息。</li>
</ul>
<h4 id="列表函数"><a href="#列表函数" class="headerlink" title="列表函数"></a>列表函数</h4><blockquote>
<p>nGQL 的字符索引（位置）从<code>1</code>开始</p>
</blockquote>
<ul>
<li>range() 返回指定整数范围<code>[start,end]</code>内固定步长的列表。</li>
<li>reverse() 返回将原列表逆序排列的新列表。</li>
<li>tail() 返回不包含原列表第一个元素的新列表。</li>
<li>head() 返回列表的第一个元素。</li>
<li>last() 返回列表的最后一个元素。</li>
<li>reduce() 将表达式逐个应用于列表中的元素，然后和累加器中的当前结果累加，最后返回完整结果。该函数将遍历给定列表中的每个元素 e，在 e 上运行表达式并和累加器的当前结果累加，将新的结果存储在累加器中。这个函数类似于函数式语言（如 Lisp 和 Scala）中的 fold 或 reduce 方法。</li>
<li>keys() 返回一个列表，包含字符串形式的点、边的所有属性。</li>
<li>labels() 返回点的 Tag 列表。</li>
</ul>
<h4 id="类型转换函数"><a href="#类型转换函数" class="headerlink" title="类型转换函数"></a>类型转换函数</h4><ul>
<li>toBoolean() 将字符串转换为布尔。</li>
<li>toFloat() 将整数或字符串转换为浮点数。</li>
<li>toString() 将任意非复合数据类型数据转换为字符串类型。</li>
<li>toInteger() 将浮点或字符串转换为整数。</li>
<li>toSet() 将列表或集合转换为集合。</li>
<li>hash() 返回参数的哈希值。其参数可以是数字、字符串、列表、布尔值、NULL 等类型的值，或者计算结果为这些类型的表达式。</li>
</ul>
<h4 id="条件表达式函数"><a href="#条件表达式函数" class="headerlink" title="条件表达式函数"></a>条件表达式函数</h4><ul>
<li><p><code>CASE</code>表达式使用条件来过滤传参，其会遍历所有条件，并在满足第一个条件时停止读取后续条件，然后返回结果。如果不满足任何条件，将通过<code>ELSE</code>子句返回结果。如果没有<code>ELSE</code>子句且不满足任何条件，则返回<code>NULL</code>。</p>
<ul>
<li><p>简单形式</p>
<ul>
<li><p>语法</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CASE</span> <span class="hljs-operator">&lt;</span>comparer<span class="hljs-operator">&gt;</span><br><span class="hljs-keyword">WHEN</span> <span class="hljs-operator">&lt;</span><span class="hljs-keyword">value</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">THEN</span> <span class="hljs-operator">&lt;</span><span class="hljs-keyword">result</span><span class="hljs-operator">&gt;</span><br>[<span class="hljs-keyword">WHEN</span> ...]<br>[<span class="hljs-keyword">ELSE</span> <span class="hljs-operator">&lt;</span><span class="hljs-keyword">default</span><span class="hljs-operator">&gt;</span>]<br><span class="hljs-keyword">END</span><br></code></pre></td></tr></table></figure></li>
<li><p>参数</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>comparer</code></td>
<td>用于与<code>value</code>进行比较的值或者有效表达式。</td>
</tr>
<tr>
<td><code>value</code></td>
<td>和<code>comparer</code>进行比较，如果匹配，则满足此条件。</td>
</tr>
<tr>
<td><code>result</code></td>
<td>如果<code>value</code>匹配<code>comparer</code>，则返回该<code>result</code>。</td>
</tr>
<tr>
<td><code>default</code></td>
<td>如果没有条件匹配，则返回该<code>default</code>。</td>
</tr>
</tbody></table>
</li>
</ul>
</li>
<li><p>通用形式</p>
<ul>
<li><p>语法</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CASE</span><br><span class="hljs-keyword">WHEN</span> <span class="hljs-operator">&lt;</span><span class="hljs-keyword">condition</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">THEN</span> <span class="hljs-operator">&lt;</span><span class="hljs-keyword">result</span><span class="hljs-operator">&gt;</span><br>[<span class="hljs-keyword">WHEN</span> ...]<br>[<span class="hljs-keyword">ELSE</span> <span class="hljs-operator">&lt;</span><span class="hljs-keyword">default</span><span class="hljs-operator">&gt;</span>]<br><span class="hljs-keyword">END</span><br></code></pre></td></tr></table></figure></li>
<li><p>参数</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>condition</code></td>
<td>如果条件<code>condition</code>为 true，表示满足此条件。</td>
</tr>
<tr>
<td><code>result</code></td>
<td><code>condition</code>为 true，则返回此<code>result</code>。</td>
</tr>
<tr>
<td><code>default</code></td>
<td>如果没有条件匹配，则返回该<code>default</code>。</td>
</tr>
</tbody></table>
</li>
</ul>
</li>
</ul>
</li>
<li><p>coalesce() 返回所有表达式中第一个非空元素。.</p>
<ul>
<li>语法：<code>coalesce(&lt;expression_1&gt;[,&lt;expression_2&gt;...])</code></li>
</ul>
</li>
</ul>
<h4 id="谓词函数"><a href="#谓词函数" class="headerlink" title="谓词函数"></a>谓词函数</h4><p>谓词函数只返回<code>true</code>或<code>false</code>，通常用于<code>WHERE</code>子句中。</p>
<ul>
<li>exists()，如果指定的属性在点、边或映射中存在，则返回<code>true</code>，否则返回<code>false</code>。</li>
<li>any()，如果指定的谓词适用于列表中的至少一个元素，则返回<code>true</code>，否则返回<code>false</code>。</li>
<li>all()，如果指定的谓词适用于列表中的每个元素，则返回<code>true</code>，否则返回<code>false</code>。</li>
<li>none()，如果指定的谓词不适用于列表中的任何一个元素，则返回<code>true</code>，否则返回<code>false</code>。</li>
<li>single()，如果指定的谓词适用于列表中的唯一一个元素，则返回<code>true</code>，否则返回<code>false</code>。</li>
</ul>
<h4 id="geo-函数"><a href="#geo-函数" class="headerlink" title="geo 函数"></a>geo 函数</h4><p>geo 函数用于生成地理位置（GEOGRAPHY）数据类型的值或对其执行操作。</p>
<h4 id="自定义函数"><a href="#自定义函数" class="headerlink" title="自定义函数"></a>自定义函数</h4><p>NebulaGraph 3.3.0 不支持自定义函数（UDF）和存储过程。</p>
<h2 id="3-2-图模式"><a href="#3-2-图模式" class="headerlink" title="3.2 图模式"></a>3.2 图模式</h2><p>模式（pattern）和图模式匹配，是图查询语言的核心功能。</p>
<h3 id="3-2-1-单点模式"><a href="#3-2-1-单点模式" class="headerlink" title="3.2.1 单点模式"></a>3.2.1 单点模式</h3><p>点用一对括号来描述，通常包含一个名称。例如：</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode"><span class="hljs-comment">(a)</span><br></code></pre></td></tr></table></figure>

<p>示例为一个简单的模式，描述了单个点，并使用变量<code>a</code>命名该点。</p>
<h3 id="3-2-2-多点关联模式"><a href="#3-2-2-多点关联模式" class="headerlink" title="3.2.2 多点关联模式"></a>3.2.2 多点关联模式</h3><p>多个点通过边相连是常见的结构，模式用箭头来描述两个点之间的边。例如：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">(<span class="hljs-selector-tag">a</span>)-<span class="hljs-selector-attr">[]</span>-&gt;(<span class="hljs-selector-tag">b</span>)<br></code></pre></td></tr></table></figure>

<p>示例为一个简单的数据结构：两个点和一条连接两个点的边，两个点分别为<code>a</code>和<code>b</code>，边是有方向的，从<code>a</code>到<code>b</code>。</p>
<p>这种描述点和边的方式可以扩展到任意数量的点和边，例如：</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">(a)-<span class="hljs-selector-attr">[]</span>-&gt;(b)&lt;-<span class="hljs-selector-attr">[]</span>-(c)<br></code></pre></td></tr></table></figure>

<p>这样的一系列点和边称为<code>路径</code>（path）。</p>
<p>只有在涉及某个点时，才需要命名这个点。如果不涉及这个点，则可以省略名称，例如：</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">(a)-<span class="hljs-selector-attr">[]</span>-&gt;()&lt;-<span class="hljs-selector-attr">[]</span>-(c)<br></code></pre></td></tr></table></figure>





<h3 id="3-3-3-Tag-模式"><a href="#3-3-3-Tag-模式" class="headerlink" title="3.3.3 Tag 模式"></a>3.3.3 Tag 模式</h3><p>nGQL 中的<code>Tag</code>概念与 openCypher 中的<code>Label</code>有一些不同。例如，必须创建一个<code>Tag</code>之后才能使用它，而且<code>Tag</code>还定义了属性的类型。</p>
<p>模式除了简单地描述图中的点之外，还可以描述点的 Tag。例如：</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode"><span class="hljs-comment">(a:User)</span>-[]-&gt;<span class="hljs-comment">(b)</span><br></code></pre></td></tr></table></figure>

<p>模式也可以描述有多个 Tag 的点，例如：</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode"><span class="hljs-comment">(a:User:Admin)</span>-[]-&gt;<span class="hljs-comment">(b)</span><br></code></pre></td></tr></table></figure>



<h3 id="3-3-4-属性模式"><a href="#3-3-4-属性模式" class="headerlink" title="3.3.4 属性模式"></a>3.3.4 属性模式</h3><p>点和边是图的基本结构。nGQL 在这两种结构上都可以增加属性，方便实现更丰富的模型。</p>
<p>在模式中，属性的表示方式为：用花括号括起一些键值对，用英文逗号分隔。例如一个点有两个属性：</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scheme">(<span class="hljs-name">a</span> &#123;name: <span class="hljs-symbol">&#x27;Andres</span>&#x27;, sport: <span class="hljs-symbol">&#x27;Brazilian</span> Ju-Jitsu&#x27;&#125;)<br></code></pre></td></tr></table></figure>

<p>在这个点上可以有一条边是：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">(<span class="hljs-selector-tag">a</span>)-<span class="hljs-selector-attr">[&#123;blocked: false&#125;]</span>-&gt;(<span class="hljs-selector-tag">b</span>)<br></code></pre></td></tr></table></figure>



<h3 id="3-3-5-边模式"><a href="#3-3-5-边模式" class="headerlink" title="3.3.5 边模式"></a>3.3.5 边模式</h3><p>描述一条边最简单的方法是使用箭头连接两个点。</p>
<p>可以用以下方式描述边以及它的方向性。如果不关心边的方向，可以省略箭头，例如：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">(<span class="hljs-selector-tag">a</span>)-<span class="hljs-selector-attr">[]</span>-(<span class="hljs-selector-tag">b</span>)<br></code></pre></td></tr></table></figure>

<p>和点一样，边也可以命名。一对方括号用于分隔箭头，变量放在两者之间。例如：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">(<span class="hljs-selector-tag">a</span>)-<span class="hljs-selector-attr">[r]</span>-&gt;(<span class="hljs-selector-tag">b</span>)<br></code></pre></td></tr></table></figure>

<p>和点上的 Tag 一样，边也可以有类型。描述边的类型，例如：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">(<span class="hljs-selector-tag">a</span>)-<span class="hljs-selector-attr">[r:REL_TYPE]</span>-&gt;(<span class="hljs-selector-tag">b</span>)<br></code></pre></td></tr></table></figure>

<p>和点上的 Tag 不同，一条边只能有一种 Edge type。但是如果我们想描述多个可选 Edge type，可以用管道符号（|）将可选值分开，例如：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">(<span class="hljs-selector-tag">a</span>)-<span class="hljs-selector-attr">[r:TYPE1|TYPE2]</span>-&gt;(<span class="hljs-selector-tag">b</span>)<br></code></pre></td></tr></table></figure>

<p>和点一样，边的名称可以省略，例如：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">(<span class="hljs-selector-tag">a</span>)-<span class="hljs-selector-attr">[:REL_TYPE]</span>-&gt;(<span class="hljs-selector-tag">b</span>)<br></code></pre></td></tr></table></figure>



<h3 id="3-3-6-变长模式"><a href="#3-3-6-变长模式" class="headerlink" title="3.3.6 变长模式"></a>3.3.6 变长模式</h3><p>在图中指定边的长度来描述多条边（以及中间的点）组成的一条长路径，不需要使用多个点和边来描述。例如：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">(<span class="hljs-selector-tag">a</span>)-<span class="hljs-selector-attr">[*2]</span>-&gt;(<span class="hljs-selector-tag">b</span>)<br></code></pre></td></tr></table></figure>

<p>该模式描述了 3 点 2 边组成的图，它们都在一条路径上（长度为 2），等价于：</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">(a)-<span class="hljs-selector-attr">[]</span>-&gt;()-<span class="hljs-selector-attr">[]</span>-&gt;(b)<br></code></pre></td></tr></table></figure>

<p>也可以指定长度范围，这样的边模式称为<code>variable-length edges</code>，例如：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">(<span class="hljs-selector-tag">a</span>)-<span class="hljs-selector-attr">[*3..5]</span>-&gt;(<span class="hljs-selector-tag">b</span>)<br></code></pre></td></tr></table></figure>

<p><code>*3..5</code>表示最小长度为 3，最大长度为 5。</p>
<p>该模式描述了 4 点 3 边、5 点 4 边或 6 点 5 边组成的图。</p>
<p>也可以忽略最小长度，只指定最大长度，例如：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">(<span class="hljs-selector-tag">a</span>)-<span class="hljs-selector-attr">[*..5]</span>-&gt;(<span class="hljs-selector-tag">b</span>)<br></code></pre></td></tr></table></figure>

<blockquote>
<p>必须指定最大长度，<strong>不支持</strong>仅指定最小长度（<code>(a)-[*3..]-&gt;(b)</code>）或都不指定（<code>(a)-[*]-&gt;(b)</code>）。</p>
</blockquote>
<h3 id="3-3-7-路径变量"><a href="#3-3-7-路径变量" class="headerlink" title="3.3.7 路径变量"></a>3.3.7 路径变量</h3><p>一系列连接的点和边称为<code>路径</code>。nGQL 允许使用变量来命名路径，例如：</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode">p = <span class="hljs-comment">(a)</span>-[*<span class="hljs-number">3.</span><span class="hljs-number">.5</span>]-&gt;<span class="hljs-comment">(b)</span><br></code></pre></td></tr></table></figure>

<p>可以在 MATCH 语句中使用路径变量。</p>
<h2 id="3-3-查询语句"><a href="#3-3-查询语句" class="headerlink" title="3.3 查询语句"></a>3.3 查询语句</h2><h3 id="3-3-1-MATCH"><a href="#3-3-1-MATCH" class="headerlink" title="3.3.1 MATCH"></a>3.3.1 MATCH</h3><p><code>MATCH</code>语句提供基于模式（pattern）匹配的搜索功能。</p>
<p>一个<code>MATCH</code>语句定义了一个搜索模式，用该模式匹配存储在 NebulaGraph 中的数据，然后用<code>RETURN</code>子句检索数据。</p>
<h4 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h4><p>与<code>GO</code>或<code>LOOKUP</code>等其他查询语句相比，<code>MATCH</code>的语法更灵活。<code>MATCH</code>语句采用的路径类型是[<code>trail</code>]，即遍历时只有点可以重复，边不可以重复。</p>
<p><code>MATCH</code> 语法如下：</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs fsharp">MATCH &lt;pattern&gt; <span class="hljs-meta">[&lt;clause_1&gt;]</span>  RETURN &lt;output&gt;  <span class="hljs-meta">[&lt;clause_2&gt;]</span>;<br></code></pre></td></tr></table></figure>

<ul>
<li><p><code>pattern</code>：<code>MATCH</code>语句支持匹配一个或多个模式，多个模式之间用英文逗号（,）分隔。例如<code>(a)-[]-&gt;(b),(c)-[]-&gt;(d)</code>。</p>
</li>
<li><p><code>clause_1</code>：支持<code>WHERE</code>、<code>WITH</code>、<code>UNWIND</code>、<code>OPTIONAL MATCH</code>子句，也可以使用<code>MATCH</code>作为子句。</p>
</li>
<li><p><code>output</code>：定义需要返回的输出。可以使用<code>AS</code>设置输出的别名。</p>
</li>
<li><p><code>clause_2</code>：支持<code>ORDER BY</code>、<code>LIMIT</code>子句。</p>
</li>
</ul>
<h4 id="使用限制"><a href="#使用限制" class="headerlink" title="使用限制"></a>使用限制</h4><p>未创建索引时，仅以下情况支持使用<code>MATCH</code>查询。当使用<code>MATCH</code>语句出现报错时，用户可以创建并重建索引后执行查询语句。</p>
<ul>
<li><p><code>MATCH</code>语句中<code>WHERE</code>子句使用 id() 函数指定了点的 VID，不需要创建索引即可执行。</p>
</li>
<li><p>当遍历所有点或边时，例如<code>MATCH (v) RETURN v LIMIT N</code>、<code>MATCH ()-[e]-&gt;() RETURN e LIMIT N</code>。</p>
</li>
<li><p>当遍历指定 Tag 的点，例如<code>MATCH (v:player) RETURN v LIMIT N</code>。</p>
</li>
<li><p>当遍历指定 Edge Type 并指定边的方向，例如<code>MATCH ()-[e:follow]-&gt;() RETURN e LIMIT N</code>。</p>
</li>
</ul>
<blockquote>
<ul>
<li>目前 MATCH 语句无法查询到悬挂边。</li>
<li>不支持没有索引时同时遍历指定的 Tag 和 Edge Type，例如执行<code>MATCH (v:player)-[e:follow]-&gt;() RETURN e LIMIT N</code>会报错。</li>
<li>从 3.0.0 版本开始，为了区别不同 Tag 的属性，返回属性时必须额外指定 Tag 名称。即从<code>RETURN &lt;变量名&gt;.&lt;属性名&gt;</code>改为<code>RETURN &lt;变量名&gt;.&lt;Tag名&gt;.&lt;属性名&gt;</code>。</li>
</ul>
</blockquote>
<h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><h3 id="3-3-2-OPTIONAL-MATCH"><a href="#3-3-2-OPTIONAL-MATCH" class="headerlink" title="3.3.2 OPTIONAL MATCH"></a>3.3.2 OPTIONAL MATCH</h3><p><code>OPTIONAL MATCH</code>通常与<code>MATCH</code>语句一起使用，作为<code>MATCH</code>语句的可选项去匹配命中的模式，如果没有命中对应的模式，对应的列返回<code>NULL</code>。</p>
<h3 id="3-3-3-LOOKUP"><a href="#3-3-3-LOOKUP" class="headerlink" title="3.3.3 LOOKUP"></a>3.3.3 LOOKUP</h3><p><code>LOOKUP</code>根据索引遍历数据，可以使用<code>LOOKUP</code>实现如下功能：</p>
<ul>
<li><p>根据<code>WHERE</code>子句搜索特定数据。</p>
</li>
<li><p>通过 Tag 列出点：检索指定 Tag 的所有点 ID。</p>
</li>
<li><p>通过 Edge type 列出边：检索指定 Edge type 的所有边的起始点、目的点和 rank。</p>
</li>
<li><p>统计包含指定 Tag 的点或属于指定 Edge type 的边的数量。</p>
</li>
</ul>
<h4 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h4><p>确保<code>LOOKUP</code>语句有至少一个索引可用。</p>
<p>如果已经存在相关的点、边或属性，必须在新创建索引后重建索引，才能使其生效。</p>
<h4 id="语法-1"><a href="#语法-1" class="headerlink" title="语法"></a>语法</h4><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs dts">LOOKUP <span class="hljs-class">ON </span>&#123;<span class="hljs-params">&lt;vertex_tag&gt;</span> | <span class="hljs-params">&lt;edge_type&gt;</span>&#125;<br>[WHERE <span class="hljs-params">&lt;expression&gt;</span> [AND <span class="hljs-params">&lt;expression&gt;</span> ...]]<br>YIELD <span class="hljs-params">&lt;return_list&gt;</span> [AS <span class="hljs-params">&lt;alias&gt;</span>]<br>[<span class="hljs-params">&lt;clause&gt;</span>];<br><br><span class="hljs-params">&lt;return_list&gt;</span><br>    <span class="hljs-params">&lt;prop_name&gt;</span> [AS <span class="hljs-params">&lt;col_alias&gt;</span>] [, <span class="hljs-params">&lt;prop_name&gt;</span> [AS <span class="hljs-params">&lt;prop_alias&gt;</span>] ...];<br></code></pre></td></tr></table></figure>

<ul>
<li><p><code>WHERE &lt;expression&gt;</code>：指定遍历的过滤条件，还可以结合布尔运算符 AND 和 OR 一起使用。详情请参见 </p>
</li>
<li><p><code>YIELD</code>：定义需要返回的输出。详情请参见 [<code>YIELD</code>]。</p>
</li>
<li><p><code>AS</code>：设置别名。</p>
</li>
<li><p><code>clause</code>：支持<code>ORDER BY</code>、<code>LIMIT</code>子句。</p>
</li>
</ul>
<h4 id="WHERE-语句限制"><a href="#WHERE-语句限制" class="headerlink" title="WHERE 语句限制"></a>WHERE 语句限制</h4><p>在<code>LOOKUP</code>语句中使用<code>WHERE</code>子句，不支持如下操作：</p>
<ul>
<li><code>$-</code>和<code>$^</code>。</li>
<li>在关系表达式中，不支持运算符两边都有字段名，例如<code>tagName.prop1 &gt; tagName.prop2</code>。</li>
<li>不支持运算表达式和函数表达式中嵌套 AliasProp 表达式。</li>
<li>不支持 XOR 运算符。</li>
<li>不支持除<code>STARTS WITH</code>之外的字符串操作。</li>
<li>不支持过滤 <code>rank()</code>。</li>
<li>不支持图模式.</li>
</ul>
<h4 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h4><h5 id="检索点"><a href="#检索点" class="headerlink" title="检索点"></a>检索点</h5><p>返回 Tag 为<code>player</code>且<code>name</code>为<code>Tony Parker</code>的点。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">nebula&gt; CREATE TAG INDEX IF NOT EXISTS index_player ON player(name(30), age);<br><br><span class="hljs-section">nebula&gt; REBUILD TAG INDEX index_player;</span><br><span class="hljs-section">+------------+</span><br><span class="hljs-section">| New Job Id |</span><br><span class="hljs-section">+------------+</span><br><span class="hljs-section">| 15         |</span><br><span class="hljs-section">+------------+</span><br><br>nebula&gt; LOOKUP ON player \<br><span class="hljs-code">        WHERE player.name == &quot;Tony Parker&quot; \</span><br><span class="hljs-section">        YIELD id(vertex);</span><br><span class="hljs-section">+---------------+</span><br><span class="hljs-section">| id(VERTEX)    |</span><br><span class="hljs-section">+---------------+</span><br><span class="hljs-section">| &quot;player101&quot;   |</span><br><span class="hljs-section">+---------------+</span><br><br>nebula&gt; LOOKUP ON player \<br><span class="hljs-code">        WHERE player.name == &quot;Tony Parker&quot; \</span><br><span class="hljs-section">        YIELD properties(vertex).name AS name, properties(vertex).age AS age;</span><br><span class="hljs-section">+---------------+-----+</span><br><span class="hljs-section">| name          | age |</span><br><span class="hljs-section">+---------------+-----+</span><br><span class="hljs-section">| &quot;Tony Parker&quot; | 36  |</span><br><span class="hljs-section">+---------------+-----+</span><br><br>nebula&gt; LOOKUP ON player \<br><span class="hljs-code">        WHERE player.age  &gt; 45 \</span><br><span class="hljs-section">        YIELD id(vertex);</span><br><span class="hljs-section">+-------------+</span><br><span class="hljs-section">| id(VERTEX)  |</span><br><span class="hljs-section">+-------------+</span><br>| &quot;player144&quot; |<br><span class="hljs-section">| &quot;player140&quot; |</span><br><span class="hljs-section">+-------------+</span><br><br>nebula&gt; LOOKUP ON player \<br><span class="hljs-code">        WHERE player.name STARTS WITH &quot;B&quot; \</span><br><span class="hljs-code">        AND player.age IN [22,30] \</span><br><span class="hljs-section">        YIELD properties(vertex).name, properties(vertex).age;</span><br><span class="hljs-section">+-------------------------+------------------------+</span><br><span class="hljs-section">| properties(VERTEX).name | properties(VERTEX).age |</span><br><span class="hljs-section">+-------------------------+------------------------+</span><br>| &quot;Ben Simmons&quot;           | 22                     |<br><span class="hljs-section">| &quot;Blake Griffin&quot;         | 30                     |</span><br><span class="hljs-section">+-------------------------+------------------------+</span><br><br>nebula&gt; LOOKUP ON player \<br><span class="hljs-code">        WHERE player.name == &quot;Kobe Bryant&quot;\</span><br><span class="hljs-code">        YIELD id(vertex) AS VertexID, properties(vertex).name AS name |\</span><br><span class="hljs-code">        GO FROM $-.VertexID OVER serve \</span><br><span class="hljs-section">        YIELD $-.name, properties(edge).start_year, properties(edge).end_year, properties($$).name;</span><br><span class="hljs-section">+---------------+-----------------------------+---------------------------+---------------------+</span><br><span class="hljs-section">| $-.name       | properties(EDGE).start_year | properties(EDGE).end_year | properties($$).name |</span><br><span class="hljs-section">+---------------+-----------------------------+---------------------------+---------------------+</span><br><span class="hljs-section">| &quot;Kobe Bryant&quot; | 1996                        | 2016                      | &quot;Lakers&quot;            |</span><br><span class="hljs-section">+---------------+-----------------------------+---------------------------+---------------------+</span><br></code></pre></td></tr></table></figure>



<h5 id="检索边"><a href="#检索边" class="headerlink" title="检索边"></a>检索边</h5><p>返回 Edge type 为<code>follow</code>且<code>degree</code>为<code>90</code>的边。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">nebula&gt; CREATE EDGE INDEX IF NOT EXISTS index_follow ON follow(degree);<br><br><span class="hljs-section">nebula&gt; REBUILD EDGE INDEX index_follow;</span><br><span class="hljs-section">+------------+</span><br><span class="hljs-section">| New Job Id |</span><br><span class="hljs-section">+------------+</span><br><span class="hljs-section">| 62         |</span><br><span class="hljs-section">+------------+</span><br><br>nebula&gt; LOOKUP ON follow \<br><span class="hljs-section">        WHERE follow.degree == 90 YIELD edge AS e;</span><br><span class="hljs-section">+----------------------------------------------------+</span><br><span class="hljs-section">| e                                                  |</span><br><span class="hljs-section">+----------------------------------------------------+</span><br>| [:follow &quot;player109&quot;-&gt;&quot;player125&quot; @0 &#123;degree: 90&#125;] |<br>| [:follow &quot;player118&quot;-&gt;&quot;player120&quot; @0 &#123;degree: 90&#125;] |<br>| [:follow &quot;player118&quot;-&gt;&quot;player131&quot; @0 &#123;degree: 90&#125;] |<br><span class="hljs-bullet">...</span><br><span class="hljs-bullet"></span><br><span class="hljs-bullet"></span>nebula&gt; LOOKUP ON follow \<br><span class="hljs-code">        WHERE follow.degree == 90 \</span><br><span class="hljs-section">        YIELD properties(edge).degree;</span><br><span class="hljs-section">+-------------------------+</span><br><span class="hljs-section">| properties(EDGE).degree |</span><br><span class="hljs-section">+-------------------------+</span><br>| 90                      |<br>| 90                      |<br><span class="hljs-bullet">...</span><br><span class="hljs-bullet"></span><br><span class="hljs-bullet"></span>nebula&gt; LOOKUP ON follow \<br><span class="hljs-code">        YIELD properties(edge).degree as degree \</span><br><span class="hljs-code">        | ORDER BY $-.degree \</span><br><span class="hljs-section">        | LIMIT 10;</span><br><span class="hljs-section">+--------+</span><br><span class="hljs-section">| degree |</span><br><span class="hljs-section">+--------+</span><br>| -1     |<br>| -1     |<br>| 9      |<br>| 10     |<br>| 13     |<br>| 50     |<br>| 55     |<br>| 60     |<br>| 70     |<br><span class="hljs-section">| 70     |</span><br><span class="hljs-section">+--------+</span><br><br>nebula&gt; LOOKUP ON follow \<br><span class="hljs-code">        WHERE follow.degree == 60 \</span><br><span class="hljs-code">        YIELD dst(edge) AS DstVID, properties(edge).degree AS Degree |\</span><br><span class="hljs-code">        GO FROM $-.DstVID OVER serve \</span><br><span class="hljs-section">        YIELD $-.DstVID, properties(edge).start_year, properties(edge).end_year, properties($$).name;</span><br><span class="hljs-section">+-------------+-----------------------------+---------------------------+---------------------+</span><br><span class="hljs-section">| $-.DstVID   | properties(EDGE).start_year | properties(EDGE).end_year | properties($$).name |</span><br><span class="hljs-section">+-------------+-----------------------------+---------------------------+---------------------+</span><br>| &quot;player105&quot; | 2010                        | 2018                      | &quot;Spurs&quot;             |<br>| &quot;player105&quot; | 2009                        | 2010                      | &quot;Cavaliers&quot;         |<br><span class="hljs-section">| &quot;player105&quot; | 2018                        | 2019                      | &quot;Raptors&quot;           |</span><br><span class="hljs-section">+-------------+-----------------------------+---------------------------+---------------------+</span><br></code></pre></td></tr></table></figure>



<h5 id="通过-Tag-列出所有的对应的点-通过-Edge-type-列出边"><a href="#通过-Tag-列出所有的对应的点-通过-Edge-type-列出边" class="headerlink" title="通过 Tag 列出所有的对应的点/通过 Edge type 列出边"></a>通过 Tag 列出所有的对应的点/通过 Edge type 列出边</h5><p>如果需要通过 Tag 列出所有的点，或通过 Edge type 列出边，则 Tag、Edge type 或属性上必须有至少一个索引。</p>
<p>例如一个 Tag <code>player</code>有属性<code>name</code>和<code>age</code>，为了遍历所有包含 Tag <code>player</code>的点 ID，Tag <code>player</code>、属性<code>name</code>或属性<code>age</code>中必须有一个已经创建索引。</p>
<ul>
<li><p>查找所有 Tag 为player的点 VID。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">nebula&gt; CREATE TAG IF NOT EXISTS player(name string,age int);<br><br>nebula&gt; CREATE TAG INDEX IF NOT EXISTS player_index on player();<br><br><span class="hljs-section">nebula&gt; REBUILD TAG INDEX player_index;</span><br><span class="hljs-section">+------------+</span><br><span class="hljs-section">| New Job Id |</span><br><span class="hljs-section">+------------+</span><br><span class="hljs-section">| 66         |</span><br><span class="hljs-section">+------------+</span><br><br>nebula&gt; INSERT VERTEX player(name,age) \<br><span class="hljs-code">        VALUES &quot;player100&quot;:(&quot;Tim Duncan&quot;, 42), &quot;player101&quot;:(&quot;Tony Parker&quot;, 36);</span><br><br># 列出所有的 player。类似于 MATCH (n:player) RETURN id(n) /*, n */。<br><br><span class="hljs-section">nebula&gt; LOOKUP ON player YIELD id(vertex);</span><br><span class="hljs-section">+-------------+</span><br><span class="hljs-section">| id(VERTEX)  |</span><br><span class="hljs-section">+-------------+</span><br>| &quot;player100&quot; |<br>| &quot;player101&quot; |<br><span class="hljs-bullet">...</span><br><span class="hljs-bullet"></span><br><span class="hljs-bullet"></span># 从结果中返回最前面的 4 行数据。<br><span class="hljs-section">nebula&gt; LOOKUP ON player YIELD id(vertex) | LIMIT 4;</span><br><span class="hljs-section">+-------------+</span><br><span class="hljs-section">| id(VERTEX)  |</span><br><span class="hljs-section">+-------------+</span><br>| &quot;player105&quot; |<br>| &quot;player109&quot; |<br>| &quot;player111&quot; |<br><span class="hljs-section">| &quot;player118&quot; |</span><br><span class="hljs-section">+-------------+</span><br></code></pre></td></tr></table></figure></li>
<li><p>查找 Edge type 为follow的所有边的信息。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">nebula&gt; CREATE EDGE IF NOT EXISTS follow(degree int);<br><br>nebula&gt; CREATE EDGE INDEX IF NOT EXISTS follow_index on follow();<br><br><span class="hljs-section">nebula&gt; REBUILD EDGE INDEX follow_index;</span><br><span class="hljs-section">+------------+</span><br><span class="hljs-section">| New Job Id |</span><br><span class="hljs-section">+------------+</span><br><span class="hljs-section">| 88         |</span><br><span class="hljs-section">+------------+</span><br><br>nebula&gt; INSERT EDGE follow(degree) \<br><span class="hljs-code">        VALUES &quot;player100&quot;-&gt;&quot;player101&quot;:(95);</span><br><br># 列出所有的 follow 边。类似于 MATCH (s)-[e:follow]-&gt;(d) RETURN id(s), rank(e), id(d) /*, type(e) */。<br><br><span class="hljs-section">nebula)&gt; LOOKUP ON follow YIELD edge AS e;</span><br><span class="hljs-section">+-----------------------------------------------------+</span><br><span class="hljs-section">| e                                                   |</span><br><span class="hljs-section">+-----------------------------------------------------+</span><br>| [:follow &quot;player105&quot;-&gt;&quot;player100&quot; @0 &#123;degree: 70&#125;]  |<br>| [:follow &quot;player105&quot;-&gt;&quot;player116&quot; @0 &#123;degree: 80&#125;]  |<br>| [:follow &quot;player109&quot;-&gt;&quot;player100&quot; @0 &#123;degree: 80&#125;]  |<br>...<br></code></pre></td></tr></table></figure></li>
</ul>
<h5 id="统计点或边"><a href="#统计点或边" class="headerlink" title="统计点或边"></a>统计点或边</h5><p>统计 Tag 为<code>player</code>的点和 Edge type 为<code>follow</code>的边。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">nebula&gt; LOOKUP ON player YIELD id(vertex)|\<br><span class="hljs-section">        YIELD COUNT(*) AS Player_Number;</span><br><span class="hljs-section">+---------------+</span><br><span class="hljs-section">| Player_Number |</span><br><span class="hljs-section">+---------------+</span><br><span class="hljs-section">| 51            |</span><br><span class="hljs-section">+---------------+</span><br><br>nebula&gt; LOOKUP ON follow YIELD edge AS e| \<br><span class="hljs-section">        YIELD COUNT(*) AS Follow_Number;</span><br><span class="hljs-section">+---------------+</span><br><span class="hljs-section">| Follow_Number |</span><br><span class="hljs-section">+---------------+</span><br><span class="hljs-section">| 81            |</span><br><span class="hljs-section">+---------------+</span><br></code></pre></td></tr></table></figure>



<h3 id="3-3-4-GO"><a href="#3-3-4-GO" class="headerlink" title="3.3.4 GO"></a>3.3.4 GO</h3><p><code>GO</code>从给定起始点开始遍历图。<code>GO</code>语句采用的路径类型是<code>walk</code>，即遍历时点和边都可以重复。</p>
<h4 id="语法-2"><a href="#语法-2" class="headerlink" title="语法"></a>语法</h4><figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bnf">GO [[<span class="hljs-attribute">&lt;M&gt;</span> TO] <span class="hljs-attribute">&lt;N&gt;</span> STEPS ] FROM <span class="hljs-attribute">&lt;vertex_list&gt;</span><br>OVER <span class="hljs-attribute">&lt;edge_type_list&gt;</span> [&#123;REVERSELY | BIDIRECT&#125;]<br>[ WHERE <span class="hljs-attribute">&lt;conditions&gt;</span> ]<br>YIELD [DISTINCT] <span class="hljs-attribute">&lt;return_list&gt;</span><br>[&#123; SAMPLE <span class="hljs-attribute">&lt;sample_list&gt;</span> | <span class="hljs-attribute">&lt;limit_by_list_clause&gt;</span> &#125;]<br>[| GROUP BY &#123;<span class="hljs-attribute">&lt;col_name&gt;</span> | expression&gt; | <span class="hljs-attribute">&lt;position&gt;</span>&#125; YIELD <span class="hljs-attribute">&lt;col_name&gt;</span>]<br>[| ORDER BY <span class="hljs-attribute">&lt;expression&gt;</span> [&#123;ASC | DESC&#125;]]<br>[| LIMIT [<span class="hljs-attribute">&lt;offset&gt;</span>,] <span class="hljs-attribute">&lt;number_rows&gt;</span>];<br><br><span class="hljs-attribute">&lt;vertex_list&gt;</span> ::=<br>    <span class="hljs-attribute">&lt;vid&gt;</span> [, <span class="hljs-attribute">&lt;vid&gt;</span> ...]<br><br><span class="hljs-attribute">&lt;edge_type_list&gt;</span> ::=<br>   <span class="hljs-attribute">&lt;edge_type&gt;</span> [, <span class="hljs-attribute">&lt;edge_type&gt;</span> ...]<br>   | *<br><br><span class="hljs-attribute">&lt;return_list&gt;</span> ::=<br>    <span class="hljs-attribute">&lt;col_name&gt;</span> [AS <span class="hljs-attribute">&lt;col_alias&gt;</span>] [, <span class="hljs-attribute">&lt;col_name&gt;</span> [AS <span class="hljs-attribute">&lt;col_alias&gt;</span>] ...]<br></code></pre></td></tr></table></figure>



<ul>
<li><p><code>&lt;N&gt; STEPS</code>：指定跳数。如果没有指定跳数，默认值<code>N</code>为<code>1</code>。如果<code>N</code>为<code>0</code>，NebulaGraph 不会检索任何边。</p>
</li>
<li><p><code>M TO N STEPS</code>：遍历<code>M~N</code>跳的边。如果<code>M</code>为<code>0</code>，输出结果和<code>M</code>为<code>1</code>相同，即<code>GO 0 TO 2</code>和<code>GO 1 TO 2</code>是相同的。</p>
</li>
<li><p><code>&lt;vertex_list&gt;</code>：用逗号分隔的点 ID 列表，或特殊的引用符<code>$-.id</code>。</p>
</li>
<li><p><code>&lt;edge_type_list&gt;</code>：遍历的 Edge type 列表。</p>
</li>
<li><p><code>REVERSELY | BIDIRECT</code>：默认情况下检索的是<code>&lt;vertex_list&gt;</code>的出边（正向），<code>REVERSELY</code>表示反向，即检索入边；<code>BIDIRECT</code> 为双向，即检索正向和反向，通过返回 <code>&lt;edge_type&gt;._type</code> 字段判断方向，其正数为正向，负数为反向。</p>
</li>
<li><p><code>WHERE &lt;conditions&gt;</code>：指定遍历的过滤条件。用户可以在起始点、目的点和边使用<code>WHERE</code>子句，还可以结合<code>AND</code>、<code>OR</code>、<code>NOT</code>、<code>XOR</code>一起使用。</p>
</li>
<li><p><code>YIELD [DISTINCT] &lt;return_list&gt;</code>：定义需要返回的输出。<code>&lt;return_list&gt;</code>建议使用 Schema 相关函数，当前支持<code>src(edge)</code>、<code>dst(edge)</code>、<code>type(edge)</code>等，暂不支持嵌套函数。</p>
</li>
<li><p><code>SAMPLE &lt;sample_list&gt;</code>：用于在结果集中取样。</p>
</li>
<li><p><code>&lt;limit_by_list_clause&gt;</code>：用于在遍历过程中逐步限制输出数量。</p>
</li>
<li><p><code>GROUP BY</code>：根据指定属性的值将输出分组。分组后需要再次使用<code>YIELD</code>定义需要返回的输出。</p>
</li>
<li><p><code>ORDER BY</code>：指定输出结果的排序规则。</p>
</li>
<li><p><code>LIMIT [&lt;offset&gt;,] &lt;number_rows&gt;]</code>：限制输出结果的行数。</p>
</li>
</ul>
<h4 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h4><ul>
<li>遍历多个 Edge type 时，<code>WHERE</code>子句有一些限制。例如不支持<code>WHERE edge1.prop1 &gt; edge2.prop2</code>。</li>
<li>GO 语句执行时先遍历所有的点，然后再根据过滤器条件进行过滤。</li>
<li>没有指定排序规则时，输出结果的顺序不是固定的。</li>
</ul>
<h4 id="示例-2"><a href="#示例-2" class="headerlink" title="示例"></a>示例</h4><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"># 返回 player102 所属队伍。<br><span class="hljs-section">nebula&gt; GO FROM &quot;player102&quot; OVER serve YIELD dst(edge);</span><br><span class="hljs-section">+-----------+</span><br><span class="hljs-section">| dst(EDGE) |</span><br><span class="hljs-section">+-----------+</span><br>| &quot;team203&quot; |<br><span class="hljs-section">| &quot;team204&quot; |</span><br><span class="hljs-section">+-----------+</span><br><br># 返回距离 player102 两跳的朋友。<br><span class="hljs-section">nebula&gt; GO 2 STEPS FROM &quot;player102&quot; OVER follow YIELD dst(edge);</span><br><span class="hljs-section">+-------------+</span><br><span class="hljs-section">| dst(EDGE)   |</span><br><span class="hljs-section">+-------------+</span><br>| &quot;player101&quot; |<br>| &quot;player125&quot; |<br>| &quot;player100&quot; |<br>| &quot;player102&quot; |<br><span class="hljs-section">| &quot;player125&quot; |</span><br><span class="hljs-section">+-------------+</span><br><br># 添加过滤条件。<br>nebula&gt; GO FROM &quot;player100&quot;, &quot;player102&quot; OVER serve \<br><span class="hljs-code">        WHERE properties(edge).start_year &gt; 1995 \</span><br><span class="hljs-code">        YIELD DISTINCT properties($$).name AS team_name, properties(edge).start_year AS start_year, properties($^).name AS player_name;</span><br><br><span class="hljs-code">+-----------------+</span>------------<span class="hljs-code">+---------------------+</span><br><span class="hljs-section">| team_name       | start_year | player_name         |</span><br><span class="hljs-section">+-----------------+------------+---------------------+</span><br>| &quot;Spurs&quot;         | 1997       | &quot;Tim Duncan&quot;        |<br>| &quot;Trail Blazers&quot; | 2006       | &quot;LaMarcus Aldridge&quot; |<br><span class="hljs-section">| &quot;Spurs&quot;         | 2015       | &quot;LaMarcus Aldridge&quot; |</span><br><span class="hljs-section">+-----------------+------------+---------------------+</span><br><br># 遍历多个 Edge type。属性没有值时，会显示 UNKNOWN<span class="hljs-emphasis">_PROP。</span><br><span class="hljs-emphasis">nebula&gt; GO FROM &quot;player100&quot; OVER follow, serve \</span><br><span class="hljs-emphasis">        YIELD properties(edge).degree, properties(edge).start_year;</span><br><span class="hljs-emphasis">+-------------------------+-----------------------------+</span><br><span class="hljs-emphasis">| properties(EDGE).degree | properties(EDGE).start_year |</span><br><span class="hljs-emphasis">+-------------------------+-----------------------------+</span><br><span class="hljs-emphasis">| 95                      | UNKNOWN_PROP                |</span><br><span class="hljs-emphasis">| 95                      | UNKNOWN_PROP                |</span><br><span class="hljs-emphasis">| UNKNOWN_</span>PROP            | 1997                        |<br><span class="hljs-code">+-------------------------+</span>-----------------------------+<br><br># 返回 player100 入方向的邻居点。<br>nebula&gt; GO FROM &quot;player100&quot; OVER follow REVERSELY \<br><span class="hljs-section">        YIELD src(edge) AS destination;</span><br><span class="hljs-section">+-------------+</span><br><span class="hljs-section">| destination |</span><br><span class="hljs-section">+-------------+</span><br>| &quot;player101&quot; |<br>| &quot;player102&quot; |<br><span class="hljs-bullet">...</span><br><span class="hljs-bullet"></span><br><span class="hljs-bullet"></span># 该 MATCH 查询与上一个 GO 查询具有相同的语义。<br>nebula&gt; MATCH (v)&lt;-[e:follow]- (v2) WHERE id(v) == <span class="hljs-emphasis">&#x27;player100&#x27;</span> \<br><span class="hljs-section">        RETURN id(v2) AS destination;</span><br><span class="hljs-section">+-------------+</span><br><span class="hljs-section">| destination |</span><br><span class="hljs-section">+-------------+</span><br>| &quot;player101&quot; |<br>| &quot;player102&quot; |<br><span class="hljs-bullet">...</span><br><span class="hljs-bullet"></span><br><span class="hljs-bullet"></span># 查询 player100 的朋友和朋友所属队伍。<br>nebula&gt; GO FROM &quot;player100&quot; OVER follow REVERSELY \<br><span class="hljs-code">        YIELD src(edge) AS id | \</span><br><span class="hljs-code">        GO FROM $-.id OVER serve \</span><br><span class="hljs-code">        WHERE properties($^).age &gt; 20 \</span><br><span class="hljs-section">        YIELD properties($^).name AS FriendOf, properties($$).name AS Team;</span><br><span class="hljs-section">+---------------------+-----------------+</span><br><span class="hljs-section">| FriendOf            | Team            |</span><br><span class="hljs-section">+---------------------+-----------------+</span><br>| &quot;Boris Diaw&quot;        | &quot;Spurs&quot;         |<br>| &quot;Boris Diaw&quot;        | &quot;Jazz&quot;          |<br>| &quot;Boris Diaw&quot;        | &quot;Suns&quot;          |<br><span class="hljs-bullet">...</span><br><span class="hljs-bullet"></span><br><span class="hljs-bullet"></span># 该 MATCH 查询与上一个 GO 查询具有相同的语义。<br>nebula&gt; MATCH (v)&lt;-[e:follow]- (v2)-[e2:serve]-&gt;(v3)  \<br><span class="hljs-code">        WHERE id(v) == &#x27;player100&#x27; \</span><br><span class="hljs-section">        RETURN v2.player.name AS FriendOf, v3.team.name AS Team;</span><br><span class="hljs-section">+---------------------+-----------------+</span><br><span class="hljs-section">| FriendOf            | Team            |</span><br><span class="hljs-section">+---------------------+-----------------+</span><br>| &quot;Boris Diaw&quot;        | &quot;Spurs&quot;         |<br>| &quot;Boris Diaw&quot;        | &quot;Jazz&quot;          |<br>| &quot;Boris Diaw&quot;        | &quot;Suns&quot;          |<br><span class="hljs-bullet">...</span><br><span class="hljs-bullet"></span><br><span class="hljs-bullet"></span># 查询 player100 1~2 跳内的朋友。<br>nebula&gt; GO 1 TO 2 STEPS FROM &quot;player100&quot; OVER follow \<br><span class="hljs-section">        YIELD dst(edge) AS destination;</span><br><span class="hljs-section">+-------------+</span><br><span class="hljs-section">| destination |</span><br><span class="hljs-section">+-------------+</span><br>| &quot;player101&quot; |<br>| &quot;player125&quot; |<br><span class="hljs-bullet">...</span><br><span class="hljs-bullet"></span><br><span class="hljs-bullet"></span># 该 MATCH 查询与上一个 GO 查询具有相同的语义。<br>nebula&gt; MATCH (v) -[e:follow*1..2]-&gt;(v2) \<br><span class="hljs-code">        WHERE id(v) == &quot;player100&quot; \</span><br><span class="hljs-section">        RETURN id(v2) AS destination;</span><br><span class="hljs-section">+-------------+</span><br><span class="hljs-section">| destination |</span><br><span class="hljs-section">+-------------+</span><br>| &quot;player100&quot; |<br>| &quot;player102&quot; |<br><span class="hljs-bullet">...</span><br><span class="hljs-bullet"></span><br><span class="hljs-bullet"></span># 根据年龄分组。<br>nebula&gt; GO 2 STEPS FROM &quot;player100&quot; OVER follow \<br><span class="hljs-code">        YIELD src(edge) AS src, dst(edge) AS dst, properties($$).age AS age \</span><br><span class="hljs-code">        | GROUP BY $-.dst \</span><br><span class="hljs-section">        YIELD $-.dst AS dst, collect_set($-.src) AS src, collect($-.age) AS age;</span><br><span class="hljs-section">+-------------+----------------------------+----------+</span><br><span class="hljs-section">| dst         | src                        | age      |</span><br><span class="hljs-section">+-------------+----------------------------+----------+</span><br>| &quot;player125&quot; | [&quot;player101&quot;]              | [41]     |<br>| &quot;player100&quot; | [&quot;player125&quot;, &quot;player101&quot;] | [42, 42] |<br>| &quot;player102&quot; | [&quot;player101&quot;]              | [33]     |<br><span class="hljs-code">+-------------+</span>----------------------------<span class="hljs-code">+----------+</span><br><br># 分组并限制输出结果的行数。<br>nebula&gt; $a = GO FROM &quot;player100&quot; OVER follow YIELD src(edge) AS src, dst(edge) AS dst; \<br><span class="hljs-code">        GO 2 STEPS FROM $a.dst OVER follow \</span><br><span class="hljs-code">        YIELD $a.src AS src, $a.dst, src(edge), dst(edge) \</span><br><span class="hljs-section">        | ORDER BY $-.src | OFFSET 1 LIMIT 2;</span><br><span class="hljs-section">+-------------+-------------+-------------+-------------+</span><br><span class="hljs-section">| src         | $a.dst      | src(EDGE)   | dst(EDGE)   |</span><br><span class="hljs-section">+-------------+-------------+-------------+-------------+</span><br>| &quot;player100&quot; | &quot;player125&quot; | &quot;player100&quot; | &quot;player101&quot; |<br><span class="hljs-section">| &quot;player100&quot; | &quot;player101&quot; | &quot;player100&quot; | &quot;player125&quot; |</span><br><span class="hljs-section">+-------------+-------------+-------------+-------------+</span><br><br># 在多个边上通过 IS NOT EMPTY 进行判断。<br><span class="hljs-section">nebula&gt; GO FROM &quot;player100&quot; OVER follow WHERE properties($$).name IS NOT EMPTY YIELD dst(edge);</span><br><span class="hljs-section">+-------------+</span><br><span class="hljs-section">| dst(EDGE)   |</span><br><span class="hljs-section">+-------------+</span><br>| &quot;player125&quot; |<br><span class="hljs-section">| &quot;player101&quot; |</span><br><span class="hljs-section">+-------------+</span><br></code></pre></td></tr></table></figure>



<h3 id="3-3-5-FETCH"><a href="#3-3-5-FETCH" class="headerlink" title="3.3.5 FETCH"></a>3.3.5 FETCH</h3><p><code>FETCH</code>可以获取指定点或边的属性值。</p>
<h4 id="获取点的属性值"><a href="#获取点的属性值" class="headerlink" title="获取点的属性值"></a>获取点的属性值</h4><h5 id="语法-3"><a href="#语法-3" class="headerlink" title="语法"></a>语法</h5><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dts">FETCH PROP <span class="hljs-class">ON </span>&#123;<span class="hljs-params">&lt;tag_name&gt;</span>[, tag_name ...] | *&#125;<br><span class="hljs-params">&lt;vid&gt;</span> [, vid ...]<br>YIELD <span class="hljs-params">&lt;return_list&gt;</span> [AS <span class="hljs-params">&lt;alias&gt;</span>];<br></code></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>tag_name</code></td>
<td>Tag 名称。</td>
</tr>
<tr>
<td><code>*</code></td>
<td>表示当前图空间中的所有 Tag。</td>
</tr>
<tr>
<td><code>vid</code></td>
<td>点 ID。</td>
</tr>
<tr>
<td><code>YIELD</code></td>
<td>定义需要返回的输出。</td>
</tr>
<tr>
<td><code>AS</code></td>
<td>设置别名。</td>
</tr>
</tbody></table>
<h5 id="基于-Tag-获取点的属性值"><a href="#基于-Tag-获取点的属性值" class="headerlink" title="基于 Tag 获取点的属性值"></a>基于 Tag 获取点的属性值</h5><p>在<code>FETCH</code>语句中指定 Tag 获取对应点的属性值。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-section">nebula&gt; FETCH PROP ON player &quot;player100&quot; YIELD properties(vertex);</span><br><span class="hljs-section">+-------------------------------+</span><br><span class="hljs-section">| properties(VERTEX)            |</span><br><span class="hljs-section">+-------------------------------+</span><br><span class="hljs-section">| &#123;age: 42, name: &quot;Tim Duncan&quot;&#125; |</span><br><span class="hljs-section">+-------------------------------+</span><br></code></pre></td></tr></table></figure>

<h5 id="获取点的指定属性值"><a href="#获取点的指定属性值" class="headerlink" title="获取点的指定属性值"></a>获取点的指定属性值</h5><p>使用<code>YIELD</code>子句指定返回的属性。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">nebula&gt; FETCH PROP ON player &quot;player100&quot; \<br><span class="hljs-section">        YIELD properties(vertex).name AS name;</span><br><span class="hljs-section">+--------------+</span><br><span class="hljs-section">| name         |</span><br><span class="hljs-section">+--------------+</span><br><span class="hljs-section">| &quot;Tim Duncan&quot; |</span><br><span class="hljs-section">+--------------+</span><br></code></pre></td></tr></table></figure>

<h5 id="获取多个点的属性值"><a href="#获取多个点的属性值" class="headerlink" title="获取多个点的属性值"></a>获取多个点的属性值</h5><p>指定多个点 ID 获取多个点的属性值，点之间用英文逗号（,）分隔。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-section">nebula&gt; FETCH PROP ON player &quot;player101&quot;, &quot;player102&quot;, &quot;player103&quot; YIELD properties(vertex);</span><br><span class="hljs-section">+--------------------------------------+</span><br><span class="hljs-section">| properties(VERTEX)                   |</span><br><span class="hljs-section">+--------------------------------------+</span><br>| &#123;age: 33, name: &quot;LaMarcus Aldridge&quot;&#125; |<br>| &#123;age: 36, name: &quot;Tony Parker&quot;&#125;       |<br><span class="hljs-section">| &#123;age: 32, name: &quot;Rudy Gay&quot;&#125;          |</span><br><span class="hljs-section">+--------------------------------------+</span><br></code></pre></td></tr></table></figure>

<h5 id="基于多个-Tag-获取点的属性值"><a href="#基于多个-Tag-获取点的属性值" class="headerlink" title="基于多个 Tag 获取点的属性值"></a>基于多个 Tag 获取点的属性值</h5><p>在<code>FETCH</code>语句中指定多个 Tag 获取属性值。Tag 之间用英文逗号（,）分隔。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"># 创建新 Tag t1。<br>nebula&gt; CREATE TAG IF NOT EXISTS t1(a string, b int);<br><br># 为点 player100 添加 Tag t1。<br>nebula&gt; INSERT VERTEX t1(a, b) VALUES &quot;player100&quot;:(&quot;Hello&quot;, 100);<br><br># 基于 Tag player 和 t1 获取点 player100 上的属性值。<br><span class="hljs-section">nebula&gt; FETCH PROP ON player, t1 &quot;player100&quot; YIELD vertex AS v;</span><br><span class="hljs-section">+----------------------------------------------------------------------------+</span><br><span class="hljs-section">| v                                                                          |</span><br><span class="hljs-section">+----------------------------------------------------------------------------+</span><br><span class="hljs-section">| (&quot;player100&quot; :player&#123;age: 42, name: &quot;Tim Duncan&quot;&#125; :t1&#123;a: &quot;Hello&quot;, b: 100&#125;) |</span><br><span class="hljs-section">+----------------------------------------------------------------------------+</span><br></code></pre></td></tr></table></figure>

<p>用户可以在<code>FETCH</code>语句中组合多个 Tag 和多个点。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-section">nebula&gt; FETCH PROP ON player, t1 &quot;player100&quot;, &quot;player103&quot; YIELD vertex AS v;</span><br><span class="hljs-section">+----------------------------------------------------------------------------+</span><br><span class="hljs-section">| v                                                                          |</span><br><span class="hljs-section">+----------------------------------------------------------------------------+</span><br>| (&quot;player100&quot; :player&#123;age: 42, name: &quot;Tim Duncan&quot;&#125; :t1&#123;a: &quot;Hello&quot;, b: 100&#125;) |<br><span class="hljs-section">| (&quot;player103&quot; :player&#123;age: 32, name: &quot;Rudy Gay&quot;&#125;)                           |</span><br><span class="hljs-section">+----------------------------------------------------------------------------+</span><br></code></pre></td></tr></table></figure>

<h5 id="在所有标签中获取点的属性值"><a href="#在所有标签中获取点的属性值" class="headerlink" title="在所有标签中获取点的属性值"></a>在所有标签中获取点的属性值</h5><p>在<code>FETCH</code>语句中使用<code>*</code>获取当前图空间所有标签里，点的属性值。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-section">nebula&gt; FETCH PROP ON * &quot;player100&quot;, &quot;player106&quot;, &quot;team200&quot; YIELD vertex AS v;</span><br><span class="hljs-section">+----------------------------------------------------------------------------+</span><br><span class="hljs-section">| v                                                                          |</span><br><span class="hljs-section">+----------------------------------------------------------------------------+</span><br>| (&quot;player100&quot; :player&#123;age: 42, name: &quot;Tim Duncan&quot;&#125; :t1&#123;a: &quot;Hello&quot;, b: 100&#125;) |<br>| (&quot;player106&quot; :player&#123;age: 25, name: &quot;Kyle Anderson&quot;&#125;)                      |<br><span class="hljs-section">| (&quot;team200&quot; :team&#123;name: &quot;Warriors&quot;&#125;)                                        |</span><br><span class="hljs-section">+----------------------------------------------------------------------------+</span><br></code></pre></td></tr></table></figure>



<h4 id="获取边的属性值"><a href="#获取边的属性值" class="headerlink" title="获取边的属性值"></a>获取边的属性值</h4><h5 id="语法-4"><a href="#语法-4" class="headerlink" title="语法"></a>语法</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xml">FETCH PROP ON <span class="hljs-tag">&lt;<span class="hljs-name">edge_type</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">src_vid</span>&gt;</span> -&gt; <span class="hljs-tag">&lt;<span class="hljs-name">dst_vid</span>&gt;</span>[@<span class="hljs-tag">&lt;<span class="hljs-name">rank</span>&gt;</span>] [, <span class="hljs-tag">&lt;<span class="hljs-name">src_vid</span>&gt;</span> -&gt; <span class="hljs-tag">&lt;<span class="hljs-name">dst_vid</span>&gt;</span> ...]<br>YIELD <span class="hljs-tag">&lt;<span class="hljs-name">output</span>&gt;</span>;<br></code></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>edge_type</code></td>
<td>Edge type 名称。</td>
</tr>
<tr>
<td><code>src_vid</code></td>
<td>起始点 ID，表示边的起点。</td>
</tr>
<tr>
<td><code>dst_vid</code></td>
<td>目的点 ID，表示边的终点。</td>
</tr>
<tr>
<td><code>rank</code></td>
<td>边的 rank。可选参数，默认值为<code>0</code>。起始点、目的点、Edge type 和 rank 可以唯一确定一条边。</td>
</tr>
<tr>
<td><code>YIELD</code></td>
<td>定义需要返回的输出。</td>
</tr>
</tbody></table>
<h5 id="获取边的所有属性值"><a href="#获取边的所有属性值" class="headerlink" title="获取边的所有属性值"></a>获取边的所有属性值</h5><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"># 获取连接 player100 和 team204 的边 serve 的所有属性值。<br><span class="hljs-section">nebula&gt; FETCH PROP ON serve &quot;player100&quot; -&gt; &quot;team204&quot; YIELD properties(edge);</span><br><span class="hljs-section">+------------------------------------+</span><br><span class="hljs-section">| properties(EDGE)                   |</span><br><span class="hljs-section">+------------------------------------+</span><br><span class="hljs-section">| &#123;end_year: 2016, start_year: 1997&#125; |</span><br><span class="hljs-section">+------------------------------------+</span><br></code></pre></td></tr></table></figure>

<h5 id="获取边的指定属性值"><a href="#获取边的指定属性值" class="headerlink" title="获取边的指定属性值"></a>获取边的指定属性值</h5><p>使用<code>YIELD</code>子句指定返回的属性。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">nebula&gt; FETCH PROP ON serve &quot;player100&quot; -&gt; &quot;team204&quot;    \<br><span class="hljs-section">        YIELD properties(edge).start_year;</span><br><span class="hljs-section">+-----------------------------+</span><br><span class="hljs-section">| properties(EDGE).start_year |</span><br><span class="hljs-section">+-----------------------------+</span><br><span class="hljs-section">| 1997                        |</span><br><span class="hljs-section">+-----------------------------+</span><br></code></pre></td></tr></table></figure>

<h5 id="获取多条边的属性值"><a href="#获取多条边的属性值" class="headerlink" title="获取多条边的属性值"></a>获取多条边的属性值</h5><p>指定多个边模式 (<code>&lt;src_vid&gt; -&gt; &lt;dst_vid&gt;[@&lt;rank&gt;]</code>) 获取多个边的属性值。模式之间用英文逗号（,）分隔。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-section">nebula&gt; FETCH PROP ON serve &quot;player100&quot; -&gt; &quot;team204&quot;, &quot;player133&quot; -&gt; &quot;team202&quot; YIELD edge AS e;</span><br><span class="hljs-section">+-----------------------------------------------------------------------+</span><br><span class="hljs-section">| e                                                                     |</span><br><span class="hljs-section">+-----------------------------------------------------------------------+</span><br>| [:serve &quot;player100&quot;-&gt;&quot;team204&quot; @0 &#123;end<span class="hljs-emphasis">_year: 2016, start_year: 1997&#125;] |</span><br><span class="hljs-emphasis">| [:serve &quot;player133&quot;-&gt;&quot;team202&quot; @0 &#123;end_year: 2011, start_</span>year: 2002&#125;] |<br><span class="hljs-code">+-----------------------------------------------------------------------+</span><br></code></pre></td></tr></table></figure>

<h5 id="基于-rank-获取属性值"><a href="#基于-rank-获取属性值" class="headerlink" title="基于 rank 获取属性值"></a>基于 rank 获取属性值</h5><p>如果有多条边，起始点、目的点和 Edge type 都相同，可以通过指定 rank 获取正确的边属性值。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"># 插入不同属性值、不同 rank 的边。<br>nebula&gt; insert edge serve(start_year,end_year) \<br><span class="hljs-code">        values &quot;player100&quot;-&gt;&quot;team204&quot;@1:(1998, 2017);</span><br><br>nebula&gt; insert edge serve(start_year,end_year) \<br><span class="hljs-code">        values &quot;player100&quot;-&gt;&quot;team204&quot;@2:(1990, 2018);</span><br><br># 默认返回 rank 为 0 的边。<br><span class="hljs-section">nebula&gt; FETCH PROP ON serve &quot;player100&quot; -&gt; &quot;team204&quot; YIELD edge AS e;</span><br><span class="hljs-section">+-----------------------------------------------------------------------+</span><br><span class="hljs-section">| e                                                                     |</span><br><span class="hljs-section">+-----------------------------------------------------------------------+</span><br>| [:serve &quot;player100&quot;-&gt;&quot;team204&quot; @0 &#123;end_year: 2016, start_year: 1997&#125;] |<br><span class="hljs-code">+-----------------------------------------------------------------------+</span><br><br># 要获取 rank 不为 0 的边，请在 FETCH 语句中设置 rank。<br><span class="hljs-section">nebula&gt; FETCH PROP ON serve &quot;player100&quot; -&gt; &quot;team204&quot;@1 YIELD edge AS e;</span><br><span class="hljs-section">+-----------------------------------------------------------------------+</span><br><span class="hljs-section">| e                                                                     |</span><br><span class="hljs-section">+-----------------------------------------------------------------------+</span><br>| [:serve &quot;player100&quot;-&gt;&quot;team204&quot; @1 &#123;end_year: 2017, start_year: 1998&#125;] |<br><span class="hljs-code">+-----------------------------------------------------------------------+</span><br></code></pre></td></tr></table></figure>



<h4 id="复合语句中使用-FETCH"><a href="#复合语句中使用-FETCH" class="headerlink" title="复合语句中使用 FETCH"></a>复合语句中使用 FETCH</h4><p>将<code>FETCH</code>与原生 nGQL 结合使用是一种常见的方式，例如和<code>GO</code>一起。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"># 返回从点 player101 开始的 follow 边的 degree 值。<br>nebula&gt; GO FROM &quot;player101&quot; OVER follow \<br><span class="hljs-code">        YIELD src(edge) AS s, dst(edge) AS d \</span><br><span class="hljs-code">        | FETCH PROP ON follow $-.s -&gt; $-.d \</span><br><span class="hljs-section">        YIELD properties(edge).degree;</span><br><span class="hljs-section">+-------------------------+</span><br><span class="hljs-section">| properties(EDGE).degree |</span><br><span class="hljs-section">+-------------------------+</span><br>| 95                      |<br>| 90                      |<br><span class="hljs-section">| 95                      |</span><br><span class="hljs-section">+-------------------------+</span><br></code></pre></td></tr></table></figure>

<p>用户也可以通过自定义变量构建类似的查询。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">nebula&gt; $var = GO FROM &quot;player101&quot; OVER follow \<br><span class="hljs-code">        YIELD src(edge) AS s, dst(edge) AS d; \</span><br><span class="hljs-code">        FETCH PROP ON follow $var.s -&gt; $var.d \</span><br><span class="hljs-section">        YIELD properties(edge).degree;</span><br><span class="hljs-section">+-------------------------+</span><br><span class="hljs-section">| properties(EDGE).degree |</span><br><span class="hljs-section">+-------------------------+</span><br>| 95                      |<br>| 90                      |<br><span class="hljs-section">| 95                      |</span><br><span class="hljs-section">+-------------------------+</span><br></code></pre></td></tr></table></figure>



<h3 id="3-3-6-SHOW"><a href="#3-3-6-SHOW" class="headerlink" title="3.3.6 SHOW"></a>3.3.6 SHOW</h3><h4 id="SHOW-CHARSET"><a href="#SHOW-CHARSET" class="headerlink" title="SHOW CHARSET"></a>SHOW CHARSET</h4><p><code>SHOW CHARSET</code>语句显示当前的字符集。</p>
<p>目前可用的字符集为<code>utf8</code>和<code>utf8mb4</code>。默认字符集为<code>utf8</code>。NebulaGraph 扩展<code>uft8</code>支持四字节字符，因此<code>utf8</code>和<code>utf8mb4</code>是等价的。</p>
<h5 id="语法-5"><a href="#语法-5" class="headerlink" title="语法"></a>语法</h5><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">SHOW CHARSET<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>

<h5 id="示例-3"><a href="#示例-3" class="headerlink" title="示例"></a>示例</h5><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-section">nebula&gt; SHOW CHARSET;</span><br><span class="hljs-section">+---------+-----------------+-------------------+--------+</span><br><span class="hljs-section">| Charset | Description     | Default collation | Maxlen |</span><br><span class="hljs-section">+---------+-----------------+-------------------+--------+</span><br><span class="hljs-section">| &quot;utf8&quot;  | &quot;UTF-8 Unicode&quot; | &quot;utf8_bin&quot;        | 4      |</span><br><span class="hljs-section">+---------+-----------------+-------------------+--------+</span><br></code></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>Charset</code></td>
<td>字符集名称。</td>
</tr>
<tr>
<td><code>Description</code></td>
<td>字符集说明。</td>
</tr>
<tr>
<td><code>Default collation</code></td>
<td>默认排序规则。</td>
</tr>
<tr>
<td><code>Maxlen</code></td>
<td>存储一个字符所需的最大字节数。</td>
</tr>
</tbody></table>
<h4 id="SHOW-COLLATION"><a href="#SHOW-COLLATION" class="headerlink" title="SHOW COLLATION"></a>SHOW COLLATION</h4><p><code>SHOW COLLATION</code>语句显示当前的排序规则。</p>
<p>目前可用的排序规则为<code>utf8_bin</code>和 <code>utf8mb4_bin</code>。</p>
<ul>
<li><p>当字符集为<code>utf8</code>，默认排序规则为<code>utf8_bin</code>。</p>
</li>
<li><p>当字符集为<code>utf8mb4</code>，默认排序规则为<code>utf8mb4_bin</code>。</p>
</li>
</ul>
<h5 id="语法-6"><a href="#语法-6" class="headerlink" title="语法"></a>语法</h5><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">COLLATION</span>;<br></code></pre></td></tr></table></figure>

<h5 id="示例-4"><a href="#示例-4" class="headerlink" title="示例"></a>示例</h5><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-section">nebula&gt; SHOW COLLATION;</span><br><span class="hljs-section">+------------+---------+</span><br><span class="hljs-section">| Collation  | Charset |</span><br><span class="hljs-section">+------------+---------+</span><br><span class="hljs-section">| &quot;utf8_bin&quot; | &quot;utf8&quot;  |</span><br><span class="hljs-section">+------------+---------+</span><br></code></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>Collation</code></td>
<td>排序规则名称。</td>
</tr>
<tr>
<td><code>Charset</code></td>
<td>与排序规则关联的字符集名称。</td>
</tr>
</tbody></table>
<h2 id="3-4-子句和选项"><a href="#3-4-子句和选项" class="headerlink" title="3.4 子句和选项"></a>3.4 子句和选项</h2><h2 id="3-5-图空间语句"><a href="#3-5-图空间语句" class="headerlink" title="3.5 图空间语句"></a>3.5 图空间语句</h2><h2 id="3-6-Tag语句"><a href="#3-6-Tag语句" class="headerlink" title="3.6 Tag语句"></a>3.6 Tag语句</h2><h2 id="3-7-Edge-Type语句"><a href="#3-7-Edge-Type语句" class="headerlink" title="3.7 Edge Type语句"></a>3.7 Edge Type语句</h2><h2 id="3-8-点语句"><a href="#3-8-点语句" class="headerlink" title="3.8 点语句"></a>3.8 点语句</h2><h2 id="3-9-边语句"><a href="#3-9-边语句" class="headerlink" title="3.9 边语句"></a>3.9 边语句</h2><h2 id="3-10-索引"><a href="#3-10-索引" class="headerlink" title="3.10 索引"></a>3.10 索引</h2><p>NebulaGraph 支持两种类型索引：原生索引和全文索引。</p>
<p><strong>和一般数据库意义上的索引概念不同，NebulaGraph 中的索引没有加速查询的功能，是用于定位到数据的必要前置条件</strong>。</p>
<ul>
<li>不支持对值为 NULL 的属性创建索引</li>
<li>不支持属性的唯一索引</li>
<li>索引配合<code>LOOKUP</code>和<code>MATCH</code>语句使用。</li>
</ul>
<blockquote>
<p>不要任意在生产环境中使用索引，除非很清楚使用索引对业务的影响。索引会导致写性能大幅下降。</p>
<p>索引并不用于查询加速。<strong>只用于：根据属性定位到点或边，或者统计点边数量。</strong></p>
<p>长索引会降低 Storage 服务的扫描性能，以及占用更多内存。建议将索引长度设置为和要被索引的最长字符串相同。索引长度最长为 256。</p>
</blockquote>
<h3 id="3-10-1-原生索引"><a href="#3-10-1-原生索引" class="headerlink" title="3.10.1 原生索引"></a>3.10.1 原生索引</h3><p>原生索引可以基于指定的属性查询数据，有如下特点：</p>
<ul>
<li><p>包括 Tag 索引和 Edge type 索引。</p>
</li>
<li><p>必须手动重建索引（<code>REBUILD INDEX</code>）。</p>
</li>
<li><p>支持创建同一个 Tag 或 Edge type 的多个属性的索引（复合索引），但是不能跨 Tag 或 Edge type。</p>
</li>
<li><p>支持对数字、日期和时间类型的属性进行范围查询，不支持其他属性类型的范围查询。</p>
</li>
<li><p><strong>底层实现为本地索引，即索引和数据保存在一个分片内</strong>，提高了二次查询速度和数据一致性，但是降低了写入数据速度。</p>
</li>
<li><p>索引匹配原则为从左匹配</p>
</li>
</ul>
<p><code>CREATE INDEX</code>语句用于对 Tag、EdgeType 或其属性创建原生索引。通常分别称为“Tag 索引”、“Edge type 索引”和“属性索引”。</p>
<ul>
<li><p>Tag 索引和 Edge type 索引应用于和 Tag、Edge type 自身相关的查询，例如用<code>LOOKUP</code>查找有 Tag <code>player</code>的所有点。</p>
</li>
<li><p>“属性索引”应用于基于属性的查询，例如基于属性<code>age</code>找到<code>age == 19</code>的所有的点。</p>
</li>
</ul>
<p>如果已经为 Tag <code>T</code>的属性<code>A</code>建立过属性索引<code>i_TA</code>，索引之间的可替代关系如下（Edge type 索引同理）：</p>
<ul>
<li><p>查询引擎可以使用<code>i_TA</code>来替代<code>i_T</code>。</p>
</li>
<li><p>在<code>MATCH</code>语句中<code>i_T</code>不能替代<code>i_TA</code>用于属性查找。</p>
</li>
<li><p>在<code>LOOKUP</code>语句中<code>i_T</code>可以替代<code>i_TA</code>用于属性查找。</p>
</li>
</ul>
<h4 id="使用步骤"><a href="#使用步骤" class="headerlink" title="使用步骤"></a>使用步骤</h4><p>如果必须使用索引，通常按照如下步骤：</p>
<ol>
<li>初次导入数据至 NebulaGraph。</li>
<li>创建索引。</li>
<li>重建索引。</li>
<li>使用LOOKUP或MATCH语句查询数据。不需要（也无法）指定使用哪个索引，NebulaGraph 会自动计算。</li>
</ol>
<h4 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a>创建索引</h4><h5 id="语法-7"><a href="#语法-7" class="headerlink" title="语法"></a>语法</h5><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs fsharp">CREATE &#123;TAG | EDGE&#125; INDEX [IF NOT EXISTS] &lt;index_name&gt; ON &#123;&lt;tag_name&gt; | &lt;edge_name&gt;&#125; (<span class="hljs-meta">[&lt;prop_name_list&gt;]</span>) [COMMENT &#x27;&lt;comment&gt;&#x27;];<br></code></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>`TAG</td>
<td>EDGE`</td>
</tr>
<tr>
<td><code>IF NOT EXISTS</code></td>
<td>检测待创建的索引是否存在，只有不存在时，才会创建索引。</td>
</tr>
<tr>
<td><code>&lt;index_name&gt;</code></td>
<td>索引名。索引名在一个图空间中必须是唯一的。推荐的命名方式为<code>i_tagName_propName</code>。索引名称以英文字母开头，支持 1~4 字节的 UTF-8 编码字符，包括英文字母（区分大小写）、数字、中文等，但是不包括除下划线外的特殊字符。使用特殊字符或保留关键字时，需要用反引号（`）包围，详情参见关键字和保留字。</td>
</tr>
<tr>
<td>`<tag_name></tag_name></td>
<td><edge_name>`</edge_name></td>
</tr>
<tr>
<td><code>&lt;prop_name_list&gt;</code></td>
<td>为<strong>变长</strong>字符串属性创建索引时，必须用<code>prop_name(length)</code>指定索引长度；为 Tag 或 Edge type 本身创建索引时，忽略<code>&lt;prop_name_list&gt;</code>。</td>
</tr>
<tr>
<td><code>COMMENT</code></td>
<td>索引的描述。最大为 256 字节。默认无描述。</td>
</tr>
</tbody></table>
<h5 id="创建-Tag-Edge-type-索引"><a href="#创建-Tag-Edge-type-索引" class="headerlink" title="创建 Tag/Edge type 索引"></a>创建 Tag/Edge type 索引</h5><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs n1ql">nebula&gt; <span class="hljs-keyword">CREATE</span> TAG <span class="hljs-keyword">INDEX</span> player_index <span class="hljs-keyword">on</span> player();<br>nebula&gt; <span class="hljs-keyword">CREATE</span> EDGE <span class="hljs-keyword">INDEX</span> follow_index <span class="hljs-keyword">on</span> follow();<br></code></pre></td></tr></table></figure>

<p>为 Tag 或 Edge type 创建索引后，用户可以使用 <code>LOOKUP</code> 语句查找<code>带有该 Tag 的</code>所有点的 VID，或者<code>所有该类型的边</code>的<code>对应起始点 VID、目的点 VID、以及 rank</code>。</p>
<h5 id="创建单属性索引"><a href="#创建单属性索引" class="headerlink" title="创建单属性索引"></a>创建单属性索引</h5><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">nebula&gt; <span class="hljs-keyword">CREATE</span> TAG <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> player_index_0 <span class="hljs-keyword">on</span> player(<span class="hljs-type">name</span>(<span class="hljs-number">10</span>));<br></code></pre></td></tr></table></figure>

<p>上述示例是为所有包含 Tag<code>player</code>的点创建属性<code>name</code>的索引，索引长度为 10。即只使用属性<code>name</code>的前 10 个字符来创建索引。</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs n1ql"># 变长字符串需要指定索引长度。<br>nebula&gt; <span class="hljs-keyword">CREATE</span> TAG <span class="hljs-keyword">IF</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> var_string(p1 <span class="hljs-keyword">string</span>);<br>nebula&gt; <span class="hljs-keyword">CREATE</span> TAG <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> var <span class="hljs-keyword">ON</span> var_string(p1(<span class="hljs-number">10</span>));<br><br># 定长字符串不需要指定索引长度。<br>nebula&gt; <span class="hljs-keyword">CREATE</span> TAG <span class="hljs-keyword">IF</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> fix_string(p1 FIXED_STRING(<span class="hljs-number">10</span>));<br>nebula&gt; <span class="hljs-keyword">CREATE</span> TAG <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> fix <span class="hljs-keyword">ON</span> fix_string(p1);<br>nebula&gt; <span class="hljs-keyword">CREATE</span> EDGE <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> follow_index_0 <span class="hljs-keyword">on</span> follow(degree);<br></code></pre></td></tr></table></figure>

<h5 id="创建复合属性索引"><a href="#创建复合属性索引" class="headerlink" title="创建复合属性索引"></a>创建复合属性索引</h5><p><code>复合属性索引</code>用于查找一个 Tag（或者 Edge type) 中的多个属性（的组合）。</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">nebula&gt; <span class="hljs-keyword">CREATE</span> TAG <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> player_index_1 <span class="hljs-keyword">on</span> player(<span class="hljs-type">name</span>(<span class="hljs-number">10</span>), age);<br></code></pre></td></tr></table></figure>

<blockquote>
<p>不支持跨 Tag 或 Edge type 创建复合索引，使用复合属性索引时，遵循”最左匹配原则”，必须从复合属性索引的最左侧开始匹配。</p>
</blockquote>
<h4 id="查询全部索引"><a href="#查询全部索引" class="headerlink" title="查询全部索引"></a>查询全部索引</h4><p><code>SHOW INDEXES</code>语句可以列出当前图空间内的所有 Tag 和 Edge type（包括属性）的索引。</p>
<h5 id="语法-8"><a href="#语法-8" class="headerlink" title="语法"></a>语法</h5><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">SHOW &#123;<span class="hljs-keyword">TAG</span> <span class="hljs-title">| EDGE</span>&#125; INDEXES;<br></code></pre></td></tr></table></figure>

<h5 id="示例-5"><a href="#示例-5" class="headerlink" title="示例"></a>示例</h5><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-section">nebula&gt; SHOW TAG INDEXES;</span><br><span class="hljs-section">+------------------+--------------+-----------------+</span><br><span class="hljs-section">| Index Name       | By Tag       | Columns         |</span><br><span class="hljs-section">+------------------+--------------+-----------------+</span><br>| &quot;fix&quot;            | &quot;fix<span class="hljs-emphasis">_string&quot; | [&quot;p1&quot;]          |</span><br><span class="hljs-emphasis">| &quot;player_index_0&quot; | &quot;player&quot;     | [&quot;name&quot;]        |</span><br><span class="hljs-emphasis">| &quot;player_index_1&quot; | &quot;player&quot;     | [&quot;name&quot;, &quot;age&quot;] |</span><br><span class="hljs-emphasis">| &quot;var&quot;            | &quot;var_</span>string&quot; | [&quot;p1&quot;]          |<br><span class="hljs-code">+------------------+</span>--------------<span class="hljs-code">+-----------------+</span><br><br><span class="hljs-section">nebula&gt; SHOW EDGE INDEXES;</span><br><span class="hljs-section">+----------------+----------+---------+</span><br><span class="hljs-section">| Index Name     | By Edge  | Columns |</span><br><span class="hljs-section">+----------------+----------+---------+</span><br>| &quot;follow_index&quot; | &quot;follow&quot; | []      |<br><span class="hljs-code">+----------------+</span>----------<span class="hljs-code">+---------+</span><br></code></pre></td></tr></table></figure>



<h4 id="查询索引创建信息"><a href="#查询索引创建信息" class="headerlink" title="查询索引创建信息"></a>查询索引创建信息</h4><p><code>SHOW CREATE INDEX</code>展示创建 Tag 或者 Edge type 时使用的 nGQL 语句，其中包含索引的详细信息，例如其关联的属性。</p>
<h5 id="语法-9"><a href="#语法-9" class="headerlink" title="语法"></a>语法</h5><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">SHOW CREATE &#123;<span class="hljs-keyword">TAG</span> <span class="hljs-title">| EDGE</span>&#125; INDEX <span class="hljs-tag">&lt;index_name&gt;</span>;<br></code></pre></td></tr></table></figure>

<h5 id="示例-6"><a href="#示例-6" class="headerlink" title="示例"></a>示例</h5><p>用户可以先运行<code>SHOW TAG INDEXES</code>查看有哪些 Tag 索引，然后用<code>SHOW CREATE TAG INDEX</code>查看指定索引的创建信息。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-section">nebula&gt; SHOW TAG INDEXES;</span><br><span class="hljs-section">+------------------+----------+----------+</span><br><span class="hljs-section">| Index Name       | By Tag   | Columns  |</span><br><span class="hljs-section">+------------------+----------+----------+</span><br>| &quot;player<span class="hljs-emphasis">_index_0&quot; | &quot;player&quot; | []       |</span><br><span class="hljs-emphasis">| &quot;player_index_</span>1&quot; | &quot;player&quot; | [&quot;name&quot;] |<br><span class="hljs-code">+------------------+</span>----------<span class="hljs-code">+----------+</span><br><br><span class="hljs-section">nebula&gt; SHOW CREATE TAG INDEX player_index_1;</span><br><span class="hljs-section">+------------------+--------------------------------------------------+</span><br><span class="hljs-section">| Tag Index Name   | Create Tag Index                                 |</span><br><span class="hljs-section">+------------------+--------------------------------------------------+</span><br>| &quot;player_index_1&quot; | &quot;CREATE TAG INDEX <span class="hljs-code">`player_index_1`</span> ON <span class="hljs-code">`player`</span> ( |<br>|                  |  <span class="hljs-code">`name`</span>(20)                                      |<br><span class="hljs-section">|                  | )&quot;                                               |</span><br><span class="hljs-section">+------------------+--------------------------------------------------+</span><br></code></pre></td></tr></table></figure>

<p>Edge type 索引可以用类似的方法查询：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-section">nebula&gt; SHOW EDGE INDEXES;</span><br><span class="hljs-section">+----------------+----------+---------+</span><br><span class="hljs-section">| Index Name     | By Edge  | Columns |</span><br><span class="hljs-section">+----------------+----------+---------+</span><br>| &quot;follow_index&quot; | &quot;follow&quot; | []      |<br><span class="hljs-code">+----------------+</span>----------<span class="hljs-code">+---------+</span><br><br><span class="hljs-section">nebula&gt; SHOW CREATE EDGE INDEX follow_index;</span><br><span class="hljs-section">+-----------------+-------------------------------------------------+</span><br><span class="hljs-section">| Edge Index Name | Create Edge Index                               |</span><br><span class="hljs-section">+-----------------+-------------------------------------------------+</span><br>| &quot;follow_index&quot;  | &quot;CREATE EDGE INDEX <span class="hljs-code">`follow_index`</span> ON <span class="hljs-code">`follow`</span> ( |<br><span class="hljs-section">|                 | )&quot;                                              |</span><br><span class="hljs-section">+-----------------+-------------------------------------------------+</span><br></code></pre></td></tr></table></figure>



<h4 id="查询索引信息"><a href="#查询索引信息" class="headerlink" title="查询索引信息"></a>查询索引信息</h4><p><code>DESCRIBE INDEX</code>语句可以查看指定索引的信息，包括索引的属性名称（Field）和数据类型（Type）。</p>
<h5 id="语法-10"><a href="#语法-10" class="headerlink" title="语法"></a>语法</h5><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">DESCRIBE &#123;<span class="hljs-keyword">TAG</span> <span class="hljs-title">| EDGE</span>&#125; INDEX <span class="hljs-tag">&lt;index_name&gt;</span>;<br></code></pre></td></tr></table></figure>

<h5 id="示例-7"><a href="#示例-7" class="headerlink" title="示例"></a>示例</h5><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-section">nebula&gt; DESCRIBE TAG INDEX player_index_0;</span><br><span class="hljs-section">+--------+--------------------+</span><br><span class="hljs-section">| Field  | Type               |</span><br><span class="hljs-section">+--------+--------------------+</span><br><span class="hljs-section">| &quot;name&quot; | &quot;fixed_string(30)&quot; |</span><br><span class="hljs-section">+--------+--------------------+</span><br><br><span class="hljs-section">nebula&gt; DESCRIBE TAG INDEX player_index_1;</span><br><span class="hljs-section">+--------+--------------------+</span><br><span class="hljs-section">| Field  | Type               |</span><br><span class="hljs-section">+--------+--------------------+</span><br>| &quot;name&quot; | &quot;fixed_string(10)&quot; |<br><span class="hljs-section">| &quot;age&quot;  | &quot;int64&quot;            |</span><br><span class="hljs-section">+--------+--------------------+</span><br></code></pre></td></tr></table></figure>



<h4 id="重建索引"><a href="#重建索引" class="headerlink" title="重建索引"></a>重建索引</h4><ul>
<li><strong>索引功能不会自动对其创建之前已存在的存量数据生效</strong>————在索引重建完成之前，无法基于该索引使用<code>LOOKUP</code>和<code>MATCH</code>语句查询到存量数据。</li>
<li>索引的重建未完成时，依赖索引的查询仅能使用部分索引，因此不能获得准确结果。</li>
</ul>
<h5 id="语法-11"><a href="#语法-11" class="headerlink" title="语法"></a>语法</h5><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs fsharp">REBUILD &#123;TAG | EDGE&#125; INDEX <span class="hljs-meta">[&lt;index_name_list&gt;]</span>;<br><br>&lt;index_name_list&gt;::=<br>    [index_name [, index_name] ...]<br></code></pre></td></tr></table></figure>

<ul>
<li><p>可以一次重建多个索引，索引名称之间用英文逗号（,）分隔。如果没有指定索引名称，将会重建所有索引。</p>
</li>
<li><p>重建完成后，用户可以使用命令<code>SHOW &#123;TAG | EDGE&#125; INDEX STATUS</code>检查索引是否重建完成。</p>
</li>
</ul>
<h5 id="示例-8"><a href="#示例-8" class="headerlink" title="示例"></a>示例</h5><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">nebula&gt; CREATE TAG IF NOT EXISTS person(name string, age int, gender string, email string);<br>nebula&gt; CREATE TAG INDEX IF NOT EXISTS single_person_index ON person(name(10));<br><br># 重建索引，返回任务 ID。<br><span class="hljs-section">nebula&gt; REBUILD TAG INDEX single_person_index;</span><br><span class="hljs-section">+------------+</span><br><span class="hljs-section">| New Job Id |</span><br><span class="hljs-section">+------------+</span><br><span class="hljs-section">| 31         |</span><br><span class="hljs-section">+------------+</span><br><br># 查看索引状态。<br><span class="hljs-section">nebula&gt; SHOW TAG INDEX STATUS;</span><br><span class="hljs-section">+-----------------------+--------------+</span><br><span class="hljs-section">| Name                  | Index Status |</span><br><span class="hljs-section">+-----------------------+--------------+</span><br><span class="hljs-section">| &quot;single_person_index&quot; | &quot;FINISHED&quot;   |</span><br><span class="hljs-section">+-----------------------+--------------+</span><br><br></code></pre></td></tr></table></figure>



<h4 id="查询索引作业状态"><a href="#查询索引作业状态" class="headerlink" title="查询索引作业状态"></a>查询索引作业状态</h4><p><code>SHOW INDEX STATUS</code>语句可以查看索引名称和对应作业的状态。</p>
<p>索引状态包括：</p>
<ul>
<li><code>QUEUE</code>：队列中</li>
<li><code>RUNNING</code>：执行中</li>
<li><code>FINISHED</code>：已完成</li>
<li><code>FAILED</code>：失败</li>
<li><code>STOPPED</code>：停止</li>
<li><code>INVALID</code>：失效</li>
</ul>
<h5 id="语法-12"><a href="#语法-12" class="headerlink" title="语法"></a>语法</h5><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">SHOW &#123;<span class="hljs-keyword">TAG</span> <span class="hljs-title">| EDGE</span>&#125; INDEX STATUS;<br></code></pre></td></tr></table></figure>

<h5 id="示例-9"><a href="#示例-9" class="headerlink" title="示例"></a>示例</h5><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-section">nebula&gt; SHOW TAG INDEX STATUS;</span><br><span class="hljs-section">+----------------------+--------------+</span><br><span class="hljs-section">| Name                 | Index Status |</span><br><span class="hljs-section">+----------------------+--------------+</span><br>| &quot;player<span class="hljs-emphasis">_index_0&quot;     | &quot;FINISHED&quot;   |</span><br><span class="hljs-emphasis">| &quot;player_index_</span>1&quot;     | &quot;FINISHED&quot;   |<br><span class="hljs-code">+----------------------+</span>--------------+<br></code></pre></td></tr></table></figure>





<h4 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h4><p><code>DROP INDEX</code>语句可以删除当前图空间中已存在的索引。</p>
<h5 id="前提条件-1"><a href="#前提条件-1" class="headerlink" title="前提条件"></a>前提条件</h5><p>执行<code>DROP INDEX</code>语句需要当前登录的用户拥有指定图空间的<code>DROP TAG INDEX</code>和<code>DROP EDGE INDEX</code>权限，否则会报错。</p>
<h5 id="语法-13"><a href="#语法-13" class="headerlink" title="语法"></a>语法</h5><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">DROP &#123;<span class="hljs-keyword">TAG</span> <span class="hljs-title">| EDGE</span>&#125; INDEX [IF EXISTS] <span class="hljs-tag">&lt;index_name&gt;</span>;<br></code></pre></td></tr></table></figure>

<p><code>IF NOT EXISTS</code>：检测待删除的索引是否存在，只有存在时，才会删除索引。</p>
<h5 id="示例-10"><a href="#示例-10" class="headerlink" title="示例"></a>示例</h5><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">nebula&gt; DROP <span class="hljs-keyword">TAG</span> <span class="hljs-title">INDEX</span> player_index_0;<br></code></pre></td></tr></table></figure>





<h3 id="3-10-2-全文索引"><a href="#3-10-2-全文索引" class="headerlink" title="3.10.2 全文索引"></a>3.10.2 全文索引</h3><p>全文索引是基于Elastic Search来实现的，用于对字符串属性进行前缀搜索、通配符搜索、正则表达式搜索和模糊搜索，有如下特点：</p>
<ul>
<li><p>只允许创建一个属性的索引。</p>
</li>
<li><p>只能创建指定长度（不超过 256 字节）字符串的索引。</p>
</li>
<li><p>不支持逻辑操作，例如<code>AND</code>、<code>OR</code>、<code>NOT</code>。</p>
</li>
</ul>
<blockquote>
<p>如果需要进行整个字符串的匹配，使用原生索引即可。</p>
</blockquote>
<h1 id="四、NebulaGraph-Dashboard集群监控"><a href="#四、NebulaGraph-Dashboard集群监控" class="headerlink" title="四、NebulaGraph Dashboard集群监控"></a>四、NebulaGraph Dashboard集群监控</h1><h2 id="4-1-概述"><a href="#4-1-概述" class="headerlink" title="4.1 概述"></a>4.1 概述</h2><ul>
<li><p>本节以社区版为例</p>
</li>
<li><p>NebulaGraph Dashboard是一款用于监控 NebulaGraph 集群中机器和服务状态的可视化工具。</p>
</li>
<li><p>产品功能：</p>
<ul>
<li>监控集群中所有机器的状态，包括 CPU、内存、负载、磁盘和流量。</li>
<li>监控集群中所有服务的信息，包括服务 IP 地址、版本和监控指标（例如查询数量、查询延迟、心跳延迟等）。</li>
<li>监控集群本身的信息，包括集群的服务信息、分区信息、配置和长时任务。</li>
<li>支持全局调整监控数据的页面更新频率。</li>
</ul>
</li>
<li><p>适用场景：</p>
<ul>
<li>需要方便快捷地监测关键指标，集中呈现业务的多个重点信息，保证业务正常运行。</li>
<li>需要多维度（例如时间段、聚合规则、指标）监控集群。</li>
<li>故障发生后，需要复盘问题，确认故障发生时间、异常现象。</li>
</ul>
</li>
</ul>
<blockquote>
<p>监控数据默认保留 14 天，即只能查询最近 14 天内任意时间段的监控数据。可以手动修改。</p>
</blockquote>
<h2 id="4-2-下载"><a href="#4-2-下载" class="headerlink" title="4.2 下载"></a>4.2 下载</h2><h3 id="4-2-1-前提条件"><a href="#4-2-1-前提条件" class="headerlink" title="4.2.1 前提条件"></a>4.2.1 前提条件</h3><ul>
<li><p>NebulaGraph 服务已经部署并启动。</p>
</li>
<li><p>以下端口未被使用：</p>
<ul>
<li><p>9200</p>
</li>
<li><p>9100</p>
</li>
<li><p>9090</p>
</li>
<li><p>8090</p>
</li>
<li><p>7003</p>
</li>
</ul>
</li>
<li><p>使用的 Linux 发行版为 CentOS ，安装有版本为 v10.12.0 以上的 Node.js，安装有版本为 1.13 及以上的 Go。</p>
</li>
</ul>
<h3 id="4-2-2-下载"><a href="#4-2-2-下载" class="headerlink" title="4.2.2 下载"></a>4.2.2 下载</h3><p>在每台机器上下载 TAR 包 <a target="_blank" rel="noopener" href="https://oss-cdn.nebula-graph.com.cn/nebula-graph-dashboard/3.2.0/nebula-dashboard-3.2.0.x86_64.tar.gz">nebula-dashboard-3.2.0.x86_64.tar.gz</a>。</p>
<ul>
<li>目录结构说明</li>
</ul>
<p>执行命令<code>tar -xvf nebula-dashboard-3.2.0.x86_64.tar.gz</code>解压缩，目录<code>nebula-dashboard/vendors</code>内一共有 4 个子目录，功能如下：</p>
<table>
<thead>
<tr>
<th>目录名称</th>
<th>说明</th>
<th>端口号</th>
</tr>
</thead>
<tbody><tr>
<td>node-exporter</td>
<td>收集集群中机器的资源信息，包括 CPU、内存、负载、磁盘和流量。</td>
<td>9100</td>
</tr>
<tr>
<td>nebula-stats-exporter</td>
<td>收集集群的性能指标，包括服务 IP 地址、版本和监控指标（例如查询数量、查询延迟、心跳延迟等）。</td>
<td>9200</td>
</tr>
<tr>
<td>prometheus</td>
<td>存储监控数据的时间序列数据库。</td>
<td>9090</td>
</tr>
<tr>
<td>nebula-http-gateway</td>
<td>为集群服务提供 HTTP 接口，执行 nGQL 语句与 NebulaGraph 数据库进行交互。</td>
<td>8090</td>
</tr>
</tbody></table>
<h2 id="4-3-逐一部署Dashboard依赖服务"><a href="#4-3-逐一部署Dashboard依赖服务" class="headerlink" title="4.3 逐一部署Dashboard依赖服务"></a>4.3 逐一部署Dashboard依赖服务</h2><h3 id="4-3-1-部署node-exporter服务"><a href="#4-3-1-部署node-exporter服务" class="headerlink" title="4.3.1 部署node-exporter服务"></a>4.3.1 部署node-exporter服务</h3><p>集群中的每个机器都需要部署<code>node-exporter</code>服务。</p>
<p>在目录<code>node-exporter</code>内执行如下命令启动服务：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">nohup ./node-exporter --web.listen-address=&quot;:9100&quot; &amp;<br></code></pre></td></tr></table></figure>

<p>服务启动后，可以在浏览器中输入<code>&lt;IP&gt;:9100</code>检查服务是否正常启动。</p>
<h3 id="4-3-2-部署nebula-stats-exporter服务"><a href="#4-3-2-部署nebula-stats-exporter服务" class="headerlink" title="4.3.2 部署nebula-stats-exporter服务"></a>4.3.2 部署nebula-stats-exporter服务</h3><p>需要在<code>nebula-dashboard</code>服务所在机器部署<code>nebula-stats-exporter</code>服务。</p>
<ol>
<li><p>在目录<code>nebula-stats-exporter</code>内修改文件<code>config.yaml</code>，配置所有服务的 HTTP 端口，示例如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">clusters:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nebula</span><br>    <span class="hljs-attr">instances:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">metad0</span><br>        <span class="hljs-attr">endpointIP:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.8</span><span class="hljs-number">.157</span><br>        <span class="hljs-attr">endpointPort:</span> <span class="hljs-number">19559</span><br>        <span class="hljs-attr">componentType:</span> <span class="hljs-string">metad</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">metad1</span><br>        <span class="hljs-attr">endpointIP:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.8</span><span class="hljs-number">.155</span><br>        <span class="hljs-attr">endpointPort:</span> <span class="hljs-number">19559</span><br>        <span class="hljs-attr">componentType:</span> <span class="hljs-string">metad</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">metad2</span><br>        <span class="hljs-attr">endpointIP:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.8</span><span class="hljs-number">.154</span><br>        <span class="hljs-attr">endpointPort:</span> <span class="hljs-number">19559</span><br>        <span class="hljs-attr">componentType:</span> <span class="hljs-string">metad</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">graphd0</span><br>        <span class="hljs-attr">endpointIP:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.8</span><span class="hljs-number">.157</span><br>        <span class="hljs-attr">endpointPort:</span> <span class="hljs-number">19669</span><br>        <span class="hljs-attr">componentType:</span> <span class="hljs-string">graphd</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">graphd1</span><br>        <span class="hljs-attr">endpointIP:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.8</span><span class="hljs-number">.155</span><br>        <span class="hljs-attr">endpointPort:</span> <span class="hljs-number">19669</span><br>        <span class="hljs-attr">componentType:</span> <span class="hljs-string">graphd</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">graphd2</span><br>        <span class="hljs-attr">endpointIP:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.8</span><span class="hljs-number">.154</span><br>        <span class="hljs-attr">endpointPort:</span> <span class="hljs-number">19669</span><br>        <span class="hljs-attr">componentType:</span> <span class="hljs-string">graphd</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">storaged0</span><br>        <span class="hljs-attr">endpointIP:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.8</span><span class="hljs-number">.157</span><br>        <span class="hljs-attr">endpointPort:</span> <span class="hljs-number">19779</span><br>        <span class="hljs-attr">componentType:</span> <span class="hljs-string">storaged</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">storaged1</span><br>        <span class="hljs-attr">endpointIP:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.8</span><span class="hljs-number">.155</span><br>        <span class="hljs-attr">endpointPort:</span> <span class="hljs-number">19779</span><br>        <span class="hljs-attr">componentType:</span> <span class="hljs-string">storaged</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">storaged2</span><br>        <span class="hljs-attr">endpointIP:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.8</span><span class="hljs-number">.154</span><br>        <span class="hljs-attr">endpointPort:</span> <span class="hljs-number">19779</span><br>        <span class="hljs-attr">componentType:</span> <span class="hljs-string">storaged</span><br></code></pre></td></tr></table></figure></li>
<li><p>执行如下命令启动服务：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">nohup  ./nebula-stats-exporter --listen-address=&quot;:9200&quot; --bare-metal --bare-metal-config=./config.yaml &amp;<br></code></pre></td></tr></table></figure></li>
</ol>
<p>服务启动后，可以在浏览器中输入<code>&lt;IP&gt;:9200</code>检查服务是否正常启动。</p>
<h3 id="4-3-3-部署prometheus服务"><a href="#4-3-3-部署prometheus服务" class="headerlink" title="4.3.3 部署prometheus服务"></a>4.3.3 部署prometheus服务</h3><p>需要在<code>nebula-dashboard</code>服务所在机器部署<code>prometheus</code>服务。</p>
<ol>
<li><p>在目录<code>prometheus</code>内修改文件<code>prometheus.yaml</code>，配置<code>node-exporter</code>服务和<code>nebula-stats-exporter</code>服务的 IP 地址和端口，示例如下：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs vim">globa<span class="hljs-variable">l:</span><br>  scrape_interva<span class="hljs-variable">l:</span>     <span class="hljs-number">5</span>s<br>  evaluation_interva<span class="hljs-variable">l:</span> <span class="hljs-number">5</span>s<br>scrape_config<span class="hljs-variable">s:</span><br>  - job_name: <span class="hljs-string">&#x27;nebula-stats-exporter&#x27;</span><br>    static_config<span class="hljs-variable">s:</span><br>      - target<span class="hljs-variable">s:</span> [<br>          <span class="hljs-string">&#x27;192.168.xx.100:9200&#x27;</span>  #  nebula-stats-exporter 服务的 IP 地址和端口。<br>        ]<br>  - job_name: <span class="hljs-string">&#x27;node-exporter&#x27;</span><br>    static_config<span class="hljs-variable">s:</span><br>      - target<span class="hljs-variable">s:</span> [<br>          <span class="hljs-string">&#x27;192.168.xx.100:9100&#x27;</span>,  #  node-exporter 服务的 IP 地址和端口。<br>          <span class="hljs-string">&#x27;192.168.xx.101:9100&#x27;</span><br>        ]<br></code></pre></td></tr></table></figure>

<ul>
<li><p>scrape_interval：收集监控数据的间隔时间。默认为 1 分钟。</p>
</li>
<li><p>evaluation_interval：告警规则扫描时间间隔。默认为 1 分钟。</p>
</li>
</ul>
</li>
<li><p>执行如下命令启动服务：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">nohup ./prometheus --config.file=./prometheus.yaml &amp;<br></code></pre></td></tr></table></figure></li>
</ol>
<p>服务启动后，可以在浏览器中输入<code>&lt;IP&gt;:9090</code>检查服务是否正常启动。</p>
<h3 id="4-3-4-部署nebula-http-gateway服务"><a href="#4-3-4-部署nebula-http-gateway服务" class="headerlink" title="4.3.4 部署nebula-http-gateway服务"></a>4.3.4 部署nebula-http-gateway服务</h3><p>需要在<code>nebula-dashboard</code>服务所在机器部署<code>nebula-http-gateway</code>服务。</p>
<p>在目录<code>nebula-http-gateway</code>内执行如下命令启动服务：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">nohup ./nebula-httpd &amp;<br></code></pre></td></tr></table></figure>

<p>服务启动后，可以在浏览器中输入<code>&lt;IP&gt;:8090</code>检查服务是否正常启动。</p>
<h3 id="4-3-5-部署dashboard服务"><a href="#4-3-5-部署dashboard服务" class="headerlink" title="4.3.5 部署dashboard服务"></a>4.3.5 部署dashboard服务</h3><ol>
<li><p>在目录<code>nebula-dashboard</code>内修改文件<code>config.json</code>，配置代理信息，示例如下：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">port:</span> <span class="hljs-number">7003</span><br><span class="hljs-symbol">proxy:</span><br><span class="hljs-symbol">  gateway:</span><br><span class="hljs-symbol">    target:</span> <span class="hljs-string">&quot;127.0.0.1:8090&quot;</span>  <span class="hljs-comment">//  nebula-http-gateway 服务的 IP 和端口号。</span><br><span class="hljs-symbol">  prometheus:</span><br><span class="hljs-symbol">    target:</span> <span class="hljs-string">&quot;127.0.0.1:9090&quot;</span>  <span class="hljs-comment">// Prometheus 服务的 IP 和端口号。</span><br><span class="hljs-symbol">  graph:</span><br><span class="hljs-symbol">    target:</span> <span class="hljs-string">&quot;127.0.0.1:19669&quot;</span>    <span class="hljs-comment">// 用于获取 Graph 服务的运行配置。</span><br><span class="hljs-symbol">  storage:</span><br><span class="hljs-symbol">    target:</span> <span class="hljs-string">&quot;127.0.0.1:19779&quot;</span>   <span class="hljs-comment">// 用于获取 Storage 服务的运行配置。      </span><br><span class="hljs-symbol">  nebulaServer:</span><br><span class="hljs-symbol">    ip:</span> <span class="hljs-string">&quot;192.168.8.143&quot;</span>  <span class="hljs-comment">// 任一 Graph 服务的机器 IP。</span><br><span class="hljs-symbol">    port:</span> <span class="hljs-number">9669</span> <span class="hljs-comment">// Graph 服务的端口号。</span><br>...<br></code></pre></td></tr></table></figure></li>
<li><p>在目录<code>nebula-dashboard</code>内执行如下命令启动服务：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">nohup ./dashboard &amp;<br></code></pre></td></tr></table></figure></li>
</ol>
<p>服务启动后，可以在浏览器中输入<code>&lt;IP&gt;:7003</code>检查服务是否正常启动。</p>
<img src="/2022/12/28/%E6%95%B0%E6%8D%AE%E5%BA%93/NebulaGraph/NebulaGraph%E5%85%A5%E9%97%A8/image-20230103203227551.png" srcset="/img/loading.gif" lazyload alt="image-20230103203227551" style="zoom:50%;">

<ul>
<li><p>如果 NebulaGraph 已经启用身份验证，用户可以使用已创建的账号连接 Dashboard。</p>
</li>
<li><p>如果 NebulaGraph 未启用身份验证，用户只能使用默认用户<code>root</code>和任意密码连接 Dashboard。</p>
</li>
</ul>
<h1 id="五、NebulaGraph-Studio可视化工具"><a href="#五、NebulaGraph-Studio可视化工具" class="headerlink" title="五、NebulaGraph Studio可视化工具"></a>五、NebulaGraph Studio可视化工具</h1><h2 id="5-1-概述"><a href="#5-1-概述" class="headerlink" title="5.1 概述"></a>5.1 概述</h2><ul>
<li><p>NebulaGraph Studio（简称 Studio）是一款可以通过 Web 访问的开源图数据库可视化工具，搭配NebulaGraph内核使用，提供构图、数据导入、编写 nGQL 查询等一站式服务。</p>
</li>
<li><p>产品功能：</p>
<ul>
<li>使用 <strong>Schema</strong> 管理功能，用户可以使用图形界面完成图空间、Tag（标签）、Edge Type（边类型）、索引的创建，查看图空间的统计数据，快速上手 NebulaGraph。</li>
<li>使用<strong>导入</strong>功能，通过简单的配置，用户即能批量导入点和边数据，并能实时查看数据导入日志。</li>
<li>使用<strong>控制台</strong>功能，用户可以使用 nGQL 语句创建 Schema，并对数据执行增删改查操作</li>
</ul>
</li>
<li><p>适用场景：</p>
<ul>
<li>已经安装部署了 NebulaGraph 数据库，想使用 GUI 工具创建 Schema、导入数据、执行 nGQL 语句查询。</li>
<li>不习惯用命令行工具，更希望使用 GUI 工具查看语句输出的结果。</li>
</ul>
</li>
</ul>
<h2 id="5-2-Docker部署"><a href="#5-2-Docker部署" class="headerlink" title="5.2 Docker部署"></a>5.2 Docker部署</h2><h3 id="5-2-1-前提条件"><a href="#5-2-1-前提条件" class="headerlink" title="5.2.1 前提条件"></a>5.2.1 前提条件</h3><p>在部署 Docker 版 Studio 之前，需要确认：</p>
<ul>
<li><p>NebulaGraph 服务已经部署并启动。</p>
</li>
<li><p>在即将运行 Docker 版 Studio 的机器上安装并启动 Docker Compose。</p>
</li>
<li><p>确保以下端口未被占用。</p>
<table>
<thead>
<tr>
<th align="left">端口号</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">7001</td>
<td align="left">Studio 提供的 web 服务</td>
</tr>
</tbody></table>
</li>
</ul>
<h3 id="5-2-2-部署"><a href="#5-2-2-部署" class="headerlink" title="5.2.2 部署"></a>5.2.2 部署</h3><p>在命令行工具中按以下步骤依次运行命令，部署并启动 Docker 版 Studio，以NebulaGraph版本为 3.3.0为例：</p>
<ol>
<li><p>下载 Studio 的部署配置文件。</p>
<table>
<thead>
<tr>
<th align="left">安装包</th>
<th align="left">适用 NebulaGraph 版本</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><a target="_blank" rel="noopener" href="https://oss-cdn.nebula-graph.com.cn/nebula-graph-studio/3.5.0/nebula-graph-studio-3.5.0.tar.gz">nebula-graph-studio-3.5.0.tar.gz</a></td>
<td align="left">3.3.0</td>
</tr>
</tbody></table>
</li>
<li><p>创建<code>nebula-graph-studio-3.5.0</code>目录，并将安装包解压至目录中。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir nebula-graph-studio-3.5.0 &amp;&amp; tar -zxvf nebula-graph-studio-3.5.0.tar.gz -C nebula-graph-studio-3.5.0<br></code></pre></td></tr></table></figure></li>
<li><p>解压后进入 <code>nebula-graph-studio-3.5.0</code> 目录。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd nebula-graph-studio-3.5.0<br></code></pre></td></tr></table></figure></li>
<li><p>拉取 Studio 的 Docker 镜像。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker-compose pull<br></code></pre></td></tr></table></figure></li>
<li><p>构建并启动 Studio 服务。其中，<code>-d</code> 表示在后台运行服务容器。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker-compose up -d<br></code></pre></td></tr></table></figure>

<p>当屏幕返回以下信息时，表示 Docker 版 Studio 已经成功启动。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">Creating docker_web_1      ... done<br></code></pre></td></tr></table></figure>

<p><img src="/2022/12/28/%E6%95%B0%E6%8D%AE%E5%BA%93/NebulaGraph/NebulaGraph%E5%85%A5%E9%97%A8/image-20230103205610713.png" srcset="/img/loading.gif" lazyload alt="image-20230103205610713"></p>
</li>
<li><p>启动成功后，在浏览器地址栏输入 <code>http://&lt;ip address&gt;:7001</code>。</p>
</li>
</ol>
<img src="/2022/12/28/%E6%95%B0%E6%8D%AE%E5%BA%93/NebulaGraph/NebulaGraph%E5%85%A5%E9%97%A8/image-20230103205637793.png" srcset="/img/loading.gif" lazyload alt="image-20230103205637793" style="zoom:50%;">

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>
                    
                      <a class="hover-with-bg" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/NebulaGraph/">NebulaGraph</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/NebulaGraph/">NebulaGraph</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/11/20/Python/Python%E8%AF%AD%E6%B3%95/Python%E5%9F%BA%E7%A1%80/">
                        <span class="hidden-mobile">Python基础</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
    
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>



  <script  src="/js/local-search.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>


  <script defer src="/js/leancloud.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>









  <script  src="https://cdn.jsdelivr.net/npm/mermaid@8.8.3/dist/mermaid.min.js" ></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({"theme":"default"});
    }
  </script>




  
    <!-- Baidu Analytics -->
    <script defer>
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?cd190160b5401a029cee361d013e32a1";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  

  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
